---
title: 分支缓存
description: 本主题提供 Windows Server 2016 中分支缓存的概述
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-bc
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: a4587cff-c086-49f1-a0bf-cd74b8a44440
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 5540d89827b80a21bf23f6a2aa8f54f09dfde67a
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2018
---
# <a name="branchcache"></a>分支缓存

>适用于：Windows Server（半年通道），Windows Server 2016

本主题中，适用于 IT) 专业人员，这提供分支缓存，包括分支缓存模式、 功能、 功能，以及在不同的操作系统中可用的分支缓存功能的相关概要信息。

> [!NOTE]
> 本主题中，除了以下分支缓存文档才可用。
> 
> - [分支缓存网络 Shell 和 Windows PowerShell 命令](../branchcache/BranchCache-Network-Shell-and-Windows-PowerShell-Commands.md)
> -   [分支缓存部署指南](../branchcache/deploy/BranchCache-Deployment-Guide.md)

**谁有兴趣分支缓存？**

如果你是由系统管理员，网络或存储解决方案设计师或其他 IT 专业人员，分支缓存您可能感兴趣以下情况下：

- 设计或对从分支机构到主 office 有两个或多个的物理位置和宽的区域 (WAN) 网络连接的组织的支持 IT 基础结构。

- 你设计或支持已部署云技术组织的 IT 基础结构和 WAN 连接由工作访问数据和远程位置的应用程序的人员。

- 你想要优化 WAN 带宽使用量减少的分公司和主 office 网络流量。

- 部署了或计划部署在你的主 office 内容匹配的配置本主题中所述的服务器。

- 在你的分支机构的客户端计算机正在运行 Windows 10、 Windows 8.1、 Windows 8 或 Windows 7。

本主题包含以下部分：

-   [分支缓存是什么？](#bkmk_what)

-   [分支缓存模式](#BKMK_2)
  
-   [分支缓存启用内容服务器](#BKMK_3)
  
-   [分支缓存和云](#BKMK_3a)
  
-   [内容的信息版本](#bkmk_version)  
  
-   [分支缓存如何处理内容的更新中的文件](#bkmk_handles)  
  
-   [分支缓存安装指南](#BKMK_4)  
  
-   [有关分支缓存的操作系统版本](#bkmk_os)  
  
-   [分支缓存安全](#bkmk_security)  
  
-   [内容的流量和进程](#bkmk_flow)  
  
-   [缓存的安全](#bkmk_cache)  
  
## <a name="bkmk_what"></a>分支缓存是什么？

分支缓存是一种宽的区域网络 (WAN) 带宽优化技术，包含在某些版本的 Windows Server 2016 和 Windows 10 操作系统，以及 Windows Server 2012 R2、 Windows 8.1、 Windows Server 2012、 Windows 8、 Windows Server 2008 R2 和 Windows 7 的某些版本中。 用户访问远程服务器上的内容时，优化 WAN 带宽，分支缓存从你的主 office 读取内容或托管云内容服务器和缓存内容的访问分支机构，使客户端计算机在本地而不是通过 WAN 访问该内容的分支机构。
  
在分支机构内容存储在到主机缓存中，或在分支机构，客户端计算机正在运行 Windows 10、 Windows 8.1、 Windows 8 或 Windows 7 上提供没有服务器时配置的服务器上。 客户端计算机请求，并从主 office 接收内容并在分支机构缓存内容后，本地的内容，而不是从内容服务器下载 WAN 的链接上的内容，可以获取相同的分支机构在其他计算机。

当客户端计算机进行同样的内容的后续请求时，的客户端下载*内容信息*从服务器而的实际内容。 使用原始内容区块计算，它们是极小相比于原始的数据内容哈希包含内容的信息。 客户端计算机然后用于内容的信息查找缓存中的内容在分支机构，无论是位于客户端计算机上，也可以在服务器上的缓存。 客户端和服务器还使用内容的信息安全缓存的内容，以便未经授权的用户都无法访问它。

分支缓存增加最终用户的工作效率客户端和服务器分支机构中的改进内容查询响应时间和也有助于提高减少流量 wan 通过网络性能。

## <a name="BKMK_2"></a>分支缓存模式
分支缓存有两种模式的操作： 分发缓存模式和托管的缓存模式。

分布式的缓存型部署分支缓存时，内容在分公司缓存分布客户端计算机。

分支缓存托管的缓存型部署时，某个上托管内容缓存分支机构或称为的更多服务器计算机托管缓存的服务器。

> [!NOTE]
> 你可以将部署分支缓存使用两种模式，但只有一个模式可用于根据分支机构。 例如，如果你有两个分支机构一个它的服务器，这不是，请的另一个你可以将分支缓存部署包括只能客户端计算机 office 型分布式的缓存部署分支缓存时包含服务器，在办公室型托管的缓存。

在下图中，在这两种模式部署分支缓存。  

![分支缓存模式](../media/BranchCache/bc_modes.jpg)

分布式的缓存模式非常适合不包含本地用作托管的缓存服务器服务器的小型分支机构。 分布式的缓存模式允许你部署分支缓存中分支机构的任何其他硬件使用。

如果你想要部署分支缓存分支机构包含其他基础结构，如运行的其他的工作负载的一个或多个服务器托管的缓存型部署分支缓存不如出于以下原因：

### <a name="increased-cache-availability"></a>增加的缓存可用性

托管的缓存模式增加缓存效率，即使最初请求和缓存的数据的客户端处于脱机状态，因为内容提供。 因为托管的缓存 server 始终可用，缓存更多内容提供更大 WAN 带宽流量节省类型，并提高效率分支缓存。

### <a name="centralized-caching-for-multiple-subnet-branch-offices"></a>集中多子网分支机构的缓存


分布式的缓存模式下的单个子的操作。 在配置为分布式的缓存模式多子网 branch 办公室，不能与客户端计算机上其他子网共享到一个子网下载的文件。 

出于此原因，其他子网，不能发现的已下载该文件的客户端获取文件从主 office 内容服务器，在此过程中使用 WAN 带宽。

部署托管的缓存模式时，但是，这不是这种情况 — 多子网 branch 办公室中的所有客户可以都访问存储在托管的缓存服务器上，即使这些客户端是不同子网单个缓存。 此外，在 Windows Server 2016、 Windows Server 2012 R2 和 Windows Server 2012 分支缓存提供部署每分支机构的多个托管的缓存服务器的能力。

> [!CAUTION]
> 如果你使用分支缓存 SMB 缓存的文件和文件夹，不要禁用脱机文件。 如果你禁用脱机文件，分支缓存 SMB 缓存不能正常工作。

## <a name="BKMK_3"></a>分支缓存启用内容服务器

分支缓存部署时，源内容存储在你的主 office 或云数据中心中启用了分支缓存的内容服务器上。 支持以下类型的内容服务器分支缓存：

> [!NOTE]
> 仅源的内容-即内容客户端计算机最初分支缓存启用内容服务器-下获取是通过分支缓存加快速度。 客户端计算机直接从其他来源，如 Windows 更新或 Internet 上的 Web 服务器获得的内容不缓存的客户端计算机或托管的缓存服务器，然后与其他计算机中分支机构共享。 如果你想要加快 Windows 更新的内容，但是，可以安装在你的主 office 或云数据中心的 Windows Server Update Services (WSUS) 应用服务器，并对其进行配置为分支缓存内容服务器。

### <a name="web-servers"></a>Web 服务器

受支持的 Web 服务器包括的计算机正在运行 Windows Server 2016、 Windows Server 2012 R2、 Windows Server 2012 或 Windows Server 2008 R2 具有安装了 Web 服务器 (IIS) 服务器角色和超文本传输协议 (HTTP) 或 HTTP 安全 (HTTPS) 使用。

此外，Web 服务器必须安装分支缓存功能。

### <a name="file-servers"></a>文件服务器

受支持的文件服务器包括运行的 Windows Server 2016、 Windows Server 2012 R2、 Windows Server 2012 或 Windows Server 2008 R2 具有文件服务 server 角色并安装网络文件角色服务分支缓存的计算机。 

这些文件服务器使用服务器消息块 (SMB) 交换计算机之间的信息。 文件服务器的安装完成后，你必须共享文件夹，并使用组策略或本地计算机策略启用分支缓存中启用的共享文件夹的希生成。

### <a name="application-servers"></a>应用程序服务器

受支持的应用程序服务器包括计算机正在运行 Windows Server 2016、 Windows Server 2012 R2、 Windows Server 2012 或 Windows Server 2008 R2 通过后台智能传输服务 (BITS) 安装并启用。 

此外，应用程序服务器必须安装分支缓存功能。 应用程序服务器的示例，可以部署分支缓存内容服务器为 Microsoft Windows Server Update Services (WSUS) 和 Microsoft 系统中心配置管理器分支分布点服务器。

## <a name="BKMK_3a"></a>分支缓存和云

云中有巨大可能减少支出操作并实现新的缩放级别，但移动工作负载离开取决于它们的人员可以增加网络成本和影响了工作效率。 用户预期高性能和不关注承载他们的应用程序和数据。 

分支缓存可以提高联网的应用程序性能，并减少和数据共享缓存带宽使用量。  它提高了工作效率分支机构和中总部，人员在使用云中使用程序部署的服务器。

因为新硬件或网络拓扑更改分支缓存不需要，则绝好提高 office 位置和公开并专用云霞之间进行通信的解决方案。

> [!NOTE]
> 由于某些 Web 代理服务器无法处理内容编码非标准标头，建议你与 Hyper 短信安全传输协议 (HTTPS) 和不 HTTP 使用分支缓存。
  
=== 有关在 Windows Server 2016 中的云技术的详细信息，请参阅[软件定义网络 & #40;SDN & #41;](../sdn/Software-Defined-Networking--SDN-.md).
  
## <a name="bkmk_version"></a>内容的信息版本

有两种版本的内容的信息：

- 版本 1 或 V1 称为与计算机运行的 Windows Server 2008 R2 和 Windows 7 兼容的内容的信息。 与 V1 分支缓存的文件分段，文件段大于 V2 中，并为固定大小。 由于大型固定的段大小用户进行了更改修改文件的长度，当将与此更改段失效，不仅全部到该文件的末尾段失效。 由于已更改的内容和更改后的所有内容都通过 WAN 链接发送，用于被其他用户分支机构中更改的文件的下一个调用因此导致减少 WAN 带宽流量节省类型。

- 第 2 版或 V2 称为与计算机运行的 Windows Server 2016、 Windows 10、 Windows Server 2012 R2、 Windows 8.1、 Windows Server 2012 和 Windows 8 兼容的内容的信息。 V2 内容信息使用较小、 即是美变量线段，分别更能容忍到文件中的更改。 当用户访问更新的版本，导致这些内容服务器上，从检索仅更改该文件的部分，并使用较少 WAN 带宽可重复使用段从较早版本的文件的可能性该增加。

下表取决于的客户端，内容服务器上，使用的内容的信息版本上提供信息以及托管你使用你的分支缓存部署缓存服务器操作系统。

> [!NOTE]
> 下表中的首字母缩写"操作系统"意味着操作系统。

|客户端操作系统|内容服务器操作系统|托管的缓存服务器操作系统|内容的信息版本|
|-------------|---------------------|--------------------------|-------------------------------|
|Windows Server 2008 R2 和 Windows 7 |Windows Server 2012 或更高版本|Windows Server 2012 或更高版本;无分布式的缓存模式|V1|
|Windows Server 2012 或更高版本;Windows 8 或更高版本|Windows Server 2008 R2 |Windows Server 2012 或更高版本;无分布式的缓存模式|V1|
|Windows Server 2012 或更高版本;Windows 8 或更高版本| Windows Server 2012 或更高版本| Windows Server 2008 R2 |V1|
|Windows Server 2012 或更高版本;Windows 8 或更高版本|Windows Server 2012 或更高版本|Windows Server 2012 或更高版本;无分布式的缓存模式|第 2 版|

当内容服务器，并且托管运行的 Windows Server 2016、 Windows Server 2012 R2 和 Windows Server 2012 的缓存服务器时，他们将使用是基于请求的信息的分支缓存客户端操作系统适当的内容的信息版本。 

当计算机运行的 Windows Server 2012 和 Windows 8 或更高版本操作系统请求内容时，内容托管的缓存服务器使用 V2 内容的信息。在运行 Windows Server 2008 R2 和 Windows 7 的计算机请求内容，内容托管的缓存服务器使用 V1 内容的信息。

>[!IMPORTANT]
>分布式的缓存型部署分支缓存时，使用内容的信息不同版本的客户端不彼此共享内容。 例如，客户端计算机运行的 Windows 7 和客户端计算机运行 Windows 10 的安装在相同的分支机构不共享内容彼此。
  
## <a name="bkmk_handles"></a>分支缓存如何处理内容的更新中的文件

当分支机构用户修改或更新的文档内容时，所做的更改直接写入主要没有分支缓存的参与办公室中的内容服务器。 用户从内容服务器下载文档还是其获取从任何一个分支机构中的托管或分布式缓存也是如此。

由其他客户端中分支机构请求修改后的文件时，该文件的新段从主 office 服务器下载并添加到该 branch 中分布式或托管的缓存。 出于此原因，分支机构用户始终接收最新版本的缓存的内容。

## <a name="BKMK_4"></a>分支缓存安装指南

你可以使用 Windows Server 2016 中服务器管理器安装分支缓存功能或服务文件服务器角色网络文件角色服务分支缓存。 下表可用于确定是否安装了角色服务或功能。

|功能|计算机位置|安装此分支缓存元素|
|-----------------|---------------------|------------------------------------|
|内容服务器 \ (基于位的应用程序 server\)|Office 应用商店或云的主要数据中心|分支缓存的功能|
|内容服务器 \(Web server\)|Office 应用商店或云的主要数据中心|分支缓存的功能|
|内容服务器 \ （使用 SMB protocol\ 文件服务器）|Office 应用商店或云的主要数据中心|分支缓存的文件服务 server 角色网络文件角色服务|
|托管的缓存 server|分支机构|分支缓存托管的缓存 server 启用了模式的功能|
|启用分支缓存的客户端计算机|分支机构|未安装所需;只需启用分支缓存和分支缓存模式 \(distributed or hosted\) 在客户端|

若要安装角色服务或功能，请打开服务器管理器，然后选择你想要启用分支缓存的功能的计算机。 在服务器管理器中，单击**管理**，然后单击**添加角色和功能**。 **添加角色和功能**向导将打开。 向导运行时，请选择以下选项：

- 在向导页面**选择安装类型**，选择**角色基于或功能的安装**。

- 向导页面上**选择服务器角色**，如果你安装了启用分支缓存的文件服务器，展开**文件和存储服务**和**文件和 iSCSI 服务**，然后选择**网络文件的分支缓存**。  为了节省磁盘空间，你可以选择**数据消除**角色服务，，然后继续完成安装和完成向导。 如果你不希望安装的支持分支缓存的文件服务器，并安装了网络文件角色服务分支缓存的文件和存储服务角色。

- 向导页面上**选择功能**，如果你安装的不是文件服务器的内容服务器或安装托管的缓存服务器、 选择**分支缓存**，然后继续完成安装和完成向导。 如果你不希望安装文件服务器或托管的缓存服务器以外的内容服务器，并安装分支缓存的功能。
  
## <a name="bkmk_os"></a>有关分支缓存的操作系统版本

以下是操作系统的功能的支持不同类型分支缓存的列表。

### <a name="operating-systems-for-branchcache-client-computer-functionality"></a>有关分支缓存的客户端计算机功能操作系统

以下操作系统提供支持后台智能传输服务 (BITS)、 Hyper 文本传输协议 (HTTP) 和服务器消息块 (SMB) 分支缓存。

- Windows 10 企业版

- Windows 10 教育版

- Windows 8.1 企业版

- Windows 8 企业版

- Windows 7 企业版

- Windows 7 旗舰版

在以下操作系统，分支缓存不支持 HTTP 和 SMB 功能，但分支缓存位功能支持。

-   Windows 10 专业版，位仅支持

-   Windows 8.1 专业版，位仅支持

-   Windows 8 专业版，位仅支持

-   Windows 7 专业版，位仅支持

> [!NOTE]
> 分支缓存不可用，默认情况下在 Windows Server 2008 或 Windows Vista 的操作系统。 在以下操作系统，但是，你下载并安装 Windows 管理框架更新，分支缓存功能适用于的后台智能传输服务 (BITS) 协议。 有关详细信息，以及下载 Windows Management Framework，请参阅[Windows Management Framework（Windows PowerShell 2.0、WinRM 2.0 和位 4.0）](https://go.microsoft.com/fwlink/?LinkId=188677)在https://go.microsoft.com/fwlink/?LinkId=188677。
  
### <a name="operating-systems-for-branchcache-content-server-functionality"></a>有关分支缓存的操作系统内容服务器功能

你可以使用的 Windows Server 2016、 Windows Server 2012 R2 和 Windows Server 2012 的操作系统系列作为分支缓存内容服务器。

此外，Windows Server 2008 R2 的操作系统系列可用作分支缓存内容服务器，有以下例外：

- 分支缓存 HYPER-V 与 Windows Server 2008 R2 enterprise 服务器核心安装在不支持。

- 分支缓存的 HYPER-V 与 Windows Server 2008 R2 Datacenter Server 核心安装在不支持。

### <a name="operating-systems-for-branchcache-hosted-cache-server-functionality"></a>有关分支缓存的操作系统托管缓存服务器功能

分支缓存承载缓存服务器时，你可以使用的 Windows Server 2016、 Windows Server 2012 R2 和 Windows Server 2012 的操作系统系列。

此外，可以使用以下 Windows Server 2008 R2 操作系统分支缓存承载缓存服务器：

- Windows Server 2008 R2 Enterprise

- Windows Server 2008 R2 Hyper V 的企业版

- Windows Server 2008 R2 企业服务器 Core 安装

- 与 Hyper V 的 Windows Server 2008 R2 企业服务器 Core 安装

- Windows Server 2008 R2 安腾基于系统

- Windows Server 2008 R2 Datacenter

- Windows Server 2008 R2 Datacenter Hyper V 的

- 与 Hyper V 的 Windows Server 2008 R2 Datacenter Server 核心安装

## <a name="bkmk_security"></a>分支缓存安全

分支缓存实现了安全的设计方法，这在你现有的网络安全体系结构，而不为其他设备或复杂的其他安全配置要求旁的无缝地工作。
  
分支缓存非侵害性并且不会更改任何 Windows 身份验证或授权的进程。 部署分支缓存后，身份验证仍可使用域凭据和功能的授权的访问列表控件的 (Acl) 中时不变的方式。 此外，其他配置将继续工作它们在分支缓存部署前一样。

分支缓存安全模型取决于采用以下形式出现： 哈希一系列的元数据创建。 这些哈希也称为内容的信息。

创建的内容的信息后，它用于分支缓存消息交易所，而不是实际数据，和交换使用受支持的协议 （HTTP，HTTPS，SMB）。

缓存的数据会保持加密，并且没有原始的来源获取的内容的访问权限的客户端无法访问。  客户端必须身份验证和授权的内容的原始之前它们可以检索内容元数据，并且必须拥有访问的缓存当地办公室中的内容元数据。

### <a name="how-branchcache-generates-content-information"></a>如何分支缓存生成内容的信息

从多个元素创建的内容的信息，因为始终是信息的唯一的值的内容。 是的以下元素：

- 派生哈希的实际内容 （如在网页或共享的文件）。  

- 配置参数，如哈希算法和阻止大小。 若要生成内容的信息，请内容服务器划分为线段，分别的内容，然后再将这些线段，分别细分为块。 分支缓存使用加密的安全哈希识别和验证的每个阻止和段，SHA256 哈希算法的支持。

- 服务器机密。 所有内容服务器必须是服务器机密，这是任意长度二进制值与配置。

> [!NOTE]
> 使用服务器幽静可确保的客户端将不能自行生成该内容的信息。 这可以防止恶意用户使用与支持分支缓存的客户端计算机暴力攻击各版本在客户端享有到以前版本的访问权限，但不具有最新版本的访问权限的情况下也猜不到小内容中的更改。

### <a name="content-information-details"></a>内容的信息的详细信息

分支缓存以便衍生将被发送至授权的客户端的特定于内容哈希使用作为键的服务器机密。 将应用到组合的服务器幽静和数据哈希哈希算法生成此希代码。

此希称为段机密。 分支缓存使用段机密安全通信。 此外，分支缓存创建阻止哈希列表中，它是希的数据会阻止列表，以及希的数据，通过哈希阻止哈希列表生成。

内容的信息包括：

- 阻止哈希列表：

    `BlockHashi = Hash(dataBlocki)   1<=i<=n`

- 哈希的数据 (HoD):

    `HoD = Hash(BlockHashList)`

- 段幽静 (Kp):

    `Kp = HMAC(Ks, HoD)`

分支缓存使用等内容缓存协议和检索框架协议实现都需要确保安全缓存与检索之间内容缓存的数据的进程。

此外，分支缓存手柄与安全处理，并发送自身的实际内容时所使用的相同程度内容的信息。

## <a name="bkmk_flow"></a>内容的流量和进程

内容的信息和实际内容的流量分为四个阶段：

1.  [分支缓存进程： 请求内容](#BKMK_8)

2.  [分支缓存进程： 找到内容](#BKMK_9)

3.  [分支缓存进程： 检索内容](#BKMK_10)

4.  [分支缓存进程： 缓存内容](#BKMK_11)

以下部分介绍了这些阶段。

## <a name="BKMK_8"></a>分支缓存进程： 请求内容

在第一阶段，客户端计算机分支机构中的从内容远程的位置，如主要 office 服务器请求内容，如某个文件或网页。 内容服务器验证有权接收请求的内容客户端计算机。 如果已授权的客户端计算机，并且内容服务器和客户端 BranchCache\ 启用，内容 server 生成内容的信息。

然后，内容服务器向客户端计算机使用相同的协议，因为的实际内容使用发送内容的信息。 

例如，如果客户端计算机通过 HTTP 请求网页，内容的服务器发送使用 HTTP 内容的信息。 出于此原因，内容的保证 wire 级安全性，并且是相同的内容的信息。

收到初始部分的内容的信息 （希的数据 + 段幽静） 后，客户端计算机执行以下操作：

- 作为加密密钥 (Ke) 使用段幽静 (Kp)。

- 从 HoD 和 Kp 生成段 ID (HoHoDk):

    `HoHoDk = HMAC(Kp, HoD + C), where C is the ASCII string "MS_P2P_CACHING" with NUL terminator.`

在这一层的主威胁是段幽静的风险，但是分支缓存加密内容数据方块来保护段机密。 分支缓存执行此操作使用的从内容块位于在其中的内容段段幽静加密密钥。

这种方法确保服务器幽静上拥有的不是实体不能发现数据块中的实际内容。 段幽静被视为具有相同的安全纯文本分段本身，因为知道给定段段机密使实体从等获取段，然后将解密它。 知道服务器机密立即不会产生任何特定纯文本，但可用于从加密文本，然后再可能公开部分一些已知暴力猜测攻击数据衍生某些类型的数据。 服务器幽静，因此，应保密。
  
## <a name="BKMK_9"></a>分支缓存进程： 找到内容

内容的信息收到的客户端计算机后，客户端使用段 ID 该缓存分发客户端计算机之间还是位于托管的缓存的服务器，在本地分支 office 缓存中，找到所请求的内容。

如果客户端计算机配置为托管的缓存模式时，它配置托管的缓存服务器的计算机名称，并联系人该服务器来检索该内容。

如果客户端计算机配置为分布式的缓存模式，但是，可能会跨多个缓存分支办公室中的多台计算机上存储的内容。 客户端计算机必须发现之前检索该内容的内容所在的位置。

当他们配置分布式的缓存模式时的客户端计算机通过使用的是基于 Web 服务动态发现 （WS 发现） 协议的发现协议来查找内容。 客户端发送 WS 发现多路广播的探测消息，通过该网络发现缓存的内容。 探测消息包括段 ID，这可使用户，若要检查请求的内容是否与他们缓存中存储的内容相匹配。 如果客户端接收初始探测消息回复广播探测匹配信息查询客户端如果段 ID 匹配本地缓存的内容。  

成功 WS 发现过程取决于正在执行的发现的客户端已正确提供的内容服务器上，它将请求内容的内容信息的事实。

主威胁对数据的请求内容阶段是信息泄露，因为内容的信息的访问权限意味着授权的访问权限的内容。 以减少本风险，发现过程不显示的内容的信息，以外段 ID，它不会泄露纯文本线段包含的内容有关的任何信息。

此外，另一个客户端计算机相同子网上运行恶意用户可以查看原始内容源穿透路由器分支缓存发现交通。

如果分支机构中找不到所请求的内容，客户端内容直接从请求内容服务器跨 WAN 的链接。

收到内容后，它将添加到本地缓存的客户端计算机上或托管的缓存服务器上。 在此情况下，阻止客户端或托管从任何内容不匹配哈希添加到本地缓存的缓存服务器内容的信息。 通过匹配哈希验证内容的过程确保仅有效的内容将添加到缓存，并且受保护的本地缓存完整性。

## <a name="BKMK_10"></a>分支缓存进程： 检索内容

客户端计算机上的内容主机，即托管的缓存服务器或分布式的缓存模式客户端计算机，查找所需的内容后，客户端计算机开始中检索该内容的过程。

首先客户端计算机向需要它的第一个块内容主机发出请求。 请求包含段 ID 和阻止范围找出所需的内容。 因为返回只有一个阻止时，阻止范围包含一个块。 （对多个块请求当前不支持。）客户端还会存储在其本地出色请求列表中的请求。  

在客户端从收到有效请求消息，内容主机检查内容主机内容缓存中中是否存在请求中指定的阻止。

如果拥有的内容阻止内容主机，内容主机将发送包含段 ID、 阻止 ID、 加密的数据块，以及用于加密阻止初始化矢量的响应。

如果内容主机内容块拥有不是，内容主机发送空白响应消息。 这会通知客户端计算机内容主机没有请求的阻止。 空响应消息包含段 ID 和请求块，以及数据零大小块的阻止 ID。

客户端计算机将响应收到内容主机，客户端将验证该邮件对应请求消息其出色请求列表中。 （段 ID 和阻止指数必须匹配，未解决的请求。）

如果此验证过程将失败的客户端计算机其出色请求列表中没有相应的请求邮件客户端计算机放弃该消息。

如果此验证过程已成功，客户端计算机已其出色请求列表中的相应的请求邮件客户端计算机解密阻止。 客户端那么验证对内容的信息，的客户端最初获得的内容的原始服务器的相应阻止哈希解密的阻止。

如果成功块验证，解密的阻止存储在缓存。

重复该过程，直到客户具有的所有必需块。

> [!NOTE]
> 如果不存在一台计算机上的内容的完整线段，检索协议检索并从多种来源装配内容： 的一组分发缓存模式客户端计算机托管的缓存服务器，，并且-分支机构缓存如果不包含完整的内容的原始主要办公室中的内容服务器。

分支缓存发送内容的信息或内容之前，已加密数据。 分支缓存加密响应消息中的阻止。 在 Windows 7 中，使用分支缓存的默认加密算法是 aes-128、 加密密钥 Ke，并且密钥大小 128 位，按照加密算法。 

分支缓存生成适用于加密算法并使用加密密钥加密块初始化矢量。 分支缓存然后记录加密算法并初始化矢量在邮件中。 

服务器和客户端从未交换、 共享或发送彼此加密密钥。 客户端从主机源内容内容服务器接收加密密钥。 然后，它将使用它从服务器接收加密算法并初始化矢量，解密阻止。 没有其他显式身份验证或授权内置下载协议。

### <a name="security-threats"></a>安全威胁

在这一层主要安全威胁包括：

- 篡改数据：

  *客户服务数据向申请者篡改数据*。 分支缓存安全型号使用哈希来确认客户端和服务器都不具有改变数据。  

- 信息泄露：  

    *分支缓存加密的内容发送到指定相应段 ID 任何客户端*。 任何客户端接收加密的内容以便，是公用，段 Id。 但是，如果恶意用户获取加密的内容，他们必须知道要解密内容的加密密钥。 上层协议执行身份验证，然后让身份验证和授权的客户端内容的信息。 内容的信息的安全，相当于本身，内容提供的安全性，并分支缓存永远不会公开内容的信息。  

    *攻击者探测 wire 获取内容*。  分支缓存加密通过使用的 AES128 密钥所在 Ke，从 wire 正在探查防止数据的客户端之间的所有传输。  从内容服务器下载的内容的信息被保护完全相同的方式，因为数据本身就已，因此不或多或少抵御比如果分支缓存未使用的所有信息泄露。

-   拒绝服务：

    *客户端太多数据的请求*。 分支缓存协议合并队列管理计数器和计时器，若要防止正在重载客户端。

## <a name="BKMK_11"></a>分支缓存进程： 缓存内容

在分布式的缓存模式客户端计算机和都位于分支机构的托管的缓存服务器上，内容缓存生成随着时间的推移内容检索通过 WAN 链接。

当客户端计算机配置与托管的缓存模式时，他们添加到自己的本地缓存的内容，并提供托管的缓存 server 的数据。 托管缓存协议提供客户端通知内容和段可用性托管的缓存服务器的机制。

上传到托管的缓存服务器的内容，客户端通知服务器具有提供一段。 然后，托管的缓存 server 检索的所有程序与提供段中，并下载它真正需要段内的块内容的信息。 重复该过程，直到客户端具有没有的更多线段提供托管的缓存的服务器。

若要使用托管缓存协议更新托管的缓存 server，必须满足以下要求：

- 客户端计算机需要具有一组块它能提供给托管的缓存服务器段内。 客户必须提供提供段; 内容的信息这包括段 ID、 段哈希的数据、 段幽静，以及所有阻止哈希段中所含的列表。

- 为托管缓存证书和关联专用密钥正在运行 Windows Server 2008 R2 托管的缓存服务器的服务器要求，并且必须客户端中的计算机分支机构信任认证颁发机构颁发该证书。 这使客户端和服务器成功参与 HTTPS 服务器身份验证。

    > [!IMPORTANT]
    > 托管的缓存服务器正在运行 Windows Server 2016、 Windows Server 2012 R2 或 Windows Server 2012 不需要的托管的缓存服务器证书和关联的专用键。  

- 客户端计算机配置托管的缓存服务器和依据托管的缓存服务器倾听分支缓存交通传输控件协议 (TCP) 端口号的计算机名称。 托管的缓存服务器的证书绑定到该端口。 托管的缓存服务器的计算机名称可以完全限定的域名 (FQDN)，如果托管的缓存服务器域成员计算机;如果托管的缓存服务器不可域成员，可以在计算机的 NetBIOS 名称或者。

- 客户端计算机积极侦听传入阻止请求。 正在侦听的端口交给作为优惠邮件客户端从托管的缓存的服务器。 这使托管的缓存服务器使用分支缓存协议连接到检索领域中的数据块 client 计算机。

- 托管的缓存服务器开始聆听初始化时传入的 HTTP 请求。

- 如果托管的缓存 server 配置为需要客户端计算机身份验证，客户端和服务器托管的缓存所需支持 HTTPS 身份验证。

### <a name="hosted-cache-mode-cache-population"></a>托管的缓存模式缓存人口数量

添加到托管的缓存服务器的缓存中分支机构内容的过程开始，当客户端发送 INITIAL_OFFER_MESSAGE，其中包括段 id。 从托管的缓存服务器阻止缓存检索相应部分哈希的数据，阻止哈希，列表段幽静用于 INITIAL_OFFER_MESSAGE 请求中段 ID。 如果托管的缓存服务器已特定段的所有内容的信息，INITIAL_OFFER_MESSAGE 响应将确定，并下载块没有请求。

如果托管的缓存服务器没有的所有数据提供的块与领域中的阻止哈希相关联，所关注的 INITIAL_OFFER_MESSAGE 响应。 然后，的客户端发送描述而提供的单个段 SEGMENT_INFO_MESSAGE。 托管的缓存 server 响应并确定的消息，并开始缺少会阻止从该服务下载 client 计算机。

段哈希的数据，阻止哈希，列表段幽静用于确保，正在下载的内容不会被篡改或其他更改。 然后，下载会阻止将添加到托管的缓存服务器阻止缓存。

## <a name="bkmk_cache"></a>缓存的安全  
此部分中提供有关分支缓存保护缓存的数据和客户端计算机上托管的缓存服务器的安全信息。

### <a name="client-computer-cache-security"></a>客户端计算机缓存安全
存储在分支缓存的数据最大的威胁被篡改。 如果攻击可以篡改缓存中存储的内容和内容的信息，然后有可能要使用此方法试用并启动攻击分支缓存使用计算机。 攻击者可以启动通过插入来替代的其他数据的恶意软件的攻击。 分支缓存缓解了此威胁，通过验证使用阻止哈希内容的信息中找到的所有内容。 如果攻击尝试篡改此数据，它被丢弃并将替换为原始来源有效的数据。

辅助威胁分支缓存中存储的数据是信息泄露。 分布式的缓存型客户端将缓存仅内容它已请求重试。但是，这些数据存储在清晰的文本，并可能存在安全风险。 若要帮助将缓存访问限制为仅分支缓存服务，本地缓存受 ACL 中指定的文件系统权限。 

虽然 ACL 有效访问缓存防止未经授权的用户，则可能具有管理员权限的用户，若要获得缓存访问的手动更改 ACL 中指定的权限。 分支缓存不能抵御恶意使用管理员帐户。

不加密存储在内容缓存的数据，因此如果数据泄露较为重要，你可以使用如 BitLocker 或加密文件系统 (EFS) 加密技术。 由分支缓存的本地缓存不会增加信息泄露威胁面临的分支机构; 中的计算机缓存包含仅驻留磁盘上的其他地方解密的文件的副本。 

加密整个磁盘是非常重要的客户端物理安全处于难确保的环境中。 例如，加密整个磁盘有助于保护移动可能会从分支机构环境中删除的计算机上的敏感数据。

### <a name="hosted-cache-server-cache-security"></a>托管的缓存服务器缓存安全

托管的缓存型最大的威胁托管的缓存服务器的安全于是信息泄露。 分支缓存托管的缓存环境中的文件系统的权限保护缓存的数据的行为到分布式的缓存模式类似的方式。 区别在于托管的缓存 server 存储所有中分支机构的任何分支缓存启用计算机请求时，内容，而不是只需一个客户所请求的数据。 未经授权的入侵导入到该缓存的后果可能很多严重，因为更多数据受到威胁。  
  
在托管的缓存服务器搭载 Windows Server 2008 R2 托管的缓存环境中，如 BitLocker 或 EFS 加密技术的使用是建议客户分支机构的任何可跨 WAN 的链接访问敏感数据。 由于磁盘加密的工作原理仅当计算机处于关闭状态时攻击者获得物理还有必要，以防物理访问的托管的缓存。  如果计算机处于打开状态，或处于睡眠模式，然后磁盘加密提供的小保护。

> [!NOTE]
> 正在运行 Windows Server 2016、 Windows Server 2012 R2 或 Windows Server 2012 的托管的缓存服务器加密缓存中的所有数据默认情况下，，所以不需要额外的加密技术的使用。

即使托管的缓存型配置客户端，仍将本地缓存的数据，并且你可能想要采取措施保护除了托管的缓存服务器上的缓存的本地缓存。
