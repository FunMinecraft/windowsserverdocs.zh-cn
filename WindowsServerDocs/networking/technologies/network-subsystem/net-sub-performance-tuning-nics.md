---
title: 性能优化网络适配器
description: 本主题是 Windows Server 2016 的网络子系统性能优化指南的一部分。
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: 0b9b0f80-415c-4f5e-8377-c09b51d9c5dd
manager: brianlic
ms.author: pashort
author: shortpatti
ms.openlocfilehash: a0d87f2e8c9b3ca7581d20009cd9c0e030241270
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/10/2019
ms.locfileid: "70871890"
---
# <a name="performance-tuning-network-adapters"></a>性能优化网络适配器

>适用于：Windows Server（半年频道）、Windows Server 2016

你可以使用本主题来优化安装在运行 Windows Server 2016 的计算机中的网络适配器。

为你的网络适配器确定正确的优化设置取决于以下可变因素：

- 网络适配器及其功能集  

- 由服务器执行的工作负载的类型  

- 服务器硬件和软件资源  

- 服务器的性能目标  

如果网络适配器提供优化选项，则可以优化网络吞吐量和资源使用情况，以便根据以上所述参数获得最佳吞吐量。  

以下各部分介绍了某些性能优化选项。  

##  <a name="bkmk_offload"></a>启用卸载功能

启用网络适配器卸载功能通常会带来好处。 但是，网络适配器有时并不足以强大到可以处理具有较高吞吐量的卸载功能。

>[!IMPORTANT]
>不要使用卸载功能**IPsec 任务卸载**或**TCP 烟囱卸载**。 这些技术在 Windows Server 2016 中已弃用，可能会对服务器和网络性能产生负面影响。 此外，Microsoft 将来可能不支持这些技术。

例如，启用分段卸载可以减少由于有限的硬件资源所造成的某些网络适配器上的最大可持续吞吐量。 但是，如果预计降低的吞吐量不会成为限制，则应该启用卸载功能（即使对于这种类型的网络适配器）。

>[!NOTE]
> 某些网络适配器需要为发送和接收路径独立启用卸载功能。

##  <a name="bkmk_rss_web"></a>启用 Web 服务器的接收方缩放（RSS）

当服务器上的网络适配器少于逻辑处理器时，RSS 可以提高 Web 的可伸缩性和性能。 当所有 Web 流量经过支持 RSS 的网络适配器时，来自不同连接的传入 Web 请求可以在不同的 CPU 之间同时处理。

值得注意的是，由于 rss 和超文本传输协议\(HTTP\)中的逻辑用于负载分配，如果不支持 rss 的网络适配器接受具有一个或的服务器上的 web 流量，则性能可能会受到严重降级支持 RSS 的网络适配器更多。 在此情况下，你应该使用支持 RSS 的网络适配器或在网络适配器属性“高级属性”选项卡上禁用 RSS。若要确定网络适配器是否支持 RSS，你可以在网络适配器属性“高级属性”选项卡上查看 RSS 信息。

### <a name="rss-profiles-and-rss-queues"></a>RSS 配置文件和 RSS 队列

默认 RSS 预定义配置文件为 NUMA 静态，这将更改操作系统以前版本中的默认行为。 若要开始使用 RSS 配置文件，你可以查看可用的配置文件，以了解它们何时可以为你带来好处，以及如何将它们应用于你的网络环境和硬件。

例如，如果打开任务管理器并在服务器上查看逻辑处理器，而且它们似乎没有得到充分利用以接收流量，则可以尝试将 RSS 队列中的数目从默认值 2 增加到网络适配器所支持的最大数目。 你的网络适配器可能具有将 RSS 队列数目作为驱动程序的一部分进行更改的选项。

##  <a name="bkmk_resources"></a>增加网络适配器资源

对于允许手动配置资源的网络适配器，如接收和发送缓冲区，则应增加分配的资源。 

某些网络适配器将它们的接收缓冲区设置得较低以节省从主机分配的内存。 较低的值会导致数据包丢弃和性能降低。 因此，对于接收密集型的方案，我们建议你将接收缓冲区值增加到最大值。

>[!NOTE]
>如果网络适配器不公开手动资源配置，则它将动态配置资源，或者将资源设置为一个无法更改的固定值。

### <a name="enabling-interrupt-moderation"></a>启用中断裁决

若要控制中断裁决，某些网络适配器将公开不同的中断裁决级别、缓冲区合并参数（有时分别针对发送和接收缓冲区），或两者兼有。

你应考虑与 CPU 绑定的工作负载的中断裁决，并且考虑主机 CPU 节约和延迟与因为更多的中断或更少的延迟而增加的主机 CPU 节约之间的平衡。 如果网络适配器不执行中断裁决，但它确实公开了缓冲区合并，则增大的合并缓冲区的数目将允许针对每个发送或接收具有更多缓冲区，这样可以提高性能。

##  <a name="bkmk_low"></a>低延迟数据包处理的性能优化

许多网络适配器提供选项来优化由操作系统触发的延迟。 延迟是处理网络驱动程序传入数据包和网络驱动程序发回数据包之间经过的时间。 此时间通常以微秒为单位。 为了进行比较，通常以毫秒为单位测量数据包传输的传输时间（以\(毫秒为单位\)）。 此优化不会减少数据包在传输过程中所花的时间。

以下是某些针对微秒敏感网络的性能优化建议。

- 请将计算机的 BIOS 设置为**高性能**，并禁用 CPU 电源状态。 但是，请注意这与系统和 BIOS 相关，如果操作系统控制电源管理，则某些系统将提供更高的性能。 可以通过**设置**或使用**powercfg**命令来检查和调整电源管理设置。 有关详细信息，请参阅[Powercfg 命令行选项](https://technet.microsoft.com/library/cc748940.aspx)

- 请将操作系统电源管理配置文件设置为**高性能系统**。 请注意，如果系统 BIOS 已设置为禁用电源管理的操作系统控制，这将无法正常工作。

- 启用静态卸载，例如，UDP 校验和、TCP 校验和以及发送大型卸载 (LSO)。

- 如果流量是多流式传输的（例如，高容量多播接收），则启用 RSS。

-   针对需要可能的最低延迟的网卡驱动程序，禁用**中断裁决**设置。 请记住，这可能会占用更多的 CPU 时间，并且它表示一种权衡。

- 在内核处理器上处理网络适配器中断和 DPC，该处理器与处理数据包的程序（用户线程）所用的内核共享 CPU 缓存。 可以使用 CPU 相关性优化将进程定向到特定的逻辑处理器并结合 RSS 配置来实现此目的。 将相同的内核用于中断、DPC 和用户模式线程会随着负载的增加而表现出最差的性能，因为 ISR、DPC 和线程会争夺对内核的使用。

##  <a name="bkmk_smi"></a>系统管理中断

许多硬件系统使用系统管理将\(SMI\)中断到各种维护功能，包括报告错误更正代码\(ECC\)内存错误、旧 USB 兼容性、风扇控制和 BIOS 控制电源管理。 

SMI 是系统上的最高优先级中断，并将 CPU 置于管理模式，在它运行中断服务例程时会抢占所有其他活动，通常是包含在 BIOS 中的活动。

遗憾的是，这可能导致 100 微秒或更大的延迟峰值。 

如果你需要达到最低延迟，应要求你的硬件提供商提供可将 SMI 降低到可能的最低程度的 BIOS 版本。 它们通常称为“低延迟 BIOS”或“无 SMI 的 BIOS”。 在某些情况下，硬件平台不可能完全消除 SMI 活动，因为 SMI 用于控制基本功能（例如，冷却风扇）。

>[!NOTE]
>操作系统可能无法控制 SMI，因为逻辑处理器在特殊的维护模式下运行，这会阻止操作系统干预。

##  <a name="bkmk_tcp"></a>性能优化 TCP

 你可以使用以下各项来优化 TCP 的性能。

###  <a name="bkmk_tcp_params"></a>TCP 接收窗口自动调节

在 Windows Server 2008 之前，网络堆栈使用固定大小的接收方窗口（65535个字节），该窗口限制了连接的总体可能吞吐量。 对 TCP 堆栈的最重要更改之一是 TCP 接收窗口自动调整。 

使用固定大小 TCP 接收窗口时，可以计算单一连接的总吞吐量：

**可实现的总吞吐量（以字节为单位） = \* TCP 接收窗口大小（以字节为单位）**

例如，在10毫秒\(的连接上，总可实现的吞吐量只有 51 Mbps，这是大型企业网络基础结构\)的合理值。 

但是，使用自动调节时，可以对接收方窗口进行调节，但该窗口也可能增大以满足发送方的要求。 连接可以实现 1 Gbps 连接的全部线路速率。 在过去可能受到可实现的 TCP 连接总吞吐量的限制的网络使用方案现在可以完全使用该网络。

#### <a name="deprecated-tcp-parameters"></a>不推荐使用的 TCP 参数

Windows Server 2003 中的以下注册表设置不再受支持，在更高版本中将被忽略。

所有这些设置都具有以下注册表位置：

    ```  
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Tcpip\Parameters  
    ```  

- TcpWindowSize

- NumTcbTablePartitions  

- MaxHashTableSize  



###  <a name="bkmk_wfp"></a>Windows 筛选平台

Windows Vista 和 Windows Server 2008 中引入的 Windows 筛选平台（WFP）为非 Microsoft 独立软件供应商（Isv）提供 Api 来创建数据包处理筛选器。 其示例包括防火墙和防病毒软件。

>[!NOTE]
>编写不当的 WFP 筛选器可能会显著降低服务器的网络性能。 有关详细信息，请参阅 Windows 开发人员中心中的将[包处理驱动程序和应用程序移植到 WFP](https://msdn.microsoft.com/windows/hardware/gg463267.aspx) 。


有关本指南中的所有主题的链接，请参阅[网络子系统性能优化](net-sub-performance-top.md)。
