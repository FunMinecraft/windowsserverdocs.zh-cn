---
title: 连接请求策略
description: 本主题概述了 Windows Server 2016 中的网络策略服务器连接请求策略。
manager: brianlic
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: 4ec45e0c-6b37-4dfb-8158-5f40677b0157
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 21330b3838064c7b31e78ef70bdc04f0db0f50db
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59872938"
---
# <a name="connection-request-policies"></a>连接请求策略

>适用于：Windows 服务器 （半年频道），Windows Server 2016

可以使用本主题以了解如何使用 NPS 连接请求策略将 NPS 配置为 RADIUS 服务器、 RADIUS 代理，或两者。

>[!NOTE]
>除了本主题提供了以下连接请求策略文档。
> - [配置连接请求策略](nps-crp-configure.md)
> - [配置远程 RADIUS 服务器组](nps-crp-rrsg-configure.md)

连接请求策略是一系列的条件和设置，允许网络管理员指定哪些远程身份验证拨入用户服务 (RADIUS) 服务器执行身份验证和授权连接请求运行网络策略服务器 (NPS) 服务器接收来自 RADIUS 客户端。 可以配置连接请求策略以指定哪些 RADIUS 服务器用于 RADIUS 记帐。

您可以创建连接请求策略，以便本地处理从 RADIUS 客户端发送的某些 RADIUS 请求消息 （NPS 用作 RADIUS 服务器） 和其他类型的消息转发到另一个 RADIUS 服务器 （NPS 用作 RADIUS 代理）。

使用连接请求策略，可以使用 NPS 作为 RADIUS 服务器或 RADIUS 代理，受各种因素影响，如下所示： 

- 时间和日期是星期几
- 连接请求中的领域名称
- 所请求的连接类型
- RADIUS 客户端的 IP 地址

处理或传入消息的设置与至少一个 NPS 上配置的连接请求策略匹配时才由 NPS 转发 RADIUS 访问-请求消息。 

如果策略设置匹配，并且该策略要求 NPS 处理该消息，NPS 会充当 RADIUS 服务器进行身份验证和授权连接请求。 如果策略设置匹配，并且该策略要求 NPS 将消息转发，NPS 充当 RADIUS 代理，并将转发连接请求发送到远程 RADIUS 服务器进行处理。

如果传入 RADIUS 访问-请求消息的设置与至少一个连接请求策略都不匹配，访问-拒绝消息发送到 RADIUS 客户端，并尝试连接到网络计算机的用户被拒绝访问。

## <a name="configuration-examples"></a>配置示例

以下配置示例演示如何使用连接请求策略。

### <a name="nps-as-a-radius-server"></a>作为 RADIUS 服务器的 NPS

默认连接请求策略是唯一配置的策略。 在此示例中，NPS 配置为 RADIUS 服务器，并由本地 NPS 处理所有连接请求。 NPS 可以进行身份验证和授权的用户使用其帐户是在 NPS 域的域和受信任域中。


### <a name="nps-as-a-radius-proxy"></a>作为 RADIUS 代理的 NPS

删除默认连接请求策略，并请求转发到两个不同的域创建两个新的连接请求策略。 在此示例中，NPS 配置为 RADIUS 代理。 NPS 不处理本地服务器上的任何连接请求。 相反，它将连接请求转发到 NPS 或其他 RADIUS 服务器配置为远程 RADIUS 服务器组的成员。


### <a name="nps-as-both-radius-server-and-radius-proxy"></a>NPS 用作 RADIUS 服务器和 RADIUS 代理

除了默认连接请求策略，被创建新的连接请求策略，将连接请求转发到的 NPS 或其他 RADIUS 服务器位于不受信任域中。 在此示例中，代理策略将显示策略的有序列表中的第一行。 如果连接请求与代理策略匹配，则连接请求转发到远程 RADIUS 服务器组中的 RADIUS 服务器。 如果连接请求与代理策略不匹配，但与默认连接请求策略匹配，NPS 会处理本地服务器上的连接请求。 如果连接请求与任一策略不匹配，则会放弃。

### <a name="nps-as-radius-server-with-remote-accounting-servers"></a>NPS 用作 RADIUS 服务器与远程记帐服务器

在此示例中，本地 NPS 未配置为执行记帐和默认连接请求策略进行修改以使 RADIUS 记帐消息转发到的 NPS 或其他 RADIUS 服务器的远程 RADIUS 服务器组中。 尽管转发记帐消息，但不转发身份验证和授权消息，并且本地 NPS 执行这些函数中的本地域和所有受信任的域。


### <a name="nps-with-remote-radius-to-windows-user-mapping"></a>NPS 使用远程 RADIUS 到 Windows 用户映射

在此示例中，NPS 充当 RADIUS 服务器和 RADIUS 代理，为每个单独的连接请求通过将身份验证请求转发到远程 RADIUS 服务器同时使用本地 Windows 用户帐户进行授权。 此配置是通过将配置为连接请求策略的条件的远程 RADIUS 到 Windows 用户映射的属性实现的。 （此外，用户帐户必须在本地创建的远程 RADIUS 服务器对其执行身份验证的远程用户帐户同名。）

## <a name="connection-request-policy-conditions"></a>连接请求策略条件

连接请求策略条件是与传入 RADIUS 访问-请求消息的属性进行比较的一个或多个 RADIUS 属性。 如果有多个条件，然后在连接中的条件的所有请求消息，并在连接请求策略必须匹配策略由 NPS 强制执行。


以下是可用的条件属性可以在连接请求策略中配置。

### <a name="connection-properties-attribute-group"></a>连接属性的属性组

连接属性的属性组包含以下属性。

- **帧协议**。 用于指定的传入数据包的帧的类型。 示例包括点对点协议 (PPP)、 串行线路 Internet 协议 (SLIP)、 帧中继和 X.25。
- **服务类型**。 用于指定所请求的服务类型。 示例包括帧 （如示例中，PPP 连接） 和登录名 （例如，Telnet 连接）。 有关 RADIUS 服务类型的详细信息，请参阅 RFC 2865"远程身份验证拨入用户服务 (RADIUS)。"
- **隧道类型**。 用于指定请求的客户端创建的隧道的类型。 隧道类型包括点对点隧道协议 (PPTP) 和两个层隧道协议 (L2TP)。

### <a name="day-and-time-restrictions-attribute-group"></a>日期和时间限制的属性组 

日期和时间限制的属性组中包含的日期和时间限制的属性。 使用此属性，您可以指定日期是星期几和一天的连接尝试的时间。 日期和时间是相对于的日期和时间的 NPS。

### <a name="gateway-attribute-group"></a>网关属性组

网关属性组包含以下属性。

- **被叫站 ID**。 用于指定网络访问服务器的电话号码。 此属性是一个字符字符串。 可以使用模式匹配语法指定区号。
- **NAS 标识符**。 用于指定网络访问服务器的名称。 此属性是一个字符字符串。 可以使用模式匹配语法指定 NAS 标识符。
- **NAS IPv4 地址**。 用于指定 Internet 协议版本 4 (IPv4) 地址的网络访问服务器 （RADIUS 客户端）。 此属性是一个字符字符串。 可以使用模式匹配语法来指定 IP 网络。
- **NAS IPv6 地址**。 用于指定 Internet 协议版本 6 (IPv6) 地址的网络访问服务器 （RADIUS 客户端）。 此属性是一个字符字符串。 可以使用模式匹配语法来指定 IP 网络。
- **NAS 端口类型**。 用于指定访问客户端使用的媒体类型。 示例包括模拟电话线 （称为异步）、 综合业务数字网 (ISDN)、 隧道或虚拟专用网络 (Vpn)、 IEEE 802.11 无线和以太网交换机。

### <a name="machine-identity-attribute-group"></a>计算机标识属性组

计算机标识属性组包含计算机标识属性。 通过使用此属性，可以在策略中指定与其客户端进行标识的方法。

### <a name="radius-client-properties-attribute-group"></a>RADIUS 客户端属性属性组

RADIUS 客户端属性的属性组包含以下属性。

- **主叫站 ID**。 用于指定由调用方 （访问客户端） 的电话号码。 此属性是一个字符字符串。 可以使用模式匹配语法指定区号。  802.1x 身份验证中 MAC 地址通常填充，并且可以从客户端匹配。  为而无需验证凭据的接受用户配置连接请求策略时，通常 Mac 地址绕过方案使用此字段。  
- **客户端友好名称**。 用于指定请求身份验证的 RADIUS 客户端计算机的名称。 此属性是一个字符字符串。 可以使用模式匹配语法来指定客户端名称。
- **客户端 IPv4 地址**。 用于指定网络访问服务器 （RADIUS 客户端） 的 IPv4 地址。 此属性是一个字符字符串。 可以使用模式匹配语法来指定 IP 网络。
- **客户端 IPv6 地址**。 用于指定网络访问服务器 （RADIUS 客户端） 的 IPv6 地址。 此属性是一个字符字符串。 可以使用模式匹配语法来指定 IP 网络。
- **客户端供应商**。 用于指定请求身份验证的网络访问服务器的供应商联系。 运行路由和远程访问服务的计算机是 Microsoft NAS 制造商。 此属性可用于配置不同的 NAS 制造商为单独的策略。 此属性是一个字符字符串。 可以使用模式匹配语法。

### <a name="user-name-attribute-group"></a>用户名称属性组

用户名属性组包含用户名属性。 通过使用此属性，可以指定用户名称或用户名，必须与 RADIUS 消息中访问客户端提供的用户名匹配的一部分。 此属性是通常包含领域名称和用户帐户名称的字符串。 可以使用模式匹配语法来指定用户名。

## <a name="connection-request-policy-settings"></a>连接请求策略设置

连接请求策略设置是一组应用于传入 RADIUS 消息的属性。 设置包含下列属性组。

- 身份验证
- 记帐
- 属性操作
- 转发请求
- 高级

以下部分提供有关这些设置的其他详细信息。

### <a name="authentication"></a>身份验证

通过使用此设置，可以重写所有网络策略中配置的身份验证设置，并且您可以指定的身份验证方法和所需连接到网络的类型。

>[!IMPORTANT]
>如果是比在网络策略中配置的身份验证方法安全性较低的连接请求策略中配置身份验证方法，在网络策略中配置的更安全的身份验证方法是重写。 例如，如果您有一个网络策略要求使用受保护的可扩展身份验证协议 Microsoft 质询握手身份验证协议版本 2 \(PEAP MS-CHAP v2\)，这是一个基于密码的用于安全无线身份验证方法，您还配置连接请求策略以允许未经身份验证的访问，则结果为没有客户端所需使用 PEAP MS-CHAP v2 进行身份验证。 在此示例中，连接到网络的所有客户端都被授予未经身份验证的访问权限。

### <a name="accounting"></a>记帐

通过使用此设置，可以配置连接请求策略，以将记帐信息转发到的 NPS 或其他 RADIUS 服务器的远程 RADIUS 服务器组中，以便远程 RADIUS 服务器组执行记帐。

>[!NOTE]
>如果有多个 RADIUS 服务器，并且你想存储在一个中央 RADIUS 记帐数据库中的所有服务器的记帐信息，您可以使用连接请求策略记帐设置中每个 RADIUS 服务器上的某个策略中将记帐数据转发到所有的 nps 服务器或其他 RADIUS 服务器指定为记帐服务器。

连接请求策略记帐设置功能与本地 NPS 记帐配置无关。 换而言之，如果本地 NPS 配置为 RADIUS 记帐信息记录到本地文件或 Microsoft SQL Server 数据库，即可实现这一点无论是否配置用于将记帐消息转发到远程 RADIUS 的连接请求策略服务器组。

如果要远程而不是本地记录记帐信息，则必须配置本地 NPS 不执行记帐，同时还用于将记帐数据转发到远程 RADIUS 服务器组的连接请求策略中配置记帐。

### <a name="attribute-manipulation"></a>属性操作

可以配置一组操作的以下属性之一的文本字符串的查找和替换规则。

- 用户名
- 被叫站 ID
- 主叫站 ID

对上述属性之一的情况下，RADIUS 消息进行身份验证和记帐设置之前进行查找和替换规则处理。 属性操作规则仅适用于单个属性。 不能配置为每个属性的属性操作规则。 此外，您可以操作的属性列表是静态列表;您不能将添加到的属性可用于操作列表。

>[!NOTE]
>如果使用 MS-CHAP v2 身份验证协议，如果使用连接请求策略转发 RADIUS 消息无法对操作的用户名称属性。 唯一的例外发生时反斜杠 (\)使用字符和操作只影响其左侧的信息。 反斜杠字符通常用于表示域名 （反斜杠字符左侧信息） 和域 （反斜杠字符右侧的信息） 中的用户帐户名。 在这种情况下，允许仅属性操作规则修改或替换的域名。

有关如何处理在用户名属性的领域名称的示例，请参阅主题中的"处理中的用户名属性的领域名称的示例"部分[在 NPS 中使用正则表达式](nps-crp-reg-expressions.md)。

### <a name="forwarding-request"></a>转发请求

您可以设置下列转发请求选项，用于 RADIUS 访问-请求消息：

- **此服务器上的请求进行身份验证**。 通过使用此设置，NPS 将使用 Windows NT 4.0 域、 Active Directory 或本地安全帐户管理器 (SAM) 用户帐户数据库连接请求进行身份验证。 此设置还指定，在 NPS 中，以及用户帐户的拨入属性配置的匹配网络策略由 NPS 用于授予连接请求。 在这种情况下，NPS 配置为充当 RADIUS 服务器。

- **将请求转发到以下远程 RADIUS 服务器组**。 通过使用此设置，NPS 将连接请求转发到指定的远程 RADIUS 服务器组。 如果 NPS 接收对应于访问-请求消息的有效访问-接受消息，经过身份验证和授权，则认为连接尝试。 在这种情况下，NPS 充当 RADIUS 代理。

- **接受的用户，而无需验证凭据**。 通过使用此设置，NPS 不验证尝试连接到网络的用户的标识和 NPS 不会尝试验证用户或计算机有权连接到网络。 如果 NPS 配置为允许未经身份验证的访问，它接收连接请求，NPS 会立即发送到 RADIUS 客户端的用户或计算机访问接受消息授予网络访问权限。 此设置用于某些类型的强制隧道，访问客户端进行隧道传输之前用户凭据进行身份验证。

>[!NOTE]
>当访问客户端的身份验证协议是 MS-CHAP v2 或可扩展身份验证协议-传输层安全性 (EAP-TLS)，这两者都提供相互身份验证时，不能使用此身份验证选项。 在相互身份验证，访问客户端证明它是有效的访问客户端身份验证服务器 (NPS)，并在身份验证服务器证明它是有效的身份验证服务器来访问客户端。 使用此身份验证选项时，返回访问-接受消息。 但是，身份验证服务器不提供对访问客户端，验证和相互身份验证失败。

有关如何使用正则表达式来创建路由规则，将具有指定的领域名称的 RADIUS 消息转发到远程 RADIUS 服务器组的示例，请参阅主题中的"通过代理服务器转发 RADIUS 消息的示例"部分[使用在 NPS 中的正则表达式](nps-crp-reg-expressions.md)。

### <a name="advanced"></a>高级

可以设置高级的属性，以指定 RADIUS 属性的一系列：

- 当 NPS 用作 RADIUS 身份验证或记帐服务器添加到 RADIUS 响应消息。 当在网络策略和连接请求策略中指定的属性时，RADIUS 响应消息中发送的属性将是两组属性的组合。
- 当 NPS 用作 RADIUS 身份验证或记帐代理添加到 RADIUS 消息。 如果转发的消息中已存在该属性，它将被替换的连接请求策略中指定的属性的值。 

此外，某些属性可用于在连接上配置请求策略**设置**选项卡**高级**类别提供特定的功能。 例如，可以配置**远程 RADIUS 到 Windows 用户映射**属性时您想要拆分的身份验证和授权的两个用户之间的连接请求帐户数据库。

**远程 RADIUS 到 Windows 用户映射**属性指定的由远程 RADIUS 服务器进行身份验证的用户进行 Windows 授权。 换而言之，远程 RADIUS 服务器执行身份验证的用户帐户在远程用户帐户数据库中，但本地 NPS 授权对本地用户帐户数据库中的用户帐户的连接请求。 当你想要允许访问者访问你的网络时，这很有用。

例如，合作伙伴组织中的访问者可以通过自己合作伙伴组织的 RADIUS 服务器，身份验证，然后使用您的组织的 Windows 用户帐户访问来宾局域网 (LAN) 网络上。

提供特定的功能的其他属性为：

- **MS 隔离 IPFilter 和 MS 隔离会话超时**。 与路由和远程访问 VPN 部署部署网络访问隔离控制 (NAQC) 时，使用这些属性。
- **Passport 的用户的映射的 UPN 后缀**。 此属性允许您使用 Windows Live™ ID 用户帐户凭据的连接请求进行身份验证。
- **隧道标记**。 此特性将指定向其部署虚拟局域网 (Vlan) 时应 nas 分配连接的 VLAN ID 号。

## <a name="default-connection-request-policy"></a>默认连接请求策略

安装 NPS 时创建的默认连接请求策略。 此策略具有以下配置。

- 未配置身份验证。
- 记帐未配置为将记帐信息转发到远程 RADIUS 服务器组。
- 属性未配置的连接请求转发到远程 RADIUS 服务器组的属性操作规则。
- 转发请求，以便连接请求进行身份验证和授权在本地 NPS 上配置。
- 未配置高级的属性。

默认连接请求策略将 NPS 用作 RADIUS 服务器。 若要配置运行 NPS 充当 RADIUS 代理的服务器，还必须配置远程 RADIUS 服务器组。 在使用新的连接请求策略向导创建新的连接请求策略时，可以创建新的远程 RADIUS 服务器组。 您可以删除默认连接请求策略，或验证默认连接请求策略是通过将其放置在策略的有序列表中的最后一次由 NPS 处理的最后一个策略。

>[!NOTE]
>如果 NPS 和远程访问服务安装在同一台计算机和远程访问服务配置为 Windows 身份验证和记帐，就可以为远程访问身份验证和记帐请求转发到 RADIUS 服务器. 远程访问身份验证和记帐请求匹配连接请求策略配置为将其转发到远程 RADIUS 服务器组可以发生该错误。
