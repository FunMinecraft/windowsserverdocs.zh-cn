---
title: 连接请求策略
description: 本主题概述了 Windows Server 2016 中的网络策略服务器连接请求策略。
manager: brianlic
ms.prod: windows-server
ms.technology: networking
ms.topic: article
ms.assetid: 4ec45e0c-6b37-4dfb-8158-5f40677b0157
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 0b373e496567f414657b380bad952baefcbe4b18
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/27/2019
ms.locfileid: "71396365"
---
# <a name="connection-request-policies"></a>连接请求策略

>适用于：Windows Server（半年频道）、Windows Server 2016

您可以使用本主题来了解如何使用 NPS 连接请求策略将 NPS 配置为 RADIUS 服务器、RADIUS 代理或两者。

>[!NOTE]
>除了本主题之外，还提供了以下连接请求策略文档。
> - [配置连接请求策略](nps-crp-configure.md)
> - [配置远程 RADIUS 服务器组](nps-crp-rrsg-configure.md)

连接请求策略是一组条件和设置，这些设置允许网络管理员指定哪些远程身份验证拨入用户服务（RADIUS）服务器执行身份验证和授权。运行网络策略服务器（NPS）的服务器从 RADIUS 客户端接收。 可以配置连接请求策略，以指定哪些 RADIUS 服务器用于 RADIUS 记帐。

你可以创建连接请求策略，以便在本地处理从 RADIUS 客户端发送的某些 RADIUS 请求消息（NPS 用作 RADIUS 服务器），而其他类型的消息将被转发到另一台 RADIUS 服务器（NPS 用作 RADIUS 代理）。

使用连接请求策略，可以根据如下因素将 NPS 用作 RADIUS 服务器或 RADIUS 代理： 

- 一周中的时间和日期
- 连接请求中的领域名称
- 请求的连接类型
- RADIUS 客户端的 IP 地址

仅当传入消息的设置与 NPS 上配置的连接请求策略之一匹配时，NPS 才处理或转发 RADIUS 访问-请求消息。 

如果策略设置匹配，并且策略要求 NPS 处理消息，则 NPS 充当 RADIUS 服务器，并对连接请求进行身份验证和授权。 如果策略设置匹配，并且该策略要求 NPS 转发消息，则 NPS 充当 RADIUS 代理，并将连接请求转发到远程 RADIUS 服务器进行处理。

如果传入 RADIUS 访问请求消息的设置与至少一个连接请求策略不匹配，则会将访问-拒绝消息发送到 RADIUS 客户端，尝试连接到网络的用户或计算机被拒绝访问。

## <a name="configuration-examples"></a>配置示例

以下配置示例演示了如何使用连接请求策略。

### <a name="nps-as-a-radius-server"></a>作为 RADIUS 服务器的 NPS

默认连接请求策略是唯一配置的策略。 在此示例中，NPS 配置为 RADIUS 服务器，并且本地 NPS 处理所有连接请求。 NPS 可以对其帐户位于 NPS 域的域和受信任域中的用户进行身份验证和授权。


### <a name="nps-as-a-radius-proxy"></a>作为 RADIUS 代理的 NPS

将删除默认连接请求策略，并创建两个新的连接请求策略，以将请求转发到两个不同的域。 在此示例中，NPS 配置为 RADIUS 代理。 NPS 不处理本地服务器上的任何连接请求。 相反，它会将连接请求转发到 NPS 或配置为远程 RADIUS 服务器组成员的其他 RADIUS 服务器。


### <a name="nps-as-both-radius-server-and-radius-proxy"></a>同时作为 RADIUS 服务器和 RADIUS 代理的 NPS

除了默认连接请求策略，还会创建新的连接请求策略，以将连接请求转发到不受信任的域中的 NPS 或其他 RADIUS 服务器。 在此示例中，代理策略首先出现在策略的有序列表中。 如果连接请求与代理策略相匹配，则会将连接请求转发到远程 RADIUS 服务器组中的 RADIUS 服务器。 如果连接请求与代理策略不匹配，但与默认连接请求策略相匹配，则 NPS 会处理本地服务器上的连接请求。 如果连接请求与任一策略都不匹配，则会丢弃它。

### <a name="nps-as-radius-server-with-remote-accounting-servers"></a>将 NPS 用作具有远程记帐服务器的 RADIUS 服务器

在此示例中，未将本地 NPS 配置为执行记帐，并修改了默认连接请求策略，以便将 RADIUS 记帐消息转发到远程 RADIUS 服务器组中的 NPS 或其他 RADIUS 服务器。 尽管转发记帐消息，但不会转发身份验证和授权消息，并且本地 NPS 将为本地域和所有受信任域执行这些功能。


### <a name="nps-with-remote-radius-to-windows-user-mapping"></a>具有远程 RADIUS 到 Windows 用户映射的 NPS

在此示例中，通过将身份验证请求转发到远程 RADIUS 服务器，并使用本地 Windows 用户帐户进行授权，NPS 既充当 RADIUS 服务器，又充当每个单独连接请求的 RADIUS 代理。 此配置是通过将 "远程 RADIUS 到 Windows 用户映射" 属性配置为连接请求策略的条件来实现的。 （此外，必须在本地创建一个与远程用户帐户同名的用户帐户，远程 RADIUS 服务器对该帐户执行身份验证。）

## <a name="connection-request-policy-conditions"></a>连接请求策略条件

连接请求策略条件是一个或多个与传入 RADIUS 访问-请求消息的属性进行比较的 RADIUS 属性。 如果有多个条件，则连接请求消息和连接请求策略中的所有条件都必须匹配，才能由 NPS 强制执行策略。


下面是可以在连接请求策略中配置的可用条件特性。

### <a name="connection-properties-attribute-group"></a>连接属性属性组

"连接属性" 属性组包含下列属性。

- **分帧协议**。 用于为传入数据包指定组帧类型。 例如点对点协议（PPP）、串行线路 Internet 协议（SLIP）、帧中继和 .25。
- **服务类型**。 用于指定要请求的服务的类型。 示例包括分帧（例如 PPP 连接）和登录名（例如，Telnet 连接）。 有关 RADIUS 服务类型的详细信息，请参阅 RFC 2865 "远程身份验证拨入用户服务（RADIUS）"。
- **隧道类型**。 用于指定由请求客户端创建的隧道类型。 隧道类型包括点对点隧道协议（PPTP）和第二层隧道协议（L2TP）。

### <a name="day-and-time-restrictions-attribute-group"></a>"日期和时间限制" 属性组 

"日期和时间限制" 属性组包含 "日期和时间限制" 属性。 通过此属性，你可以指定一周中的某一天和连接尝试的时间。 日期和时间相对于 NPS 的日期和时间。

### <a name="gateway-attribute-group"></a>网关属性组

"网关" 属性组包含下列属性。

- 接收站**ID**。 用于指定网络访问服务器的电话号码。 此属性是一个字符串。 您可以使用模式匹配语法来指定区号。
- **NAS 标识符**。 用于指定网络访问服务器的名称。 此属性是一个字符串。 可以使用模式匹配语法来指定 NAS 标识符。
- **NAS IPv4 地址**。 用于指定网络访问服务器（RADIUS 客户端）的 Internet 协议版本4（IPv4）地址。 此属性是一个字符串。 可以使用模式匹配语法来指定 IP 网络。
- **NAS IPv6 地址**。 用于指定网络访问服务器（RADIUS 客户端）的 Internet 协议版本6（IPv6）地址。 此属性是一个字符串。 可以使用模式匹配语法来指定 IP 网络。
- **NAS 端口类型**。 用于指定访问客户端使用的媒体类型。 示例包括模拟电话线路（称为 async）、集成服务数字网（ISDN）、隧道或虚拟专用网络（Vpn）、IEEE 802.11 无线和以太网交换机。

### <a name="machine-identity-attribute-group"></a>计算机标识属性组

"计算机标识" 属性组包含 "计算机标识" 属性。 通过使用此属性，你可以指定在策略中标识客户端时使用的方法。

### <a name="radius-client-properties-attribute-group"></a>RADIUS 客户端属性属性组

"RADIUS 客户端属性" 属性组包含下列属性。

- **接收站 ID**。 用于指定调用方（访问客户端）所使用的电话号码。 此属性是一个字符串。 您可以使用模式匹配语法来指定区号。  在 802.1 x 身份验证中，通常会填充 MAC 地址并将其与客户端匹配。  当连接请求策略配置为 "接受用户而不验证凭据" 时，此字段通常用于 Mac 地址旁路情况。  
- **客户端友好名称**。 用于指定请求身份验证的 RADIUS 客户端计算机的名称。 此属性是一个字符串。 您可以使用模式匹配语法来指定客户端名称。
- **客户端 IPv4 地址**。 用于指定网络访问服务器（RADIUS 客户端）的 IPv4 地址。 此属性是一个字符串。 可以使用模式匹配语法来指定 IP 网络。
- **客户端 IPv6 地址**。 用于指定网络访问服务器（RADIUS 客户端）的 IPv6 地址。 此属性是一个字符串。 可以使用模式匹配语法来指定 IP 网络。
- **客户端供应商**。 用于指定请求身份验证的网络访问服务器的供应商。 运行 "路由和远程访问" 服务的计算机是 Microsoft NAS 制造商。 可以使用此属性为不同的 NAS 制造商配置单独的策略。 此属性是一个字符串。 可以使用模式匹配语法。

### <a name="user-name-attribute-group"></a>用户名属性组

"用户名" 属性组包含 "用户名" 属性。 通过使用此属性，你可以指定用户名或用户名的一部分，该名称必须与 RADIUS 消息中的访问客户端提供的用户名相匹配。 此属性是一个字符串，通常包含领域名称和用户帐户名称。 您可以使用模式匹配语法来指定用户名。

## <a name="connection-request-policy-settings"></a>连接请求策略设置

连接请求策略设置是应用于传入 RADIUS 消息的一组属性。 设置包含以下属性组。

- 身份验证
- 记帐
- 属性操作
- 转发请求
- 高级

以下各节提供了有关这些设置的更多详细信息。

### <a name="authentication"></a>身份验证

通过使用此设置，你可以覆盖在所有网络策略中配置的身份验证设置，你可以指定连接到网络所需的身份验证方法和类型。

>[!IMPORTANT]
>如果在连接请求策略中配置的身份验证方法低于在网络策略中配置的身份验证方法，则会覆盖在网络策略中配置的更安全的身份验证方法。 例如，如果你有一个要求使用受保护的可扩展身份验证协议的网络策略-Microsoft 质询握手身份验证协议版本 2 @no__t 0PEAP-MS-CHAP v2 @ no__t，这是一种基于密码的身份验证用于安全无线的方法，并且还配置连接请求策略以允许未经身份验证的访问，结果是不需要客户端使用 PEAP-MS-CHAP v2 进行身份验证。 在此示例中，连接到网络的所有客户端都被授予未经身份验证的访问权限。

### <a name="accounting"></a>记帐

通过使用此设置，你可以将连接请求策略配置为将记帐信息转发到远程 RADIUS 服务器组中的 NPS 或其他 RADIUS 服务器，使远程 RADIUS 服务器组执行记帐。

>[!NOTE]
>如果你有多个 RADIUS 服务器，并且想要将所有服务器的记帐信息存储在一个中心 RADIUS 记帐数据库中，则可以使用每个 RADIUS 服务器上的策略中的 "连接请求策略" 设置，将记帐数据从所有服务器分配给一个 NPS 或其他指定为记帐服务器的 RADIUS 服务器。

连接请求策略记帐设置功能与本地 NPS 的记帐配置无关。 换言之，如果将本地 NPS 配置为将 RADIUS 记帐信息记录到本地文件或 Microsoft SQL Server 数据库，则无论你是否将连接请求策略配置为将记帐消息转发到远程 RADIUS，它都将执行此操作服务器组。

如果希望远程记录的记帐信息，但不是在本地记录的，则必须将本地 NPS 配置为不执行记帐，同时在连接请求策略中配置记帐，以将记帐数据转发到远程 RADIUS 服务器组。

### <a name="attribute-manipulation"></a>属性操作

可以配置一组查找和替换规则，这些规则可操作以下属性之一的文本字符串。

- 用户名
- 接收站 ID
- 接收站 ID

查找和替换规则在 RADIUS 消息服从身份验证和记帐设置之前的某个属性中进行处理。 特性操作规则仅适用于单个属性。 不能为每个属性都配置属性操作规则。 此外，你可以操作的属性列表是静态列表;不能将添加到可用于操作的属性列表中。

>[!NOTE]
>如果使用的是 MS-CHAP v2 身份验证协议，则在使用连接请求策略转发 RADIUS 消息时，无法操作 "用户名" 属性。 仅当使用反斜杠（@no__t 0 字符，并且操作仅影响它左侧的信息时，才会发生此异常。 反斜杠字符通常用于指示域名（反斜杠字符左侧的信息）以及域中的用户帐户名称（反斜杠字符右侧的信息）。 在这种情况下，只允许修改或替换域名的属性操作规则。

有关如何操作用户名属性中的领域名称的示例，请参阅主题[使用 NPS 中的正则表达式](nps-crp-reg-expressions.md)中的 "用户名属性中的领域名称的操作示例" 部分。

### <a name="forwarding-request"></a>转发请求

你可以设置以下转发请求选项，这些选项用于 RADIUS 访问-请求消息：

- **对此服务器上的请求进行身份验证**。 通过使用此设置，NPS 将使用 Windows NT 4.0 域、Active Directory 或本地安全帐户管理器（SAM）用户帐户数据库对连接请求进行身份验证。 此设置还指定 NPS 使用在 NPS 中配置的匹配网络策略和用户帐户的拨入属性来授权连接请求。 在这种情况下，NPS 被配置为作为 RADIUS 服务器来执行。

- **将请求转发到以下远程 RADIUS 服务器组**。 通过使用此设置，NPS 将连接请求转发到你指定的远程 RADIUS 服务器组。 如果 NPS 收到与访问请求消息相对应的有效访问-接受消息，则连接尝试被视为经过身份验证和授权。 在这种情况下，NPS 充当 RADIUS 代理。

- **接受用户而不验证凭据**。 通过使用此设置，NPS 不验证尝试连接到网络的用户的身份，并且 NPS 不会尝试验证用户或计算机是否具有连接到网络的权限。 当 NPS 配置为允许未经身份验证的访问，并且它收到连接请求时，NPS 会立即向 RADIUS 客户端发送 "访问-接受" 消息，并向用户或计算机授予网络访问权限。 此设置用于某些类型的强制隧道，其中在对用户凭据进行身份验证之前对访问客户端建立隧道。

>[!NOTE]
>当访问客户端的身份验证协议为 MS-CHAP v2 或可扩展身份验证协议-传输层安全性（EAP-TLS），这两者都提供相互身份验证时，不能使用此身份验证选项。 在相互身份验证中，访问客户端向身份验证服务器（NPS）证明它是有效的访问客户端，并且身份验证服务器证明它是访问客户端的有效身份验证服务器。 使用此身份验证选项时，将返回访问-接受消息。 但是，身份验证服务器不会向访问客户端提供验证，相互身份验证也会失败。

有关如何使用正则表达式创建将具有指定领域名称的 RADIUS 消息转发到远程 RADIUS 服务器组的路由规则的示例，请参阅主题使用常规中的 "代理服务器的 RADIUS 消息转发的示例" 部分。 [NPS 中的表达式](nps-crp-reg-expressions.md)。

### <a name="advanced"></a>高级

可以设置高级属性以指定一系列 RADIUS 属性：

- 在将 NPS 用作 RADIUS 身份验证或记帐服务器时添加到 RADIUS 响应消息中。 如果在网络策略和连接请求策略上指定了属性，则在 RADIUS 响应消息中发送的属性是两组属性的组合。
- 当 NPS 用作 RADIUS 身份验证或记帐代理时添加到 RADIUS 消息。 如果转发的消息中已经存在该属性，则会将其替换为连接请求策略中指定的属性的值。 

此外，"**高级**" 类别中的 "连接请求策略**设置**" 选项卡上可用于配置的某些属性提供了专用功能。 例如，当你想要在两个用户帐户数据库之间拆分连接请求的身份验证和授权时，可以配置 "**远程 RADIUS 到 Windows 用户映射**" 属性。

"**远程 radius 到 Windows 用户映射**" 属性指定对由远程 RADIUS 服务器进行身份验证的用户进行 Windows 授权。 换句话说，远程 RADIUS 服务器针对远程用户帐户数据库中的用户帐户执行身份验证，但本地 NPS 向本地用户帐户数据库中的用户帐户授予连接请求。 如果希望允许访问者访问网络，此方法非常有用。

例如，伙伴组织的访问者可以由其自己的合作伙伴组织 RADIUS 服务器进行身份验证，然后在你的组织中使用 Windows 用户帐户来访问网络上的来宾局域网（LAN）。

提供专用功能的其他属性包括：

- **Ms-IPFilter 和 ms-隔离-会话超时**。 使用路由和远程访问 VPN 部署部署网络访问隔离控制（NAQC）时，将使用这些属性。
- **Passport-用户映射-UPN 后缀**。 此属性允许您通过 Windows Live™ ID 用户帐户凭据对连接请求进行身份验证。
- **隧道标记**。 此属性指定在部署虚拟局域网（Vlan）时，NAS 应将连接分配到的 VLAN ID 号。

## <a name="default-connection-request-policy"></a>默认连接请求策略

默认连接请求策略是在安装 NPS 时创建的。 此策略具有以下配置。

- 未配置身份验证。
- 记帐未配置为将记帐信息转发到远程 RADIUS 服务器组。
- 特性未配置用于将连接请求转发到远程 RADIUS 服务器组的属性操作规则。
- 配置转发请求，以便在本地 NPS 上对连接请求进行身份验证和授权。
- 未配置高级属性。

默认连接请求策略将 NPS 用作 RADIUS 服务器。 若要将运行 NPS 的服务器配置为充当 RADIUS 代理，还必须配置远程 RADIUS 服务器组。 使用新建连接请求策略向导创建新的连接请求策略时，可以创建新的远程 RADIUS 服务器组。 您可以删除默认连接请求策略，或验证默认连接请求策略是否是 NPS 处理的最后一个策略，方法是将它放在策略的有序列表中。

>[!NOTE]
>如果 NPS 和远程访问服务安装在同一台计算机上，并且将远程访问服务配置为使用 Windows 身份验证和记帐，则远程访问身份验证和记帐请求可能会转发到 RADIUS 服务器. 当远程访问身份验证和记帐请求与配置为将它们转发到远程 RADIUS 服务器组的连接请求策略匹配时，就会发生这种情况。
