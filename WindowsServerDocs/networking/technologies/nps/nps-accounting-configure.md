---
title: 配置网络策略服务器记帐
description: 本主题提供有关文本的文件和 Windows Server 2016 中的网络策略服务器的身份登录的 SQL Server 信息。
manager: brianlic
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 69341e30d90ee1be29c40d835a4f71fe433c11dc
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2018
---
# <a name="configure-network-policy-server-accounting"></a>配置网络策略服务器记帐

有三种类型的网络策略服务器 \(NPS\) 日志记录：

- **事件日志记录**。 主要用于审核和疑难解答尝试连接。 您可以配置 NPS 事件通过获取 NPS 服务器属性在 NPS 控制台日志记录。

- **登录到本地文件的用户身份验证和记帐请求**。 主要用于连接分析和帐单目的。 此外有用安全调查工具因为它为您提供的攻击后跟踪恶意用户的活动的方法。 您可以配置使用记帐配置向导的本地文件日志记录。

- **用户身份验证和记帐请求用于登录 Microsoft SQL Server XML 兼容数据库**。 用于允许运行 NPS 有一个数据来源的多个服务器。 此外提供了使用关系数据库的优势。 你可以通过使用记帐配置向导配置 SQL Server 日志记录。

## <a name="use-the-accounting-configuration-wizard"></a>使用记帐配置向导

通过使用记帐配置向导中，您可以配置下面的四个会计设置：

- **SQL 仅日志记录**。 通过使用此设置，你可以配置指向允许 NPS 可连接到记帐数据发送到 SQL server SQL Server 的数据。 此外，该向导可以 SQL Server 以确保数据库 NPS SQL server 日志记录与兼容上配置数据库。
- **文本身份登录仅**。 通过使用此设置，你可以配置 NPS 登录到文本文件记帐数据。
- **并行日志记录**。 通过使用此设置，你可以配置的 SQL Server 数据链接和数据库。 你还可以配置文本，以便 NPS 到文本的文件和 SQL Server 数据库同时日志文件记录。 
- **SQL 日志记录与备份**。 通过使用此设置，你可以配置的 SQL Server 数据链接和数据库。 此外，您可以配置 NPS 使用如果 SQL Server 日志记录无法正常工作的文本文件日志记录。

除了这些设置，请 SQL Server 登录和文本登录允许你要指定 NPS 继续处理日志记录失败时的连接请求。 你可以指定这在**登录失败操作部分**本地文件日志记录属性，在 SQL server 日志记录属性，并且时你正在运行记帐配置向导中。

### <a name="to-run-the-accounting-configuration-wizard"></a>若要运行会计配置向导

若要运行配置向导中记帐，完成以下步骤：

1. 打开 NPS 主机或 NPS Microsoft 管理控制台 (MMC) 管理单元。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**记帐**，单击**配置记帐**。

## <a name="configure-nps-log-file-properties"></a>配置 NPS 日志文件属性

您可以配置网络策略 Server (NPS)，让其对用户身份验证请求、访问接受消息、访问拒绝消息、财务请求和响应和状态定期更新执行远程身份验证拨入用户服务 (RADIUS) 记帐。 你可以使用此过程来配置你希望存储的记帐数据日志文件。

有关解释日志文件的详细信息，请参阅[解释 NPS 数据库格式日志文件](https://technet.microsoft.com/library/cc771748.aspx)。

若要防止日志文件填写硬盘，强烈建议你从系统分区独立分区上保留它们。 下面提供了有关配置 NPS 记帐的详细信息：

- 若要发送被其他进程集锦日志文件数据，您可以配置 NPS 写入命名管道。 若要使用命名的管道，设置日志文件的文件夹，\\.\pipe 或 \\ComputerName\pipe。 命名的管道服务器程序创建命名的管道称为 \\.\pipe\iaslog.log 能够接收数据。 在本地文件的属性对话框中，在创建新的日志文件永远不会选择（无限制的文件大小）当你使用命名管道。

- 可以通过使用（而非用户变量），如 %系统驱动器 %、%系统根 %和 %windir%系统环境变量创建日志文件的目录。 例如，以下路径，并使用环境变量 %windir%，查找日志文件系统的目录在子文件夹 \System32\Logs (，即 %windir%\system32\logs\) 中。

- 切换日志文件格式不会创建新的日志。 如果你更改日志文件格式，更改的时间在处于活动状态的文件将包含多种的两个格式（开头的日志记录将具有以前的格式，并且在末尾日志记录将新格式）。

- 如果 RADIUS 记帐失败因完整硬盘驱动器或其他原因，NPS 停止处理连接申请、阻止访问网络资源的用户。

- NPS 提供能够登录到 Microsoft® SQL Server™ 数据库中补充或而不是，登录到本地文件。

在会员**域管理员**组是最低要求执行此过程。


### <a name="to-configure-nps-log-file-properties"></a>若要配置 NPS 日志文件属性

1. 打开 NPS 主机或 NPS Microsoft 管理控制台 (MMC) 管理单元。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**日志文件属性**，单击**更改日志文件属性**。 **日志文件属性**对话框中打开。
4. 在**日志文件属性**，在**设置**选项卡上，在**记录以下信息**，确保你选择要记录的信息不足以实现记帐目标。 例如，如果你日志需要完成会话相关性，选中所有复选框。
5. 在**日志记录失败操作**、选择**日志记录失败时，如果放弃连接请求**如果你希望 NPS 停止处理访问请求消息时日志文件出于某种原因是完整或不可用。 如果你想 NPS 继续处理连接请求日志记录失败时，不要未选中此复选框。
6. 在**日志文件属性**对话框中，单击**日志文件**选项卡。
7. 在**日志文件**选项卡上，在**目录**，键入你要存储 NPS 日志文件的位置的位置。 默认位置是 systemroot\System32\LogFiles 文件夹。
    >[!NOTE]
    >如果不提供的完整路径声明中**日志文件的目录**，将使用默认路径。 例如，如果你键入**NPSLogFile**中**日志文件的目录**，文件位于 %systemroot%\system32\npslogfile。
8. 在**格式**，单击**符合 DTS**。 如果你愿意，你可以改为选择旧的文件格式，如**ODBC \(Legacy\)**或**IAS \(Legacy\)**。
    >[!NOTE]
    >**ODBC**和**IAS**旧文件类型包含子集 NPS 会对其 SQL Server 数据库发送的信息。 **符合 DTS** XML 格式的文件类型等同于 NPS 使用数据导入其 SQL Server 数据库 XML 格式。 因此，**符合 DTS**文件格式为 NPS 提供更高效且完整数据传输到标准 SQL Server 数据库。
9. 在**创建新的日志文件**、配置 NPS 若要开始新的日志文件指定的时间间隔，请单击你想要使用的时间间隔：
    - 大量的交易音量和日志记录活动，请单击**每天**。
    - 较少的交易卷和日志记录活动，请单击**每周**或**每月**。
    - 若要将所有交易都存储在一个日志文件中，单击**从不 \(unlimited file size\)**。
    - 若要将每个日志文件大小限制，请单击**日志文件时达到此大小**，然后键入后，创建一个新日志文件大小。 默认大小 10 兆字节 (MB)。
10. 如果你想 NPS 删除旧的日志文件硬盘容量附近时创建新的日志文件的磁盘空间，确保**磁盘后完全删除旧的日志文件**选择。 但是，此选项不可用，如果值**创建新的日志文件**是**从不 \(unlimited file size\)**。 此外，如果古老日志文件当前日志文件，它不会删除。

## <a name="configure-nps-sql-server-logging"></a>配置 NPS SQL Server 日志记录

你可以使用此过程将 RADIUS 会计数据日志到运行 Microsoft SQL Server 本地或远程数据库。

>[!NOTE]
>NPS 格式记帐数据将发送到 XML 文档作为**report_event**存储在你 NPS 中指定的 SQL Server 数据库过程。 SQL server 身份登录才能正常工作，你必须存储名为过程**report_event**可以接收和分析从 NPS XML 文档的 SQL Server 数据库中。

会员域管理员或等效是的最低要求才能完成此过程。

### <a name="to-configure-sql-server-logging-in-nps"></a>若要配置登录 NPS SQL Server

1. 打开 NPS 主机或 NPS Microsoft 管理控制台 (MMC) 管理单元。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**SQL Server 记录属性**，单击**更改 SQL Server 记录属性**。 **SQL Server 记录属性**对话框中打开。
4. 在**记录以下信息**，选择你希望记录的信息： 
    - 若要登录所有记帐请求，请单击**记帐请求**。
    - 记录身份验证的请求，请单击**身份验证请求**。
    - 若要登录定期会计状态，请单击**定期会计状态**。
    - 若要登录定期状态，如中期记帐请求，请单击**定期状态**。
5. 若要配置并行会话之间运行的服务器 NPS 和 SQL Server 允许数，请键入的数字**并行会话的最大数目**。
6. 若要在配置的 SQL Server 数据来源，**SQL Server 日志记录**，单击**配置**。 **数据链接属性**对话框中打开。 在**连接**选项卡上，指定以下： 
    - 若要指定数据库存储在服务器的名称，键入，或选择中的一个名称**选择或输入服务器名称**。
    - 若要指定登录到服务器的身份验证方法，请单击**使用 Windows NT 集成安全**。 或者，请单击**使用特定的用户名和密码**，然后键入中的凭据**User name**和**密码**。
    - 若要允许空白的密码，请单击**空白密码**。
    - 若要保存的密码，请单击**允许保存密码**。
    - 若要指定的数据库，连接到运行 SQL Server 的计算机上，单击**选择服务器上的数据库**，然后从列表中选择数据库名称。
7. 若要测试 NPS 和 SQL Server 之间的连接，请单击**测试连接**。 单击**确定**关闭**数据链接属性**。
8. 在**日志记录失败操作**、选择**文本文件为启用日志记录故障转移**你是否希望 NPS 继续文本文件记录如果 SQL Server 日志记录无法正常工作。 
9. 在**日志记录失败操作**、选择**日志记录失败时，如果放弃连接请求**如果你希望 NPS 停止处理访问请求消息时日志文件出于某种原因是完整或不可用。 如果你想 NPS 继续处理连接请求日志记录失败时，不要未选中此复选框。

## <a name="ping-user-name"></a>Ping 用户名

某些 RADIUS 代理服务器和网络的访问权限服务器定期发送（也称为 ping 请求）的身份验证和帐户请求以验证 NPS 服务器出现在网络上。 这些 ping 请求包括虚构的用户名。 当 NPS 处理这些请求时，事件和记帐日志变得充满访问拒绝记录，使其更难以跟踪的有效的记录。

当您将配置的注册表项**ping 用户名**，NPS 由其他服务器匹配根据 ping 请求中的用户名称值的注册表项值。 一个**ping 用户名**注册表项指定虚构用户名（或多个用户名称模式中的，使用变量，虚构用户名相匹配）发送 RADIUS 代理服务器和网络的访问权限的服务器。 当 NPS 接收匹配的 ping 请求**ping 用户名**注册表项值，NPS 拒绝身份验证请求无处理请求。 NPS 不交易涉及虚构用户名在任何日志文件中，从而使更轻松地解释事件日志记录。

**Ping 用户名**未默认情况下安装。 你必须添加**ping 用户名**对注册表。 你可以使用注册表编辑器注册表添加条目。

>[!CAUTION]
>错误地编辑注册表可能严重损害你的系统。 更改注册表项之前，应备份在计算机上的所有重要数据。

### <a name="to-add-ping-user-name-to-the-registry"></a>若要添加对注册表 ping 用户名

Ping 用户名可以添加至以下注册表项字符串值为由的本地管理员组成员：

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **名称**: `ping user-name`
- **键入**: `REG_SZ`
- **数据**: *User name*

>[!TIP]
>指示多个用户名**ping 用户名**值，输入文件名模式，如 DNS 名称、通配符，包括中**数据**。
