---
title: 配置网络策略服务器记帐
description: 本主题提供有关文本文件和 SQL Server 日志记录，用于在 Windows Server 2016 中的网络策略服务器的信息。
manager: dougkim
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: pashort
author: shortpatti
ms.date: 05/25/2018
ms.openlocfilehash: c732a9f42d942ad579468d1dd15d30324d6fea87
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59839698"
---
# <a name="configure-network-policy-server-accounting"></a>配置网络策略服务器记帐

有三种类型的网络策略服务器的日志记录\(NPS\):

- **事件日志记录**。 主要用于审核和故障排除的连接尝试。 你可以配置 NPS 事件日志记录通过获取在 NPS 控制台中的 NPS 属性。

- **用户身份验证和记帐请求记录到本地文件**。 主要用于连接分析和计费目的。 此外可用作安全调查工具，因为它提供了一种攻击之后跟踪恶意用户的活动的方法。 你可以配置本地文件日志记录使用记帐配置向导。

- **用户身份验证和记帐请求记录到 Microsoft SQL Server 符合 XML 数据库**。 用于允许多个服务器运行 NPS 拥有一个数据源。 此外提供了使用关系数据库的优点。 可以通过使用记帐配置向导配置 SQL Server 日志记录。

## <a name="use-the-accounting-configuration-wizard"></a>使用记帐配置向导

使用记帐配置向导，可以配置以下四个记帐设置：

- **SQL 日志记录仅**。 通过使用此设置，可以配置允许 NPS 连接到并将记帐数据发送到 SQL server 的 SQL server 的数据链接。 此外，该向导可以配置数据库，以确保数据库 NPS SQL 服务器日志记录与兼容的 SQL Server 上。
- **文本日志记录仅**。 通过使用此设置，可以配置 NPS 将记帐数据记录到文本文件。
- **日志记录的并行**。 通过使用此设置，可以配置链接列出的 SQL Server 数据和数据库。 此外可以配置文本文件日志记录，以便 NPS 同时记录到文本文件和 SQL Server 数据库。 
- **使用备份的 SQL 日志记录**。 通过使用此设置，可以配置链接列出的 SQL Server 数据和数据库。 此外，您可以配置 NPS 使用 SQL Server 日志记录失败时的文本文件日志记录。

除了这些设置，SQL Server 日志记录和文本日志记录，可以指定 NPS 是否继续处理连接请求，如果登录失败。 您可以指定在此**日志记录失败操作部分**在本地文件日志记录属性中，在 SQL server 日志记录属性中，并在运行记帐配置向导。

### <a name="to-run-the-accounting-configuration-wizard"></a>若要运行记帐配置向导

若要运行记帐配置向导，完成以下步骤：

1. 打开 NPS 控制台或 NPS Microsoft 管理控制台 (MMC) 管理单元中。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**记帐**，单击**配置记帐**。

## <a name="configure-nps-log-file-properties"></a>配置 NPS 日志文件属性

可以配置网络策略服务器 (NPS) 执行远程身份验证拨入用户服务 (RADIUS) 的用户身份验证请求、 访问-接受消息、 访问-拒绝消息、 记帐请求和响应，记帐和定期状态更新。 此过程可用于配置想要将记帐数据存储的日志文件。

有关解释日志文件的详细信息，请参阅[解释 NPS 数据库格式日志文件](https://technet.microsoft.com/library/cc771748.aspx)。

若要防止日志文件填充硬盘驱动器，强烈建议将它们保留在系统分区分开的分区。 下面提供了有关配置 NPS 记帐的详细信息：

- 若要按另一个进程发送收集的日志文件数据，可以配置 NPS 要写入到命名管道。 若要使用命名的管道，请将日志文件文件夹设置为\\。 \pipe 或\\ComputerName\pipe。 命名的管道服务器程序将创建名为命名的管道\\.\pipe\iaslog.log 来接受数据。 在本地文件的属性对话框中，在创建新的日志文件，永远不会选择 （无限制的文件大小） 时使用命名管道。

- 可以通过使用系统环境变量 （而不是用户变量），如 %systemdrive%、 %systemroot%和 %windir%创建日志文件目录。 例如，在以下路径中，使用环境变量 %windir%，在子文件夹 \System32\Logs 中定位的系统目录的日志文件 (即，%windir%\System32\Logs\)。

- 切换日志文件格式不会导致创建新的日志。 如果更改日志文件格式，请在更改时处于活动状态的文件将包含混合使用这两种格式 （日志开始处的记录将具有以前的格式，和日志的结尾处的记录将具有新格式）。

- 如果 RADIUS 记帐因完整硬盘驱动器或其他原因而失败，则 NPS 将停止处理连接请求，从而阻止用户访问网络资源。

- NPS 提供的功能来记录到 Microsoft® SQL Server™ 数据库除此之外或代替，记录到本地文件。

中的成员身份**Domain Admins**组是执行此过程所需的最低要求。


### <a name="to-configure-nps-log-file-properties"></a>若要配置 NPS 日志文件属性

1. 打开 NPS 控制台或 NPS Microsoft 管理控制台 (MMC) 管理单元中。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**日志文件属性**，单击**更改日志文件属性**。 **日志文件属性**对话框随即打开。
4. 在中**日志文件属性**，然后在**设置**选项卡上，在**记录以下信息**，请确保选择要记录足够的信息来实现您记帐的目标。 例如，如果你的日志需要完成会话相关性，选中所有复选框。
5. 在中**日志记录失败操作**，选择**日志记录失败时，放弃连接请求**如果希望 NPS 时停止处理访问请求消息日志文件由于某种原因已满或者不可用。 如果要让 NPS 以继续处理连接请求日志记录失败时，则选择此复选框。
6. 在中**日志文件属性**对话框中，单击**日志文件**选项卡。
7. 上**日志文件**选项卡上，在**Directory**，键入你想要将 NPS 日志文件存储的位置。 默认位置为 systemroot\System32\LogFiles 文件夹。<br>如果未提供中的完整路径语句**日志文件目录**，使用默认路径。 例如，如果键入**NPSLogFile**中**日志文件目录**，该文件位于 %systemroot%\system32\npslogfile。
8. 在中**格式**，单击**DTS 符合**。 如果您愿意，您可以改为选择一种旧的文件格式，如**ODBC\(旧\)** 或**IAS\(旧\)**。<br>**ODBC**并**IAS**旧文件类型包含的 NPS 将发送到其 SQL Server 数据库的信息子集。 **DTS 符合**文件类型的 XML 格式等同于 NPS 使用数据导入到其 SQL Server 数据库的 XML 格式。 因此， **DTS 符合**文件格式为 NPS 提供更高效且完整的数据传输到标准的 SQL Server 数据库。
9. 在中**创建新的日志文件**，若要将 NPS 配置为启动位于指定的时间间隔的新日志文件中，单击你想要使用的时间间隔：
    - 对于大量事务处理卷和日志记录活动，单击**每日**。
    - 对于较小的事务量和日志记录活动，单击**每周**或**每月**。
    - 若要在一个日志文件中存储的所有事务，请单击**从不\(文件大小无限制\)**。
    - 若要限制每个日志文件的大小，请单击**在日志文件达到此大小时**，然后键入文件大小，此后创建新的日志。 默认大小为 10 兆字节 (MB)。
10. 如果您希望 NPS，以删除旧日志文件以创建新日志文件的磁盘空间，硬盘已接近容量上限时，确保**磁盘时已完全删除较旧的日志文件**处于选中状态。 但是，此选项不可用，如果的值**创建新的日志文件**是**Never\(文件大小无限制\)**。 此外，如果最早的日志文件是当前日志文件，它不会删除。

## <a name="configure-nps-sql-server-logging"></a>配置 NPS SQL 服务器日志记录

可以使用此过程，以将 RADIUS 记帐数据记录到运行 Microsoft SQL Server 的本地或远程数据库。

>[!NOTE]
>NPS 将记帐数据将发送到的 XML 文档格式设置为**report_event** NPS 中指定的 SQL Server 数据库中的存储过程。 对于 SQL Server 日志记录才能正常工作，您必须具有一个名为的存储的过程**report_event**可以接收和分析 XML 文档从 NPS 的 SQL Server 数据库中。

成员身份中 Domain Admins 或等效身份是完成此过程所需的最小。

### <a name="to-configure-sql-server-logging-in-nps"></a>若要配置 NPS 中的日志记录的 SQL Server

1. 打开 NPS 控制台或 NPS Microsoft 管理控制台 (MMC) 管理单元中。
2. 在控制台树中，单击**记帐**。
3. 在详细信息窗格中，在**SQL Server 日志记录属性**，单击**更改 SQL Server 日志记录属性**。 **SQL Server 日志记录属性**对话框随即打开。
4. 在中**记录以下信息**，选择想要记录的信息： 
    - 若要记录所有记帐请求，请单击**记帐请求**。
    - 若要记录身份验证请求，请单击**身份验证请求**。
    - 若要记录定期记帐状态，单击**定期记帐状态**。
    - 若要记录定期状态，如记帐过渡请求，请单击**定期状态**。
5. 若要配置运行 NPS 和 SQL Server 的服务器之间允许的并发会话数，请键入的数字**最大并发会话数**。
6. 若要在中配置 SQL Server 数据源， **SQL Server 日志记录**，单击**配置**。 **数据链接属性**对话框随即打开。 上**连接**选项卡上，指定以下内容： 
    - 若要指定在其中存储数据库的服务器的名称，键入或选择中的名称**选择或输入服务器名称**。
    - 若要指定用来登录到服务器的身份验证方法，请单击**使用 Windows NT 集成安全性**。 或者，单击**使用特定用户名和密码**，然后键入在凭据**用户名**并**密码**。
    - 若要允许使用空白密码，请单击**空密码**。
    - 若要存储的密码，请单击**允许保存密码**。
    - 若要指定要连接到运行 SQL Server 的计算机上的数据库，请单击**选择在服务器上的数据库**，然后从列表中选择数据库名称。
7. 若要测试 NPS 和 SQL Server 之间的连接，请单击**测试连接**。 单击**确定**以关闭**数据链接属性**。
8. 在中**日志记录失败操作**，选择**启用文本文件日志记录的故障转移**如果要让 NPS 用文本文件日志记录 SQL Server 日志记录失败时继续。 
9. 在中**日志记录失败操作**，选择**日志记录失败时，放弃连接请求**如果希望 NPS 时停止处理访问请求消息日志文件由于某种原因已满或者不可用。 如果要让 NPS 以继续处理连接请求日志记录失败时，则选择此复选框。

## <a name="ping-user-name"></a>Ping 用户-名称

某些 RADIUS 代理服务器和网络访问服务器定期发送身份验证和记帐请求 （称为 ping 请求） 来验证 NPS 在网络上存在。 这些 ping 请求包括虚构的用户名。 当 NPS 处理这些请求时，事件和记帐日志中填充访问拒绝记录，使得更难以跟踪的有效记录。

当你配置的注册表项**用户名称进行 ping 操作**，NPS 与 ping 请求中的用户名称值对的注册表条目值匹配的其他服务器。 一个**用户名称进行 ping 操作**注册表项指定了虚构的用户名 （或用户名称匹配的模式，使用变量，虚构的用户名） 发送的 RADIUS 代理服务器和网络访问服务器。 当 NPS 收到与匹配的 ping 请求**用户名称进行 ping 操作**的注册表条目值，则 NPS 拒绝身份验证请求而不会处理该请求。 NPS 不会记录涉及虚构用户名中的任何日志文件，因此可以轻松地解释事件日志的事务。

**用户名称进行 ping 操作**默认情况下不安装。 必须添加**用户名称进行 ping 操作**到注册表。 可以将条目添加到注册表使用注册表编辑器。

>[!CAUTION]
>不正确地编辑注册表可能会对系统造成严重损坏。 在更改注册表之前，应备份计算机上任何有价值的数据。

### <a name="to-add-ping-user-name-to-the-registry"></a>若要向注册表添加 ping 用户-名称

Ping 用户-名称可以作为添加到以下注册表项的字符串值由本地 Administrators 组的成员：

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **名称**: `ping user-name`
- **类型**: `REG_SZ`
- **数据**:*用户名称*

>[!TIP]
>若要指示多个用户名称**用户名称进行 ping 操作**值，请输入名称模式，如 DNS 名称，包括中的通配符字符**数据**。
