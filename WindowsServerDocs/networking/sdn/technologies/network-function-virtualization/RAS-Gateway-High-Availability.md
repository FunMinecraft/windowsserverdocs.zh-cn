---
title: RAS 网关高可用性
description: 可以使用本主题以了解 RAS 多租户网关的高可用性配置的软件定义网络 (SDN) Windows Server 2016 中。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 8ce515ceeb7ab6989ef18055f312983a6518a1a1
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59847758"
---
# <a name="ras-gateway-high-availability"></a>RAS 网关高可用性

>适用于：Windows 服务器 （半年频道），Windows Server 2016

可以使用本主题以了解 RAS 多租户网关的高可用性配置的软件定义网络 (SDN)。  
  
本主题包含以下部分。  
  
-   [RAS 网关概述](#bkmk_overview)  
  
-   [网关池概述](#bkmk_pools)  
  
-   [RAS 网关部署概述](#bkmk_deployment)  
  
-   [与网络控制器的 RAS 网关集成](#bkmk_integration)  
  
## <a name="bkmk_overview"></a>RAS 网关概述  
如果你的组织是云服务提供商 (CSP) 或企业与多个租户，则可以在多租户模式下以网络流量路由到和从虚拟和物理网络，包括 Internet 部署 RAS 网关。  
  
可以将 RAS 网关部署在多租户模式下，为边缘网关来路由租户客户网络流量，租户虚拟网络和资源。  
  
当部署多个提供高可用性和故障转移的 RAS 网关 Vm 实例时，要部署的网关池。 在 Windows Server 2012 R2，所有网关 Vm 构成单个池，这使得对网关部署的逻辑隔离有点困难。  Windows Server 2012 R2 网关提供网关 Vm，从而产生了未得到充分利用可用的容量用于站点到站点 (S2S) VPN 连接的 1 对 1 冗余部署。  
  
提供了多个网关池的可为不同类型的逻辑分隔的 Windows Server 2016 中已解决此问题。 M + N 冗余的新模式允许进行更高效的故障转移配置。  
  
有关 RAS 网关的详细概述信息，请参阅[RAS 网关](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)。  
  
## <a name="bkmk_pools"></a>网关池概述  
在 Windows Server 2016 中，可以部署中一个或多个池的网关。  
  
下图显示了不同类型的网关池提供虚拟网络之间路由流量。  
  
![RAS 网关池](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
每个池具有以下属性。  
  
-   每个池是 M + N 冗余。 这意味着，将按 n 键数备用网关 Vm 备份的活动网关 Vm 数。 N （备用网关） 的值始终为小于或等于 M （主动网关）。  
  
-   池可以执行的任何单个网关函数-Internet 密钥交换版本 2 (IKEv2) S2S、 第 3 层 (L3) 和通用路由封装 (GRE)-或池可以执行所有这些函数。  
  
-   您可以向所有池或池的子集分配单个公共 IP 地址。 这样可大大减少了必须使用的公共 IP 地址数，因为它是可能有连接到单个的 IP 地址上云的所有租户。 下面有关高可用性和负载平衡的一节介绍这的工作方式。  
  
-   您可以轻松调整网关池向上或向下通过添加或删除网关 Vm 的池中。 删除或添加的网关不会中断以池提供服务。 您还可以添加和删除整个池的网关。  
  
-   单个租户的连接可以终止多个池和池中的多个网关。 但是，如果某个租户有连接中的终止**所有**键入网关池，它不能与其他订阅**所有**类型或单个类型网关池。  
  
网关池还提供灵活性以支持其他方案：  
  
-   单租户池-可以创建一个池以供一个租户。  
  
-   如果销售合作伙伴 （经销商） 通道通过云服务时，可以为每个分销商创建单独的池集。  
  
-   多个池可以提供相同的网关功能，但不同的容量。 例如，可以创建支持高吞吐量和低吞吐量 IKEv2 S2S 连接的网关池。  
  
## <a name="bkmk_deployment"></a>RAS 网关部署概述  
下图演示了典型的云服务提供商 (CSP) 部署 RAS 网关。  
  
![RAS 网关部署概述](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
使用此类型的部署，网关池部署背后软件负载均衡器 (SLB)，从而使 CSP 将整个部署的单个公共 IP 地址。 租户的多个网关连接可以终止多个网关池的以及在池内的多个网关。 这通过在上面的图中，IKEv2 S2S 连接进行了说明，但这也适用于其他网关的函数，如 L3 和 GRE 网关。  
  
在图中，MT BGP 设备是 RAS 多租户网关使用 BGP。 多租户 BGP 用于动态路由。 租户的路由集中式-一个名为路由反射器 (RR) 的单个点、 处理的 BGP 对等互连对所有租户网站。 RR 本身分布在池中的所有网关。 这会导致在租户 （数据路径） 的连接终止多个网关，但在 RR 中查找租户 （BGP 对等点的控制路径） 很上只有一个网关的配置。  
  
BGP 路由器在关系图以描述此集中式路由概念分离。 网关 BGP 实现还提供的传输路由，可让云来充当两种租户站点之间路由的传输点。 这些 BGP 功能都适用于网关的所有函数。  
  
## <a name="bkmk_integration"></a>与网络控制器的 RAS 网关集成  
与 Windows Server 2016 中的网络控制器完全集成 RAS 网关。 部署 RAS 网关和网络控制器时，网络控制器可以执行以下函数。  
  
-   网关池的部署  
  
-   在每个网关的租户连接的配置  
  
-   在网关出现故障时切换的网络流量流到备用网关  
  
以下部分提供有关 RAS 网关和网络控制器的详细的信息。  
  
-   [预配和负载平衡的网关连接 （IKEv2、 L3 和 GRE）](#bkmk_provisioning)  
  
-   [IKEv2 S2S 的高可用性](#bkmk_ike)  
  
-   [GRE 的高可用性](#bkmk_gre)  
  
-   [转发网关的 L3 的高可用性](#bkmk_l3)  
  
### <a name="bkmk_provisioning"></a>预配和负载平衡的网关连接 （IKEv2、 L3 和 GRE）  
当租户请求的网关连接时，请求将发送到网络控制器。 网络控制器使用网关池，其中每个池和每个网关的容量包括在每个池的所有信息进行配置。 网络控制器选择正确的池和网关连接。 此选择取决于连接的带宽需求。 网络控制器使用"best fit"算法在池中高效地选择连接。 如果这是租户的第一个连接这一次还指定连接的 BGP 对等点。  
  
网络控制器选择 RAS 网关连接后，网络控制器预配所需的配置为在网关连接。 如果连接是 IKEv2 S2S 连接，网络控制器还将预配 SLB 池; 上的网络地址转换 (NAT) 规则SLB 池上的此 NAT 规则将定向到指定的网关的连接请求来自租户。 按源 IP，这应是唯一的租户进行区分。  
  
> [!NOTE]  
> L3 和 GRE 连接绕过 SLB，直接与指定 RAS 网关连接。  这些连接要求，远程终结点路由器 （或其他第三方设备） 必须将正确配置为使用 RAS 网关连接。  
  
如果为连接启用 BGP 路由则 RAS 网关的 BGP 对等互连启动并且在本地和云之间交换路由网关。 了解通过 BGP （或如果未使用 BGP 的是静态配置的路由） 的路由发送到网络控制器。 然后，网络控制器检测到的租户 Vm 已安装的 HYPER-V 主机的路由。 此时，可将租户流量路由到正确的本地站点。 网络控制器还会创建关联的 HYPER-V 网络虚拟化策略，指定网关的位置，并检测其下的 HYPER-V 主机。  
  
### <a name="bkmk_ike"></a>IKEv2 S2S 的高可用性  
RAS 网关在池中包含连接和 BGP 对等互连的不同的租户。 每个池具有是主动网关和 n 个备用网关。  
  
网络控制器可按以下方式处理失败的网关。  
  
-   网络控制器不断地 ping 的网关在所有池，可以检测失败的网关或失败。 网络控制器可以检测到以下类型的 RAS 网关故障。  
  
    -   RAS 网关 VM 失败  
  
    -   失败的 RAS 网关正在运行的 HYPER-V 主机  
  
    -   RAS 网关服务失败  
  
    网络控制器存储所有已部署的活动网关的配置。 配置包含连接设置和路由设置。  
  
-   当网关失败时，它会影响在网关上，租户连接，以及租户连接位于其他网关，但其 RR 驻留在失败的网关。 后一种连接的停机时间小于前者。 当网络控制器检测到失败的网关时，它将执行以下任务。  
  
    -   从计算主机中删除受影响的连接的路由。  
  
    -   会删除这些主机上的 HYPER-V 网络虚拟化策略。  
  
    -   选择备用网关，将其转换到活动的网关，并将网关配置。  
  
    -   更改为点到新网关连接在 SLB 池上的 NAT 映射。  
  
-   同时，由于配置提供新活动网关上，IKEv2 S2S 连接和 BGP 对等互连都是重新建立。 可由云网关或本地网关启动的连接和 BGP 对等互连。 网关刷新其路由，并将其发送到网络控制器。 网络控制器了解发现的网关的新路由后，网络控制器将发送的路由和关联的 HYPER-V 网络虚拟化策略到 HYPER-V 主机受故障影响租户的 Vm 所在的位置。 此网络控制器活动是类似到一个新的连接设置的情况下，只会出现在较大的规模。  
  
### <a name="bkmk_gre"></a>GRE 的高可用性  
RAS 网关故障转移响应由网络控制器-包括故障检测、 复制连接将路由到备用网关的 BGP 或静态路由的受影响的连接的故障转移配置的过程 (包括取款和上的路由的重新传输设备计算主机和 BGP 重新对等互连），并在计算主机-HYPER-V 网络虚拟化策略的重新配置是相同的 GRE 网关和连接。 GRE 连接重新建立连接，会发生情况以不同的方式，但是，和 GRE 的高可用性解决方案有一些额外要求。  
  
![GRE 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
网关部署时，RAS 网关的每个 VM 分配动态 IP 地址 (DIP)。 此外，每个网关 VM 还分配 GRE 高可用性虚拟 IP 地址 (VIP)。 仅对中的可接受 GRE 连接，应用程序池的网关而不适用于非 GRE 池分配 Vip。 分配的 Vip 会播发到架顶式 (TOR) 交换机使用 BGP，然后进一步将 Vip 公布到云的物理网络上。 这样，网关可访问远程路由器或第三方设备中的 GRE 连接另一端所在的位置。 此 BGP 对等互连与不同的租户级别 BGP 对等租户路由交换。  
  
在预配 GRE 连接的时，网络控制器选择网关、 配置 GRE 终结点上所选网关，并返回已分配网关的 VIP 地址。 此 VIP 然后配置为目标远程路由器上的 GRE 隧道地址。  
  
当网关失败时，网络控制器将失败的网关和其他配置数据的 VIP 地址复制到备用网关。 当备用网关变为活动状态时，它播发到其 TOR 交换机 VIP 并进一步到物理网络。 远程路由器继续连接到同一个 VIP 的 GRE 隧道和路由基础结构可确保数据包都路由到新活动网关。  
  
### <a name="bkmk_l3"></a>转发网关的 L3 的高可用性  
HYPER-V 网络虚拟化 L3 转发网关是在数据中心的物理基础结构和 HYPER-V 网络虚拟化云中虚拟化基础结构之间的桥梁。 在多租户的 L3 转发网关，每个租户具有租户的物理网络的连接，使用其自身 VLAN 标记的逻辑网络。  
  
当新租户创建新的 L3 网关时，网络控制器网关服务管理器中选择可用的网关 VM，并使用高度可用的客户地址 (CA) 空间 IP 地址 （从租户的 VLAN 标记的逻辑网络配置新租户接口). IP 地址用作对等节点 IP 地址上远程 （物理网络） 网关，并在下一步的跃点来访问租户的 HYPER-V 网络虚拟化网络。  
  
IPsec 和 GRE 网络与连接不同，TOR 交换机将不了解租户的 VLAN 标记的网络动态。 需要在 TOR 交换机和所有中间交换机和物理基础结构和网关以确保端到端连接之间的路由器上配置网络的路由租户的 VLAN 标记。  下面是示例 CSP 虚拟网络配置下, 图中所示。  
  
|网络|子网|VLAN ID|默认网关|  
|-----------|----------|-----------|-------------------|  
|Contoso L3 逻辑网络|10.127.134.0/24|1001|10.127.134.1|  
|Woodgrove L3 逻辑网络|10.127.134.0/24|1002|10.127.134.1|  
  
以下是示例租户网关配置下, 图中所示。  
  
|租户名称|L3 网关 IP 地址|VLAN ID|对等节点 IP 地址|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|Woodgrove|10.127.134.60|1002|10.127.134.65|  
  
以下是这些配置的 CSP 数据中心中的说明。  
  
![转发网关的 L3 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
网关故障、 故障检测和网关故障转移过程的 L3 转发网关的上下文中是类似于 IKEv2 和 GRE RAS 网关的过程。 差异是中的外部 IP 地址的处理的方式。  
  
当网关 VM 状态变为不正常时，网络控制器从池中选择一个备用网关，并重新预配的网络连接和路由上的备用网关。 而移动连接，L3 转发网关的高可用 CA 空间的 IP 地址也会移到新网关 VM，以及租户在 CA 空间 BGP IP 地址。  
  
L3 对等互连的 IP 地址在故障转移期间移动到新网关 VM，因为远程物理基础结构也可以连接到此 IP 地址，并随后，到达的 HYPER-V 网络虚拟化工作负荷。 为 BGP 动态路由，BGP IP 地址移到新网关 VM，在 CA 空间作为远程 BGP 路由器可以重新建立对等互连，并再次了解所有的 HYPER-V 网络虚拟化路由。  
  
> [!NOTE]  
> 必须单独配置以便使用 VLAN 标记的逻辑网络进行租户通信 TOR 交换机和所有中间路由器。 此外，L3 故障转移仅限于这种方式中配置的机架。 因此，必须谨慎配置 L3 网关池而必须单独完成手动配置。  
  


