---
title: "用户帐户控制的工作原理"
description: "Windows Server 安全"
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: security-tpm
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: da83ddb2-6182-417c-aa8e-0b47b2e17d13
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: 7f5ad234959ebfe0687b8bc10f9e43f2092252f2
ms.sourcegitcommit: 583355400f6b0d880dc0ac6bc06f0efb50d674f7
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/17/2017
---
# <a name="how-user-account-control-works"></a>用户帐户控制的工作原理

>适用于：Windows Server（半年通道），Windows Server 2016

用户帐户控制 (UAC) 从破坏计算机的帮助阻止恶意程序 （也称为恶意软件），并且有助于组织部署更易于管理的桌面。 UAC，请与应用程序和任务始终上下文中运行安全非管理员帐户，除非管理员专门授予访问系统管理员级别。 UAC 可以阻止未经授权的应用程序的自动安装，并且避免意外更改的系统设置。

## <a name="uac-process-and-interactions"></a>UAC 进程和交互
每个应用程序需要管理员访问令牌必须提示同意的情况下的管理员。 一个例外情况是家长和孩子之间存在进程的关系。 孩子进程将文件从家长进程沿用文件的用户访问标记。 但是，家长和孩子进程，必须具有相同的完整性级别。 Windows Server 2012 保护标记其完整性级别的进程。 完整性级别是信任度量单位。 "高"完整性应用程序是一种执行修改系统的数据，如磁盘分区时完整性"低"应用是执行可能具有潜在危害操作系统，如 Web 浏览器的任务的应用程序的任务。 完整性级别较低的应用程序无法修改具有较高的完整性级别的应用程序中的数据。 当尝试运行的应用程序需要管理员访问令牌标准的用户时，UAC 需要用户提供有效的管理员凭据。

为了更好地了解如何此过程发生务必查看 Windows Server 2012 登录进程的详细信息。

### <a name="windows-server-2012-logon-process"></a>Windows Server 2012 登录过程
下图说明 administrator 身份登录过程标准用户登录过程从之间的区别。

![演示如何 administrator 身份登录过程不同从登录过程标准用户的图示](../media/How-User-Account-Control-Works/UACWindowsLogonProcess.gif)

默认情况下，用户标准和管理员访问资源和标准用户的安全环境中运行的应用程序。 当用户登录到计算机时，系统创建访问该用户的标记。 访问标记包含有关该用户授予，包括特定安全标识符 (Sid) 和 Windows 权限的访问权限的级别信息。

当以管理员身份登录时，将两个独立的访问标记创建用户： 标准用户访问令牌以及管理员访问标记。 标准用户访问令牌包含相同的用户特定信息的管理员访问标记，但管理 Windows 权限和 Sid 被删除。 标准用户访问令牌用于启动无法执行管理任务 （标准用户应用程序） 的应用。 然后，标准用户访问令牌用于显示桌面 (Explorer.exe)。 Explorer.exe 是从中其他所有用户启动的进程文件沿用都文件他们访问令牌家长过程。 这样一来，除非用户提供同意的情况下，或者要允许的应用程序使用完全管理权限令牌凭据，以标准用户将运行所有应用。

是管理员组成员的用户可以登录，在浏览 Web，以及使用标准用户访问令牌时阅读电子邮件。 管理员需要执行的任务自动需要管理员访问令牌，Windows Server 2012 提示批准的用户。 此提示称为提升提示，并且可以使用本地安全策略管理单元 (Secpol.msc) 或组策略进行配置其行为。

> [!NOTE]
> 术语"提升"用于在 Windows Server 2012 提示用户的同意，或使用完整管理员访问标记的凭据过程，请参考。

### <a name="the-uac-user-experience"></a>UAC 用户体验
UAC 处于启用状态，当标准用户的用户体验是管理员审核模式中管理员不同。 运行 Windows Server 2012 的推荐且更安全的方法是为了让你主要的用户帐户标准用户帐户。 有助于最大化安全于托管的环境运行作为标准用户。 使用内置的 UAC 提升组件、 标准用户可以轻松地通过的本地管理员帐户中输入有效的凭据即可执行的管理任务。 默认情况下，为标准用户内置 UAC 提升组件是凭据提示。

除了标准的用户以管理员审核模式中管理员身份运行运行。 使用内置 UAC 提升组件的本地管理员组成员可以轻松地执行通过提供批准的管理任务。 默认情况下，为管理员帐户，管理员审核模式中的内置 UAC 提升组件被称为同意提示。 可以通过使用本地安全策略管理单元 (Secpol.msc) 或组策略配置 UAC 海拔提示行为。

**同意和凭据提示**

UAC 启用，Windows Server 2012 询问您同意或启动的程序或需要完全管理员访问令牌任务之前输入的有效的本地管理员帐户凭据提示。 此提示确保可以自行安装任何恶意软件。

**同意提示**

当用户尝试执行的任务需要用户管理访问令牌显示同意提示。 以下是 UAC 同意提示的屏幕快照。

![UAC 同意提示的屏幕截图](../media/How-User-Account-Control-Works/UACConsentPrompt.gif)

**凭据提示**

标准用户尝试执行的任务需要用户管理访问令牌时显示的凭据提示。 可以通过使用本地安全策略管理单元 (Secpol.msc) 或组策略配置此标准用户默认提示行为。 管理员可以还需要提供他们的凭据通过设置用户帐户控制： 提升提示管理员审核模式策略设置提示符下输入凭据值的行为。

下面的屏幕截图是一种 UAC 凭据提示。

![屏幕截图显示 UAC 凭据提示它的一个示例](../media/How-User-Account-Control-Works/UACCredentialPrompt.gif)

**UAC 提升提示**

UAC 提升提示进行标记，以将应用程序的特定的应用程序的安全隐患直接标识为启用。 当尝试使用管理员的完全访问权限令牌运行的应用程序时，Windows Server 2012 首先分析确定其发布者的可执行文件。 应用程序可首先分为根据可执行文件的发布者的三个类别: （登录） 时，Windows Server 2012、 已验证的发布者并且未验证的发布者 （无符号）。 下图说明如何在 Windows Server 2012 确定哪些颜色提升提示，以向用户显示。

提升提示色标如下所示：

-   红色隐私保护图标的红底： 应用程序已由组策略阻止或来自被阻止的发布者。

-   蓝色后台隐私保护蓝色和金会员图标： 应用程序是 Windows Server 2012 管理应用程序，如控制面板项。

-   蓝色后台蓝色隐私保护图标： 应用程序已签名通过验证码，并受信任的本地计算机。

-   黄色后台黄色隐私保护图标： 应用程序未签名或登录，但尚未不受本地计算机。

**隐私保护图标**

某些控制面板项，如**日期和时间属性**，包含管理员和标准用户操作的组合。 标准用户可以查看时钟和更改时区，但这必需完全管理员访问令牌更改系统本地时间。 下面是的屏幕快照**日期和时间属性**控制面板项。

![屏幕截图显示 * * 日期和时间属性 * * 控制面板项](../media/How-User-Account-Control-Works/UACShieldIcon.gif)

隐私保护图标**更改日期和时间**按钮中指示过程需要完全管理员访问标记，并且将显示一个 UAC 海拔提示。

**保护提升提示**

将定向到安全桌面提示符进一步保护提升过程。 默认情况下在 Windows Server 2012 安全桌面上显示同意和凭据提示。 仅 Windows 进程可以访问桌面安全。 对于安全程度更高版本，我们建议将保持**用户帐户控制： 提升提示时，切换到安全桌面**策略设置支持。

在提升请求时可执行文件，交互式的桌面，也称为用户桌面中，切换到安全桌面。 安全桌面变暗用户桌面，并显示必须在继续之前回应提升提示。 当用户单击是或不需要，桌面切换回用户桌面。

可以将恶意软件提供安全的桌面中，但的用户帐户控制模仿： 行为管理员管理员审核模式策略设置以提升提示设同意提示符、 恶意软件的不能提升，如果用户模仿上单击是。 如果的策略设置设置为提示符下输入凭据，模仿凭据提示符恶意软件可能能够从用户收集的凭据。 但是，恶意软件的不能特权提升了权限和其他减少恶意软件，从拍摄控制的用户界面，甚至是使用已获取密码的保护功能时，系统仍。

恶意软件可能存在安全桌面上的模仿，而不能出现此问题，除非用户以前安装到计算机上的恶意软件。 因为进程需要管理员访问令牌悄悄无法安装更新 UAC 启用时，用户显式必须方法是依次单击提供同意**是**或通过提供管理员凭据。 UAC 提升提示特定行为方式取决于组策略。

## <a name="uac-architecture"></a>UAC 建筑
下图详细介绍 UAC 体系结构。

![详细说明 UAC 体系结构的图示](../media/How-User-Account-Control-Works/UACArchitecture.gif)

若要更好地了解每个组件，请参阅下表：

|组件|描述|
|-------|--------|
|**用户**||
|用户执行需要特权操作|如果该操作将更改文件系统或注册表，称为虚拟化。 其他所有操作都呼叫 ShellExecute。|
|ShellExecute|ShellExecute 调用 CreateProcess。 从 CreateProcess ShellExecute 寻找 ERROR_ELEVATION_REQUIRED 错误。 如果它收到错误，ShellExecute 调用尝试执行提升了权限的提示与该请求的任务的应用程序的信息服务。|
|CreateProcess|如果应用程序需要提升，CreateProcess 拒绝 ERROR_ELEVATION_REQUIRED 的呼叫。|
|**系统**||
|应用程序的信息的服务|系统服务，可帮助需要一个或多个高的特权或用户权限才能运行，请本地的管理任务，如的开始应用程序和应用程序需要更高版本完整性级别。 用户提供同意此类应用程序通过提升，则需要和 （具体取决于组策略） 与非管理员用户的完全访问标记创建一个新的应用程序的进程的应用程序的信息服务帮助开始执行此操作。|
|提升 ActiveX 安装|如果未安装 ActiveX，系统将检查 UAC 滑块级别。 如果已安装 ActiveX，**用户帐户控制： 提升提示时，切换到安全桌面**将检查组策略设置。|
|检查 UAC 滑块级别|UAC 现在有可供选择的通知以及滑块以选择通知级别使用的四个级别：<br /><br /><ul><li>高<br /><br />    如果滑块已设置为**始终通知**，系统将检查是否已启用安全桌面。</li><li>中等<br /><br />    如果滑块已设置为**默认通知我仅当程序尝试更改我的计算机**、**用户帐户控制： 仅提升可执行文件登录并验证**将检查策略设置：<br /><br /><ul><li>如果已启用的策略设置，它允许运行之前，是给定的可执行文件强制公共基础结构 (PKI) 认证路径验证。</li><li>如果不是策略设置支持 （默认），给定的可执行文件允许运行之前，不强制执行 PKI 认证路径验证。 **用户帐户控制： 提升提示时，切换到安全桌面**将检查组策略设置。</li></ul></li><li>低<br /><br />    如果滑块已设置为**程序尝试更改我的电脑时，仅提醒我 （执行不变暗的桌面上）**，称为 CreateProcess。</li><li>从不通知<br /><br />    如果滑块已设置为**永远不会通知我时**，当尝试安装或尝试在计算机上进行任何更改程序时，UAC 提示将从不通知。 **重要提示：**不建议使用此设置。 此设置已设置为相同**用户帐户控制： 行为管理员审核模式中管理员提升提示**到的策略设置**提升而不会提示**。</li></ul>|
|启用安全桌面|**用户帐户控制： 提升提示时，切换到安全桌面**将检查策略设置：<br /><br />-如果已启用安全桌面，所有提升请求都进入安全桌面无论提示行为管理员和标准用户的策略设置。<br />-如果安全的桌面上未启用所有提升请求都转到交互用户的桌面，然后便会使用管理员和标准用户的每位用户设置。|
|CreateProcess|CreateProcess 调用 AppCompat、 合成，并安装程序检测，如果该应用程序需要提升评估。 然后检查可执行文件，以确定其请求的执行级别，其中存储在可执行文件的应用程序清单。 CreateProcess 失败如果清单中指定的请求的执行级别不符访问标记，并返回到 ShellExecute 错误 (ERROR_ELEVATION_REQUIRED)。 |
|AppCompat|AppCompat 数据库中的应用程序兼容性修复项应用程序存储的信息。|
|合成|合成数据库存储从应用清单，用于描述应用程序的信息。 更新的清单模式添加了新的请求的执行级别字段。|
|安装程序检测|安装程序检测检测到设置可执行文件，这有助于防止无法运行的用户不知情和同意情况下安装。|
|**内核**||
|虚拟化|虚拟化技术确保，不兼容的应用程序不悄悄会失败运行或无法的方式，无法确定原因。 文件和注册表虚拟化和写入受保护的领域的应用程序的日志，还提供了 UAC。|
|系统文件和注册表|每个用户文件和注册表虚拟化重定向到的位置相当每个用户每台计算机注册表和文件写入请求。 朗读请求重定向到每个用户虚拟化的位置首先并为每台计算机位置秒。|

可在 Windows Server 2012 UAC 从上一个 Windows 版本的更改。 新滑块永远不会将 UAC 完全关闭。 将新的设置：

-   保留 UAC 服务正在运行。

-   原因所有提升都请求由管理员不显示 UAC 提示中能已批准的自动启动。

-   自动拒绝标准用户的所有提升请求。

> [!IMPORTANT]
> 必须以完全禁用 UAC 禁用策略**用户帐户控制： 以管理员审核模式运行所有管理员**。

> [!WARNING]
> 当 UAC 已禁用 Windows Server 2012 不能定制的应用程序。

### <a name="virtualization"></a>虚拟化
因为企业环境中的系统管理员尝试安全系统，旨在使用仅标准用户访问令牌许多业务线 (LOB) 应用程序。 因此，IT 管理员不需要更换大多数应用程序时启用 UAC 与运行 Windows Server 2012。

 Windows Server 2012 包括不是兼容 UAC 和程序需要管理员访问令牌正确运行的应用程序的文件和注册表虚拟化技术。 虚拟化确保甚至不是 UAC 兼容的应用程序与 Windows Server 2012 兼容。 管理应用程序不是兼容 UAC 尝试写入受保护的目录，如 Program Files 时 UAC 为应用程序的资源尝试更改自己虚拟化的视图。 用户配置文件中语言维护虚拟化的副本。 此策略创建单独的每位用户运行不兼容的应用程序虚拟化文件的副本。

大多数应用程序任务使用虚拟化功能正常工作。 尽管虚拟化中使大部分运行的应用程序，它是短期的修补程序，并不的长期解决方法。 应用程序开发人员应修改它们为与 Windows Server 2012 徽标计划尽快，兼容，而不是依赖对文件、 文件夹和注册表虚拟的应用。

虚拟化不是在以下情况下的选项：

1.  提升并运行使用完全管理访问令牌应用程序虚拟化不适用于。

2.  虚拟化支持仅 32 位应用程序。 非提升 64 位的应用程序只需收到时，它们尝试获取到 Windows 对象句柄 （唯一标识符） 拒绝消息访问。 原始 Windows 64 位的应用程序都需要能够与 UAC 兼容，并将数据写入正确位置。

3.  如果应用程序包含应用程序使用的请求的执行级别属性清单虚拟化禁用应用程序。

### <a name="request-execution-levels"></a>请求执行级别
应用清单是来说明和识别的应用程序在运行时应绑定到共享和专用是并排集 XML 文件。 在 Windows Server 2012 应用程序清单包括 UAC 应用程序的兼容性用途的条目。 管理应用程序包含一项应用程序清单提示用户输入该用户的访问权限令牌的访问权。 虽然它们缺少清单应用程序中的某个条目，大多数管理应用可以使用应用程序兼容性修复的运行原样。 应用程序兼容性的修复程序是支持未 UAC 符合才能正常工作的 Windows Server 2012 应用程序的数据库条目。

所有 UAC 兼容的应用程序应该都已添加到应用程序清单请求的执行级别。 如果应用程序需要管理员系统的访问权限，参与请求执行与应用程序的"需要管理员"级别确保系统标识为管理应用程序此计划，并执行必要提升步骤。 请求的执行级别指定特权所需的应用程序。

### <a name="installer-detection-technology"></a>安装程序检测技术
安装程序都设计为部署软件应用程序。 大多数安装程序写入目录系统和注册表项。 这些受保护的系统位置是通常只能由管理员中安装程序检测技术，这意味着标准用户没有足够的访问权限，安装程序可写的。 Windows Server 2012 启发式检测到以运行的访问权限的安装程序和请求管理员凭据或从管理员用户批准。 Windows Server 2012 启发还式检测更新和卸载应用程序的程序。 UAC 的设计的目标之一是以防止安装无法用户的不知情的情况下运行，并同意因为安装程序写入受保护的文件系统和注册表的区域。

安装程序检测仅适用于：

-   32 位可执行文件。

-   如果没有请求的执行级别特性应用程序。

-   UAC 启用了运行为标准用户交互式的进程。

创建 32 位进程之前，进行检查以下属性，以确定是否安装程序：

-   文件名包括关键字，如"安装时，""设置"或"更新"。

-   版本资源字段包含以下关键字： 供应商、 公司名称、 产品名称、 文件描述、 原来的文件名、 内部名称、 和导出名称。

-   中并排放置清单的关键字嵌入在可执行文件。

-   特定 StringTable 项中的关键字链接可执行文件中。

-   在资源脚本数据的关键特性链接可执行文件中。

-   有字节可执行文件中的目标的序列。

> [!NOTE]
> 关键字和序列的字节来自从常见从各种 installer 技术观察到的特征。

> [!NOTE]
> 用户帐户控制： 检测安装应用程序，并提升策略设置必须启用安装程序检测安装程序的提示。 此设置默认处于启用状态和可以本地通过使用本地安全策略管理单元 (Secpol.msc) 配置或通过组策略 (Gpedit.msc) 配置的域或特定组。


