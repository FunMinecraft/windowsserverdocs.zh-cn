---
title: 步骤 3 配置负载平衡群集
description: 本主题是指南的在 Windows Server 2016 中的群集中部署远程访问的一部分。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology:
- networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: f000066e-7cf8-4085-82a3-4f4fe1cb3c5c
ms.author: pashort
author: shortpatti
ms.openlocfilehash: f835e27a80e661ff1f066af4779bd7c033cddc99
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/31/2019
ms.locfileid: "66446620"
---
# <a name="step-3-configure-a-load-balanced-cluster"></a>步骤 3 配置负载平衡群集

>适用于：Windows 服务器 （半年频道），Windows Server 2016

为群集准备服务器之后, 配置单个服务器上的负载平衡、 配置所需的证书，并部署群集。  
  
|任务|描述|  
|----|--------|  
|[3.1 配置的 IPv6 前缀](#BKMK_Prefix)|如果企业环境为 IPv4 + IPv6 或仅支持 IPv6，然后在单个远程访问服务器上，确保分配给 DirectAccess 客户端计算机的 IPv6 前缀足以涵盖所有在群集中的服务器。|  
|[3.2 启用负载平衡](#BKMK_NLB)|启用单个远程访问服务器上进行负载均衡。|  
|[3.3 安装的 IP-HTTPS 证书](#BKMK_InstallIPHTTP)|在群集中的每个服务器需要服务器证书的 IP-HTTPS 连接进行身份验证。  从单个远程访问服务器中导出的 IP-HTTPS 证书并将其部署在要添加到群集的每个服务器上。 这是必需的仅当使用自签名证书。|  
|[3.4 安装网络位置服务器证书](#BKMK_NLS)|如果将这台服务器具有网络位置服务器部署在本地，你将需要部署在群集中每个服务器上的网络位置服务器证书。 如果网络位置服务器托管在外部服务器上，每个服务器上的证书不是必需的。 这是必需的仅当使用自签名证书。|  
|[3.5 将服务器添加到群集](#BKMK_Add)|将所有服务器都添加到群集。 不能在要添加的服务器上配置远程访问。|  
|[3.6 从群集中删除服务器](#BKMK_remove)|从群集中删除服务器的说明。|  
|[3.7 禁用负载平衡](#BKBK_disable)|禁用负载平衡的说明。|  
  
> [!NOTE]  
> DIP 为选择的 IP 地址不能在群集中的第一个远程访问服务器的网络适配器上使用。 开始 DirectAccess 部署与 VIP 和 DIP 添加到网络适配器将导致失败。  
  
> [!NOTE]  
> 请确保不使用网络上的另一台计算机已存在一个 DIP。  
  
## <a name="BKMK_Prefix"></a>3.1 配置的 IPv6 前缀  
  
### <a name="configDA"></a>若要配置前缀  
  
1.  在远程访问服务器上，单击**启动**，然后单击**远程访问管理**。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在远程访问管理控制台中，单击“配置”  。  
  
3.  在控制台中，在中间窗格中**步骤 2 DirectAccess 服务器**区域中，单击**编辑**。  
  
4.  单击**前缀配置**。 上**前缀配置**页上，在**分配给 DirectAccess 客户端计算机的 IPv6 前缀**，输入用于子网长度为 59，例如，DirectAccess 客户端计算机的 IPv6 前缀**2001:db8:1:1000:: / 59**。 如果 VPN 已还启用了 IPv6，则会显示 IPv6 前缀，并且子网长度将需要更改到 59 之间。 单击“下一步”  。  
  
5.  在控制台的中间窗格中，单击**完成**。  
  
6.  上**远程访问评审**对话框中，查看配置设置，然后单击**应用**。 在 **“应用远程访问设置向导设置”** 对话框中，单击 **“关闭”** 。  
  
## <a name="BKMK_NLB"></a>3.2 启用负载平衡  
  
#### <a name="to-enable-load-balancing"></a>若要启用负载平衡  
  
1.  在配置 DirectAccess 服务器上，单击**启动**，然后单击**远程访问管理**。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在远程访问管理控制台中，在左窗格中，单击**配置**，然后在**任务**窗格中，单击**启用负载平衡**。  
  
3.  启用负载平衡向导中，单击**下一步**。  
  
4.  根据您所选择的规划步骤：  
  
    1.  Windows NLB:上**负载平衡方法**页上，单击**使用 Windows 网络负载平衡 (NLB)** ，然后单击**下一步**。  
  
    2.  外部负载均衡器：上**负载平衡方法**页上，单击**使用外部负载均衡器**，然后单击**下一步**。  
  
5.  在单个网络适配器部署中，在**专用 IP 地址**页上，执行以下操作，并单击**下一步**:  
  
    1.  在中**IPv4 地址**框中，输入此远程访问服务器的新的 IPv4 地址; 当前 IPv4 地址将是负载平衡群集虚拟 IP 地址 (VIP)。 在中**子网掩码**框中，输入子网掩码。  
  
    2.  如果企业环境为本机 IPv6，则在**IPv6 地址**框中，输入此远程访问服务器的新的 IPv6 地址; 当前 IPv6 地址将是负载平衡群集的 VIP。 在中**子网前缀长度**框中，输入子网前缀长度。  
  
6.  两个网络适配器的部署，在**外部的专用 IP 地址**页上，执行以下操作，并单击**下一步**:  
  
    1.  在中**IPv4 地址**框中，输入此远程访问服务器的新的外部 IPv4 地址; 当前 IPv4 地址将是群集的负载均衡的虚拟 IP 地址 (VIP)。 在中**子网掩码**框中，输入子网掩码。  
  
    2.  如果有当前本机中配置的远程访问服务器面向 internet 的网络适配器上的 IPv6 地址**IPv6 地址**框中，输入新的外部 IPv6 地址为此远程访问服务器; 当前 IPv6将负载平衡群集的 VIP 地址。 在中**子网前缀长度**框中，输入子网前缀长度。  
  
7.  两个网络适配器的部署，在**内部专用 IP 地址**页上，执行以下操作，并单击**下一步**:  
  
    1.  在中**IPv4 地址**框中，输入此远程访问服务器的新的内部 IPv4 地址; 当前 IPv4 地址将是群集的负载平衡的 VIP。 在中**子网掩码**框中，输入子网掩码。  
  
    2.  如果企业环境为本机 IPv6，则在**IPv6 地址**框中，输入此远程访问服务器的新的内部 IPv6 地址; 当前 IPv6 地址将是群集的负载平衡的 VIP。 在中**子网前缀长度**框中，输入子网前缀长度。  
  
8.  上**摘要**页上，单击**提交**。  
  
9. 上**启用负载平衡**对话框中，单击**关闭**。  
  
10. 启用负载平衡向导中，单击**关闭**。  
  
    > [!NOTE]  
    > 如果正在使用外部负载均衡，请注意虚拟 Ip，并提供与在外部负载均衡器上。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
如果选择使用 Windows NLB 中的规划步骤，然后执行以下操作：  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -InternetVirtualIPAddress @("2.1.1.1/255.255.255.0","2.1.1.2/255.255.255.0") -InternalVirtualIPAddress @("10.1.1.2/255.255.255.0","3ffe::2/64")  
```  
  
如果你选择了使用外部负载均衡器中的规划步骤： 然后执行以下操作：  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -UseThirdPrtyLoadBalancer  
```  
  
> [!NOTE]  
> 建议不包括更改到负载均衡器设置，通过更改任何其他设置，如果使用暂存 Gpo。 必须先应用对负载均衡器设置的任何更改，然后应进行其他配置更改。 此外，新的 DirectAccess 服务器上配置负载均衡器之后, 请留出一些时间才能应用并更改到新群集相关的其他 DirectAccess 设置之前，在企业中的 DNS 服务器之间复制 IP 更改。  
  
## <a name="BKMK_InstallIPHTTP"></a>3.3 安装的 IP-HTTPS 证书  
必须至少具有本地 **Administrators** 组中的成员身份或同等身份才能完成此过程。  
  
### <a name="IPHTTPSCert"></a>若要安装的 IP-HTTPS 证书  
  
1.  在配置远程访问服务器上，单击**启动**，类型**mmc**然后按 ENTER。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在 MMC 控制台中的“文件”  菜单上，单击“添加/删除管理单元”  。  
  
3.  上**添加或删除管理单元**对话框中，单击**证书**，单击**添加**，单击**计算机帐户**，单击**下一步**，单击**完成**，然后单击**确定**。  
  
4.  在控制台的左窗格中，导航到**证书 （本地计算机） \Personal\Certificates**。 右键单击的 IP-HTTPS 证书，指向**的所有任务**然后单击**导出**。  
  
5.  上**欢迎使用证书导出向导**页上，单击**下一步**。  
  
6.  在“导出私钥”  页面上，单击“是，导出私钥”  ，然后单击“下一步”  。  
  
7.  上**导出文件格式**页上，单击**个人信息交换-PKCS #12 (。PFX)** ，然后单击**下一步**。  
  
8.  上**安全**页上，选择**密码**复选框，输入中的密码**密码**框并确认该密码，然后单击**下一步**.  
  
9. 上**导出的文件**页上，输入证书文件的名称并将其保存到桌面，然后单击**下一步**。  
  
10. 上**正在完成证书导出向导**页上，单击**完成**。  
  
11. 上**证书导出向导**对话框中，单击**确定**。  
  
12. 将证书复制到你想要成为群集成员的所有服务器。  
  
13. 在新 DirectAccess 服务器上，单击**启动**，类型**mmc**然后按 ENTER。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
14. 在 MMC 控制台中的“文件”  菜单上，单击“添加/删除管理单元”  。  
  
15. 上**添加或删除管理单元**对话框中，单击**证书**，单击**添加**，单击**计算机帐户**，单击**下一步**，单击**完成**，然后单击**确定**。  
  
16. 在控制台的左窗格中，导航到**证书 （本地计算机） \Personal\Certificates**。 右键单击**证书**节点，指向**的所有任务**，然后单击**导入**。  
  
17. 上**欢迎使用证书导入向导**页上，单击**下一步**。  
  
18. 上**导入的文件**页上，单击**浏览**以找到证书。 选择证书，然后单击**下一步**。  
  
19. 上**私钥保护**页上，在**密码**框中，键入的密码，然后单击**下一步**。  
  
20. 在“证书存储”  页上，单击“下一步”  。  
  
21. 在“正在完成证书导入向导”  页上，单击“完成”  。  
  
22. 上**证书导入向导**对话框中，单击**确定**。  
  
23. 重复步骤 13 至 22 日在你想要成为群集成员的所有服务器上。  
  
## <a name="BKMK_NLS"></a>3.4 安装网络位置服务器证书  
必须至少具有本地 **Administrators** 组中的成员身份或同等身份才能完成此过程。  
  
#### <a name="to-install-a-certificate-for-network-location"></a>若要为网络位置安装证书  
  
1.  在远程访问服务器上，单击**启动**，类型**mmc**，然后按 ENTER。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  单击**文件**，然后单击**添加/删除管理单元**。  
  
3.  单击**证书**，单击**添加**，单击**计算机帐户**，单击**下一步**，单击**本地计算机**，单击**完成**，然后单击**确定**。  
  
4.  在证书管理单元的控制台树中，依次打开  “证书(本地计算机)\个人\证书”。  
  
5.  右键单击  “证书”，指向  “所有任务”，然后单击  “申请新证书”。  
  
6.  单击“下一步”  两次。  
  
7.  上**申请证书**页上，单击 Web 服务器证书模板，然后单击**注册此证书需要更多信息**。  
  
    如果未显示的 Web 服务器证书模板，请确保远程访问服务器计算机帐户已注册的 Web 服务器证书模板的权限。 有关详细信息，请参阅[配置 Web 服务器证书模板权限](https://msdn.microsoft.com/library/ee649249.aspx)。  
  
8.  上**使用者**选项卡**证书属性**对话框中，在**使用者名称**，为**类型**，选择**常见名称**。  
  
9. 在中**值**，键入网络位置服务器网站 (例如，nls.corp.contoso.com) 的 intranet 名称的完全限定的域名 (FQDN)，然后单击**添加**。  
  
10. 依次单击  “确定”、  “注册”和  “完成”。  
  
11. 在证书管理单元的详细信息窗格中，验证是否使用已注册的新证书，其 FQDN**预期目的**的**服务器身份验证**。  
  
12. 右键单击证书，然后依次**属性**。  
  
13. 在中**友好名称**，类型**网络位置证书**，然后单击**确定**。  
  
    > [!TIP]  
    > 步骤 12 和 13 是可选的但使其更轻松地配置远程访问时选择网络位置的证书。  
  
14. 重复此过程在你想要成为群集成员的所有服务器上。  
  
## <a name="BKMK_Add"></a>3.5 将服务器添加到群集  
 
  
#### <a name="to-add-servers-to-the-cluster"></a>若要将服务器添加到群集  
  
1.  在配置 DirectAccess 服务器上，单击**启动**，然后单击**远程访问管理**。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在远程访问管理控制台中，单击“配置”  。 在中**任务**窗格下**负载平衡的群集**，单击**添加或删除服务器**。  
  
3.  上**添加或删除服务器**对话框中，单击**添加服务器**。  
  
4.  上**将服务器添加**对话框中，在**选择服务器**页上，输入其他远程访问服务器的名称，然后单击**下一步**。  
  
5.  上**网络适配器**页上，执行以下操作之一：  
  
    -   如果您要在中，使用两个网络适配器，部署拓扑**外部适配器**，选择连接到外部网络适配器。 在中**内部适配器**，选择连接到内部网络适配器。  
  
    -   如果您要在中，使用一个网络适配器部署拓扑**网络适配器**，选择连接到内部网络适配器。  
  
6.  上**网络适配器**页上，在**选择使用 IP-HTTPS 连接进行身份验证的证书**，单击**浏览**以查找和选择 IP-HTTPS 证书然后单击**下一步**。  
  
7.  上**网络位置服务器**页上，单击**浏览**来选择远程访问服务器上运行的网络位置服务器网站证书，然后单击**下一步**.  
  
    > [!NOTE]  
    > **网络位置服务器**页将显示仅当网络位置服务器网站上运行远程访问服务器。  
  
    > [!NOTE]  
    > 如果 VPN 也远程访问服务器上配置的然后你将需要添加 VPN IP 地址池信息在这里。  
  
8.  上**摘要**页上，单击**添加**。  
  
9. 在**完成**页上，单击**关闭**。  
  
10. 重复此过程的所有远程访问服务器，若要添加到群集。  
  
11. 上**添加或删除服务器**对话框中，单击**提交**。  
  
12. 上**添加和删除服务器**对话框中，单击**关闭**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
Add-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
> [!NOTE]  
> 如果尚未在负载平衡群集中启用 VPN，不应提供任何 VPN 地址范围时将新服务器添加到群集使用 Windows PowerShell cmdlet。 如果你这样做是误，从群集中删除服务器并再次添加到群集而无需指定 VPN 地址范围。  
  
## <a name="BKMK_remove"></a>3.6 从群集中删除服务器  
 
  
#### <a name="to-remove-a-server-from-the-cluster"></a>若要从群集中删除服务器  
  
1.  在配置远程访问服务器上，单击**启动**，然后单击**远程访问管理**。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在远程访问管理控制台中，单击“配置”  。 在中**任务**窗格下**负载平衡的群集**，单击**添加或删除服务器**。  
  
3.  上**添加或删除服务器**对话框中，选择你想要删除的远程访问服务器，然后单击**删除服务器**。  
  
4.  上**删除服务器警告**对话框中，请确保选择了正确的服务器，然后依次**确定**。  
  
5.  重复此过程的所有远程访问服务器，若要从群集中删除。  
  
6.  上**添加或删除服务器**对话框中，单击**提交**。  
  
7.  上**添加和删除服务器**对话框中，单击**关闭**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
Remove-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
## <a name="BKBK_disable"></a>3.7 禁用负载平衡  
[使用 Windows PowerShell 执行此步骤](assetId:///7a817ca0-2b4a-4476-9d28-9a63ff2453f9)  
  
#### <a name="to-disable-load-balancing"></a>若要禁用负载平衡  
  
1.  在配置 DirectAccess 服务器上，单击**启动**，然后单击**远程访问管理**。 如果出现了“用户帐户控制”  对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”  。  
  
2.  在远程访问管理控制台中，单击“配置”  。 在中**任务**窗格下**负载平衡的群集**，单击**禁用负载平衡**。  
  
3.  上**禁用负载平衡**对话框中，单击**确定**。  
  
4.  上**禁用负载平衡**对话框中，单击**关闭**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
set-RemoteAccessLoadBalancer -disable  
```  
  
禁用负载平衡将远程访问设置和 NLB 设置 （如果已配置） 从服务器中删除所有除正在执行从该服务器。 在此远程访问服务器 （如果已配置），将删除 NLB 设置但远程访问设置将保持状态。  
  
单击**删除配置设置**将远程访问和 NLB （如果已配置） 从服务器中删除所有部署中。  
  
> [!NOTE]  
> -   如果远程访问卸载部署负载平衡时，所有服务器都保留 Dip。 删除 Vip。 这将导致失败的 Vip 地址是针对企业网络中的所有路由。 这还会影响到 Vip，如网络位置服务器证书主题名称所解析的 DNS 条目。 若要避免此问题，禁用负载平衡，这在最后一个远程访问服务器上，保留 Vip，然后卸载远程访问。  
> -   使用后**集 RemoteAccessLoadBalancer** cmdlet 来禁用负载平衡，请等待 2 分钟后再运行其他 cmdlet。 这也应完成之后运行另一个 cmdlet 的任何脚本**集 RemoteAccessLoadBalancer-禁用**cmdlet。  
> -   禁用负载平衡的更改转换为专用 IP 地址在群集的虚拟 IP 地址。 因此，查询的服务器的名称任何操作将失败的服务器上缓存的 DNS 项过期之前。 请确保不要禁用负载平衡服务器上的缓存到期之前之后运行任何远程访问 PowerShell cmdlet。 此问题是更常见，如果你尝试禁用负载平衡是在另一个域中的另一台计算机从计算机上。 如果您禁用负载平衡远程访问管理控制台中，可能会阻止从加载的配置也会发生这种情况。 缓存已过期或已刷新后，将加载配置。  
  
## <a name="BKMK_Links"></a>另请参阅  
  
-   [步骤 4：验证群集](Step-4-Verify-the-Cluster.md)  
  


