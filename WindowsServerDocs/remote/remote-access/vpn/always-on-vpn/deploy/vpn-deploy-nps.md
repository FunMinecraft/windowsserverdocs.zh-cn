---
title: 安装和配置 NPS 服务器
description: NPS 服务器处理的连接请求发送的 VPN 服务器验证用户是否有权连接，用户的身份和记录你选择了在 NPS 配置 RADIUS 记帐时连接请求的方面。
ms.prod: windows-server-threshold
ms.technology: networking-ras
ms.topic: article
ms.assetid: ''
ms.localizationpriority: medium
ms.author: pashort
author: shortpatti
ms.date: 08/30/2018
ms.openlocfilehash: ca53ef28497a78f264c60ac1132f721fb6e01c15
ms.sourcegitcommit: 9c142ad4d4321baf328707f29fa104247ff5149a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/29/2019
ms.locfileid: "9035763"
---
# 步骤 4： 安装和配置网络策略服务器 (NPS)

>   适用于： Windows Server 2019、 Windows Server （半年频道）、 Windows Server 2016、 Windows Server 2012 R2、 Windows 10


& #171; [**下一步：** 步骤 3。始终启用 VPN 配置的远程访问服务器](vpn-deploy-ras.md)<br>
& #187; [**下一步：** 步骤 5。配置 DNS 和防火墙设置](vpn-deploy-dns-firewall.md)


在此步骤中，你为处理连接请求发送的 VPN 服务器安装网络策略服务器 (NPS):

- 执行验证用户有权连接的授权。
- 执行身份验证来验证用户的身份。
- 执行记帐记录你选择了在 NPS 配置 RADIUS 记帐时连接请求的方面。

此部分中的步骤，可以完成以下各项：

1.  在计算机或虚拟机中计划 NPS 服务器，并安装在你的组织或企业网络中，你可以安装 NPS。

   >[!TIP] 
   >如果你已经有一个或多个 NPS 服务器，你的网络上，不需要执行 NPS 服务器安装-相反，你可以使用本主题更新现有 NPS 服务器的配置。

>[!NOTE]  
你可以在 Windows Server Core 上安装网络策略服务器服务。

2.  在组织/公司 NPS 服务器上，你可以配置 NPS 为处理来自 VPN 服务器的连接请求的 RADIUS 服务器执行。

## 安装网络策略服务器

在此过程中，通过使用 Windows PowerShell 或服务器管理器添加角色和功能向导来安装 NPS。 NPS 是网络策略和访问服务服务器角色的角色服务。

>[!TIP] 
>默认情况下，NPS 侦听端口 1812年、 1813年、 1645年和 1646年上所有已安装的网络适配器上的 RADIUS 通信。 当你安装 NPS 中，并启用高级安全 Windows 防火墙时，防火墙例外，以便这些端口获取自动创建为 IPv4 和 IPv6 通信。 如果你的网络访问服务器配置为通过这些默认值以外的端口发送 RADIUS 通信，删除 NPS 在安装期间，在高级安全 Windows 防火墙中创建的异常，并创建异常您使用的端口RADIUS 通信。

**Windows PowerShell 的过程：**

若要使用 Windows PowerShell，以管理员身份，运行 Windows PowerShell 执行此过程键入以下命令，然后按 enter 键。

`Install-WindowsFeature NPAS -IncludeManagementTools`

**过程为服务器管理器：**

1.  在服务器管理器中，单击**管理**，然后单击**添加角色和功能**。 <p>添加角色和功能向导将打开。

2.  在开始之前，单击**下一步**。

    >[!NOTE] 
    >如果你之前已选择**跳过此页面，默认情况下**，添加角色和功能向导运行时不显示添加角色和功能向导的**开始之前**页。

1.  在选择安装类型中，确保**基于角色或基于功能的安装**处于选中状态，单击**下一步**。

2.  在选择目标服务器上，请确保**选择从服务器池中服务器**处于选中状态。

3.  服务器池中，确保选中了本地计算机，然后单击**下一步**。

4.  在选择服务器角色，**角色**，在选择**网络策略和访问服务**。 打开对话框，询问是否将它添加所需的网络策略和访问服务的功能。

5.  单击**添加功能**，然后单击**下一步**

6.  在选择功能中，单击**下一步**，和在网络策略和访问服务中，查看提供的信息，然后单击**下一步**。

7.  在选择角色服务中，单击**网络策略服务器**。

8.  对于网络策略服务器所需的功能，单击**添加功能**，然后单击**下一步**。

9.  在确认安装选择，单击**自动如果需要重新启动目标服务器**。

10. 单击**是**以确认所选，然后单击**安装**。 <p>安装进度页在安装过程中显示的状态。 当此过程完成后时，消息"已成功安装在*计算机名"* 将显示，其中*ComputerName*是在其安装网络策略服务器的计算机的名称。

11. 单击**关闭**。

## 配置 NPS

安装 NPS，将 NPS 处理所有身份验证、 配置和记帐职责连接请求它后接收来自 VPN 服务器。

### 在 Active Directory 中注册 NPS 服务器

在此过程中，你将注册 Active Directory 中的服务器，以便它有权访问处理连接请求时的用户帐户信息。

**步骤：**

1.  在服务器管理器中，单击**工具**，然后单击**网络策略服务器**。 NPS 控制台将打开。

2.  在 NPS 控制台中，右键单击**NPS （本地）**，，然后单击**注册在 Active Directory 中的服务器**来选择它。<p>网络策略服务器对话框。

3.  在网络策略服务器对话框中，单击**确定**两次。

有关注册 NPS 的备用方法，请参阅[注册 NPS 服务器 Active Directory 域中](../../../../../networking/technologies/nps/nps-manage-register.md)。

### 配置网络策略服务器记帐

在此过程中，配置网络策略服务器记帐使用以下日志记录类型之一：

-   **事件日志记录**。 主要用于审核和疑难解答连接尝试。 你可以配置 NPS 事件日志通过获取 NPS 控制台中的 NPS 服务器属性。

-   **记录用户身份验证和记帐请求到本地文件**。 主要用于连接分析和计费目的。 此外用作安全调查工具，因为它为你提供攻击之后跟踪的恶意用户活动的方法。 你可以配置本地文件日志记录使用记帐配置向导。

-   **用户身份验证和记帐请求到符合 Microsoft SQL Server XML 的数据库记录**。 用于允许多个服务器运行 NPS 具有一个数据源。 此外提供了使用关系数据库的优势。 你可以通过使用记帐配置向导配置 SQL Server 日志记录。

若要配置网络策略服务器记帐，请参阅[配置网络策略服务器记帐](../../../../../networking/technologies/nps/nps-accounting-configure.md)。

### 为 RADIUS 客户端添加 VPN 服务器

在[配置远程访问服务器的始终启用 VPN](vpn-deploy-ras.md)部分中，可以安装和配置 VPN 服务器。 VPN 服务器配置期间，VPN 服务器上添加 RADIUS 共享的密钥。 

在此过程中，你可以使用相同的共享机密文本字符串将 VPN 服务器配置为在 NPS 中的 RADIUS 客户端。 使用相同的文本字符串，在 VPN 服务器上，使用或 NPS 服务器和 VPN 服务器之间的通信失败。

>[!IMPORTANT] 
>当你添加到你的网络的新网络访问服务器 （VPN 服务器、 无线接入点、 身份验证交换机或拨号服务器） 时，必须将服务器添加为 RADIUS 客户端在 NPS 中，以便 NPS 意识的并且可以与网络访问服务器通信。

**步骤：**

1.  在 NPS 服务器上，在 NPS 控制台中，双击**RADIUS 客户端和服务器**。

2.  右键单击**RADIUS 客户端**，然后单击**新建**。 新建 RADIUS 客户端对话框。

3.  验证**启用此 RADIUS 客户端**复选框处于选中状态。

4.  **友好名称**，在输入 VPN 服务器的显示名称。

5.  在**地址 （DNS）**，输入 NAS IP 地址或 FQDN。<p>如果你输入的 FQDN，请单击**验证**，如果你想要验证名称正确及映射到有效的 IP 地址。

6.  在**共享密钥**，请执行操作：

    1.  确保**手动**处于选中状态。

    2.  输入也输入 VPN 服务器的强大的文本字符串。

    3.  重新键入共享的密钥，确认共享机密。

7.  单击**确定**。 VPN 服务器出现在 NPS 服务器上配置 RADIUS 客户端的列表。

## 将 NPS 配置为 RADIUS VPN 连接

在此过程中，通过以下方法将 NPS 配置 RADIUS 服务器为你的组织的网络上。 在 NPS 中，你必须定义只允许用户通过 VPN 服务器-访问组织/公司网络的特定组中的策略，然后仅当使用有效的用户证书时 PEAP 身份验证请求中。

**步骤：**

1.  在 NPS 控制台中，在标准配置中，请确保**用于拨号或 VPN 连接的 RADIUS 服务器**处于选中状态。

2.  单击**配置 VPN 或拨号**。<p>配置 VPN 或拨号向导将打开。

3.  单击**虚拟专用网络 (VPN) 连接**，然后单击**下一步**。

4.  在指定拨号或 VPN 服务器，在 RADIUS 客户端，选择你在上一步中添加 VPN 服务器的名称。<p>例如，如果你的 VPN 服务器 NetBIOS 名称 RAS1，请单击**RAS1**。

5.  单击**下一步**。

6.  在配置身份验证方法，请完成以下步骤：

    1.  清除**Microsoft 加密身份验证版本 2 (Ms-chapv2)** 复选框。

    2.  单击**可扩展身份验证协议**复选框，来选择它。

    3.  在类型 （基于访问和网络配置的方法） 中，单击**Microsoft： 受保护的 EAP (PEAP)**，然后单击**配置**。<p>编辑受保护的 EAP 属性对话框。

    4.  单击**删除**以删除安全的密码 (EAP 身份验证协议版本 2) EAP 类型。

    5.  单击**添加**。 添加 EAP 对话框。

    6.  单击**智能卡或其他证书**，然后单击**确定**。

    7.  单击**确定**以关闭编辑受保护的 EAP 属性。

7.  单击**下一步**。

8.  指定用户组，请完成以下步骤：

    1.  单击**添加**。 选择用户、 计算机、 服务帐户或组对话框。

    2.  键入**VPN 用户**，然后单击**确定**。

    3.  单击**下一步**。

9.  在指定 IP 筛选器中，单击**下一步**。

10. 在指定加密设置中，单击**下一步**。 不进行任何更改。<p>这些设置仅适用于 Microsoft 点对点加密 (MPPE) 连接，这种情况下不支持。

11. 在指定领域名，单击**下一步**。

12. 单击**完成**以关闭向导。

## 自动注册 NPS 服务器证书

在此过程中，你组策略在本地 NPS 服务器上手动刷新。 当组策略刷新，如果配置证书自动注册，并正常运行，在本地计算机在自动注册证书由证书颁发机构 (CA)。

>[!NOTE]  
>域成员计算机重新启动时或当用户登录到的域成员计算机时，组策略自动刷新。 此外，组策略定期刷新。 默认情况下，此定期刷新发生具有随机偏移量最多 30 分钟内每隔 90 分钟。

**管理员**，或等效的成员身份是完成此过程所需的最低。

**步骤：**

1.  在 NPS 中，打开 Windows PowerShell。

2.  在 Windows PowerShell 提示符处，键入**gpupdate**，，然后按 ENTER。

## 下一步
[第 5 步。配置 DNS 和防火墙设置始终启用 VPN](vpn-deploy-dns-firewall.md)： 通过使用 Windows PowerShell 或服务器管理器添加角色和功能向导在此步骤中，安装网络策略服务器 (NPS)。 你还配置 NPS 处理所有身份验证、 授权和连接的记帐职责从 VPN 服务器接收的请求。



---

