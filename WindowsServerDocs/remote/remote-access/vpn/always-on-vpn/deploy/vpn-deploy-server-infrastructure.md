---
title: 配置服务器基础结构
description: 在此步骤中，你可以安装和配置支持 VPN 所需的服务器端组件。 服务器端组件，包括配置 PKI 分配使用的用户、 VPN 服务器和 NPS 服务器证书。
ms.prod: windows-server-threshold
ms.technology: networking-ras
ms.topic: article
ms.assetid: ''
ms.localizationpriority: medium
ms.author: pashort
author: shortpatti
ms.date: 08/30/2018
ms.reviewer: deverette
ms.openlocfilehash: 21b494bea1990fb8424537205db483d977331465
ms.sourcegitcommit: 4893d79345cea85db427224bb106fc1bf88ffdbc
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/05/2018
ms.locfileid: "6067055"
---
# 步骤 2： 配置服务器基础结构

>适用于： Windows Server （半年频道）、 Windows Server 2016、 Windows Server 2012 R2、 Windows 10

& #171; [**以前：** 步骤 1。规划始终启用 VPN 部署](always-on-vpn-deploy-planning.md)<br>
& #187; [**下一步：** 步骤 3。始终在 VPN 配置的远程访问服务器](vpn-deploy-ras.md)


在此步骤中，你可以安装和配置支持 VPN 所需的服务器端组件。 服务器端组件，包括配置 PKI 分配使用的用户、 VPN 服务器和 NPS 服务器证书。  你还可以配置 RRAS 以支持 IKEv2 连接和 NPS 服务器进行授权 VPN 连接。

## 在组策略中配置证书自动注册
在此过程中，你配置组策略在域控制器上，以便域成员自动请求用户和计算机证书。 执行此操作允许 VPN 用户请求和检索用户自动进行 VPN 连接身份验证的证书。 同样，此策略允许 NPS 服务器以请求服务器身份验证证书自动。 

手动注册 VPN 服务器上的证书。

>[!TIP]
>对于非 domained 已加入的计算机，请参阅[CA 配置为非域加入的计算机](#ca-configuration-for-non-domain-joined-computers)的下面。 由于 RRAS 服务器不是已加入域，自动注册不能用于 VPN 网关证书注册。  因此，使用脱机证书请求过程。 


1.  在域控制器上，打开组策略管理。

2.  在导航窗格中，右键单击你的域 (如 corp.contoso.com)，然后单击**创建在这个域中的 GPO 并在此处链接**。

3.  在新建 GPO 对话框中，键入**自动注册策略**，并单击**确定**。

4.  在导航窗格中，右键单击**自动注册策略**，然后单击**编辑**。

5.  在组策略管理编辑器中，完成以下步骤来配置计算机证书自动注册：

    1.  在导航窗格中，单击**计算机 Configuration\\Policies\\Windows Settings\\Security Settings\\Public 公钥策略**。

    2.  在详细信息窗格中，右键单击**证书服务客户端-自动注册**，然后单击**属性**。

    3.  在证书服务客户端-自动注册属性对话框中，在**配置模型**中，单击**启用**。

    4.  选择**续订过期证书、 更新未决证书，并删除吊销的证书**并**更新使用证书模板的证书**。

    5.  单击**确定**。

6.  在组策略管理编辑器中，请完成以下步骤配置用户证书自动注册到：

    1.  在导航窗格中，单击**用户 Configuration\\Policies\\Windows Settings\\Security Settings\\Public 公钥策略**。

    2.  在详细信息窗格中，右键单击**证书服务客户端-自动注册**，然后单击**属性**。

    3.  在证书服务客户端-自动注册属性对话框中，在**配置模型**中，单击**启用**。

    4.  选择**续订过期证书、 更新未决证书，并删除吊销的证书**并**更新使用证书模板的证书**。

    5.  单击**确定**。

    6.  关闭“组策略管理编辑器”。

7.  关闭组策略管理。

### CA 非域加入的计算机的配置

由于 RRAS 服务器不是已加入域，自动注册不能用于 VPN 网关证书注册。  因此，使用脱机证书请求过程。 

1. 在 RRAS 服务器上，生成的文件称为的**VPNGateway.inf**基于示例证书策略请求附录中提供 （部分 0） 和自定义以下各项： 

   - 在 [NewRequest] 部分中，将替换为 vpn.contoso.com 用于使用者名称与所选 [_客户_] VPN 终结点 FQDN。

   - 在 [扩展] 部分中，将替换为 vpn.contoso.com 用于使用者备用名称与所选 [_客户_] VPN 终结点 FQDN。

2. 保存或将**VPNGateway.inf**文件复制到所选的位置。

3. 从提升的命令提示符，导航到文件夹，其中包括**VPNGateway.inf**文件类型：

   ```
   certreq -new VPNGateway.inf VPNGateway.req
   ```

4. 将新创建的**VPNGateway.req**输出文件复制到证书颁发机构服务器或特权访问工作站 （爪）。 

5. 保存或将**VPNGateway.req**文件复制到所选位置上的证书颁发机构服务器或特权访问工作站 （爪）。

6. 从提升的命令提示符，导航到包含类型与上一步中创建的 VPNGateway.req 文件的文件夹： 

   ```
   certreq -attrib “CertificateTemplate:[Customer]VPNGateway” -submit VPNgateway.req VPNgateway.cer
   ```

7. 如果出现提示证书颁发机构列表窗口中，选择相应的企业 CA 证书请求提供服务。

8. 将新创建的**VPNGateway.cer**输出文件复制到 RRAS 服务器。 

9. 保存或将**VPNGateway.cer**文件复制到所选位置的 RRAS 服务器上。

10. 从提升的命令提示符，导航到包含类型与上一步中创建的 VPNGateway.cer 文件的文件夹：
   
   ```
   certreq -accept VPNGateway.cer
   ```

11. 作为描述[此处](https://docs.microsoft.com/dotnet/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in)选择的**计算机帐户**选项，运行证书 mmc 管理单元。

12. 确保有效证书存在 RRAS 服务器具有以下属性：

   - **预期目的：** 服务器身份验证，IP 安全 IKE 中间 

   - **证书模板：**[_客户_]VPN 服务器

#### 示例： VPNGateway.inf 脚本

此处，你可以查看用于 VPN 网关使用请求证书的带过程的证书请求策略的一个示例脚本。

>[!TIP]
>你可以找到一份 VPNGateway.inf 脚本 VPN 提供 IP 工具包中的证书请求策略文件夹下。 仅更新的使用者和 \_continue\_ 与客户的特定值。

```
[Version] 

Signature="$Windows NT$"

[NewRequest]
Subject = "CN=vpn.contoso.com"
Exportable = FALSE   
KeyLength = 2048     
KeySpec = 1          
KeyUsage = 0xA0      
MachineKeySet = True
ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
RequestType = PKCS10 

[Extensions]
2.5.29.17 = "{text}"
_continue_ = "dns=vpn.contoso.com&"

```

## 创建 VPN 用户、 VPN 服务器和 NPS 服务器组

在此过程中，你可以添加新的 Active Directory (AD) 组包含允许使用 VPN 连接到组织的网络的用户。

此组有两个用途：

-   它定义 VPN 要求的用户证书自动注册到允许哪些用户。

-   它定义 NPS 授权 VPN 访问权限的用户。

通过使用自定义组，如果你想要吊销用户的 VPN 的访问权限，则可以删除该用户从组。

你还可以添加包含 VPN 服务器组和包含 NPS 服务器的另一个组。 你可以使用这些组以限制对其成员的证书请求。

>[!NOTE] 
>我们建议 VPN 服务器驻留在 DMA/外围设备不能加入域。 但是，如果你想要将已加入域的更好的可管理性的 VPN 服务器 （组策略、 备份/监视代理，没有本地用户管理和等），然后添加 AD 组对 VPN 服务器证书模板。

### 配置 VPN 用户组

1.  在域控制器上，打开 Active Directory 用户和计算机。

2.  右键单击容器或组织单位，单击**新建**，单击**组**。

3.  在**组名称**中，键入**VPN 用户**，并单击**确定**。

4.  右键单击**VPN 用户**，然后单击**属性**。

5.  在 VPN 用户属性对话框中的**成员**选项卡上，单击**添加**。

6.  在选择用户对话框中，添加所有的用户需要 VPN 访问并单击**确定**。

7.  关闭 Active Directory 用户和计算机。

### 配置 VPN 服务器和 NPS 服务器组

1.  在域控制器上，打开 Active Directory 用户和计算机。

2.  右键单击容器或组织单位，单击**新建**，单击**组**。

3.  在**组名称**中，键入**VPN 服务器**，并单击**确定**。

4.  右键单击**VPN 服务器**，然后单击**属性**。

5.  在 VPN 服务器属性对话框中的**成员**选项卡上，单击**添加**。

6.  单击**对象类型**，选择**计算机**复选框，然后单击**确定**。

7.  在**输入要选择的对象名称**键入你的 VPN 服务器的名称，然后单击**确定**。

8.  单击**确定**关闭 VPN 服务器属性对话框。

9.  NPS 服务器组重复上述步骤。

10. 关闭 Active Directory 用户和计算机。

## 创建用户身份验证模板

在此过程中，你可以配置自定义客户端-服务器身份验证模板。 此模板是必需的因为你想要通过选择升级的兼容性级别提高证书的整体安全性并选择 Microsoft 平台加密提供程序。 这最后一项更改，可以在客户端计算机上使用 TPM 保护证书。 有关 TPM 的概述，请参阅[受信任的平台模块技术概述](https://docs.microsoft.com/windows/device-security/tpm/trusted-platform-module-overview)。

**步骤：**

1.  在 CA 上，打开证书颁发机构。

2.  在导航窗格中，右键单击**证书模板**，并单击**管理**。

3.  在证书模板控制台中，右键单击**用户**，，然后单击**复制模板**。

    >[!WARNING]
    >请不要在任何时间之前第 10 步单击**应用**或**确定**。  如果你在进入所有参数之前单击这些按钮，许多选项变得固定和不会再可编辑。 例如，**加密**选项卡上，如果_传统加密存储提供程序_显示在提供程序类别字段中，它将变为禁用，阻止任何进一步的更改。 唯一的替代方法是删除该模板并重新创建它。  

4.  在新模板的属性对话框中，在**常规**选项卡上，完成以下步骤：

    1.  在**模板显示名称**中，键入**VPN 用户身份验证**。

    2.  清除**Active Directory 中的发布证书**复选框。

5.  有关**安全**选项卡上，完成以下步骤：

    1.  单击**添加**。

    2.  在选择用户、 计算机、 服务帐户或组对话框中，键入**VPN 用户**，并单击**确定**。

    3.  在**组或用户名称**框中，单击**VPN 用户**。

    4.  **为 VPN 用户的权限**，选择**允许**列中的**注册**和**自动注册**复选框。

       >[!TIP]
       >请确保使读取复选框处于选中状态。 换言之，你需要读取权限注册。 

    5.  在**组或用户名称**中，单击**域用户**，然后单击**删除**。

6.  在**兼容性**选项卡上，请完成以下步骤：

    1.  在**证书颁发机构**，单击**Windows Server2012R2**。

    2.  在**生成更改**对话框中，单击**确定**。

    3.  在**证书收件人**框中，单击**Windows8.1/Windows Server2012R2**。

    4.  在**生成更改**对话框中，单击**确定**。

7.  在**请求处理**选项卡上，清除**允许导出私钥**复选框。

8.  **加密**选项卡上，请完成以下步骤：

    1.  在**提供程序类别**中，单击**密钥存储提供程序**。

    2.  单击**请求必须使用一个以下提供程序**。

    3.  选择**Microsoft 平台加密提供程序**复选框。

9.  在**使用者名称**选项卡上，如果你没有对所有用户帐户列出的电子邮件地址，清除**使用者名称中的包括电子邮件名称**和**电子邮件名称**复选框。

10. 单击**确定**以保存 VPN 用户身份验证证书模板。

11. 关闭该证书模板控制台。

12. 在导航窗格中的 theCertification Authoritysnap-中，右键单击**证书模板**，单击**新建**，然后单击**颁发的证书模板**。

13. **VPN 用户身份验证**，然后依次单击**确定**。

14. 关闭 theCertification 颁发机构管理单元。

## 创建 VPN 服务器身份验证模板

在此过程中，你可以为 VPN 服务器配置服务器身份验证的新模板。 添加 IP 安全性 (IPsec) IKE 中间应用程序策略允许筛选器的证书服务器多个证书是否可通过服务器身份验证使用扩展密钥用法。

>[!IMPORTANT] 
>VPN 客户端从公共 Internet 访问此服务器，因为主题和备用名称是不同的内部服务器名称。 因此，你不能自动注册此 VPN 服务器上的证书。

**先决条件：**<p>
已加入域的 VPN 服务器

**步骤：** 

1.  在 CA 上，打开证书颁发机构。

2.  在导航窗格中，右键单击**证书模板**，并单击**管理**。

3.  在证书模板控制台中，右键单击**RAS 和 IAS 服务器**，并单击**复制模板**。

4.  在新模板的属性对话框中，在**常规**选项卡上，在**模板显示名称**输入 VPN 服务器，例如， **VPN 服务器身份验证**或**RADIUS 服务器**的描述性名称。

5.  **扩展**选项卡上，完成以下步骤：

    1.  单击**应用程序策略**，然后单击**编辑**。

    2.  在**编辑应用程序策略扩展**对话框中，单击**添加**。

    3.  在**添加应用程序策略**对话框中， **IP 安全 IKE 中间**，然后依次单击**确定**。<p>添加 IP 安全 IKE 中间到 EKU 可帮助在多台服务器身份验证证书所在 VPN 服务器的情况下。 IP 安全性 IKE 中间存在时，IPSec 仅使用两个 EKU 选项使用的证书。 无需此，IKEv2 身份验证可能失败错误 13801: IKE 身份验证凭据是不可接受。

    4.  单击**确定**以返回到**新模板的属性**对话框。

6.  有关**安全**选项卡上，完成以下步骤：

    1.  单击**添加**。

    2.  在**选择用户、 计算机、 服务帐户或组**对话框中，键入**VPN 服务器**，并单击**确定**。

    3.  在**组或用户名称**框中，单击**VPN 服务器**。

    4.  **VPN 服务器的权限**，选择**允许**列中的**注册**复选框。

    5.  在**组或用户名称**中，单击**RAS 和 IAS 服务器**，，然后单击**删除**。

7.  在**使用者名称**选项卡上，请完成以下步骤：

    1.  单击**在请求中提供**。

    2.  在**证书模板**警告对话框中，单击**确定**。

8.  （可选）*如果你要配置用于 VPN 连接的条件访问*，单击**请求处理**选项卡，然后单击**允许导出私钥**来选择它。

9.  单击**确定**以保存 VPN 服务器证书模板。

10. 关闭该证书模板控制台。

11. 在 Authoritysnap 在认证 thenavigation 窗格中，右键单击**证书模板**，单击**新建**，然后单击**颁发的证书模板**。

12. 重启的证书颁发机构服务。

13. 选择你在上面的步骤 4 中选择的名称，然后单击**确定**。

14. 关闭 theCertification 颁发机构管理单元。

## 创建 NPS 服务器身份验证模板

要创建的第三个和最后一个证书模板是 NPS 服务器身份验证模板。 在 NPS 服务器身份验证模板是简单保护到本部分中之前创建的 NPS 服务器组 RAS 和 IAS 服务器模板的副本。 

你将配置为自动注册此证书。

**步骤：**

1.  在 CA 上，打开证书颁发机构。

2.  在导航窗格中，右键单击**证书模板**，并单击**管理**。

3.  在证书模板控制台中，右键单击**RAS 和 IAS 服务器**，并选择**复制模板**。

4.  在新模板的属性对话框中，在**常规**选项卡上，在**模板显示名称**中，键入**NPS 服务器身份验证**。

5.  有关**安全**选项卡上，完成以下步骤：

    1.  单击**添加**。

    2.  在**选择用户、 计算机、 服务帐户或组**对话框中，键入**NPS 服务器**，并单击**确定**。

    3.  在**组或用户名称**中，单击**NPS 服务器**。

    4.  在**NPS 服务器的权限**，选择**允许**列中的**注册**和**自动注册**复选框。

    5.  在**组或用户名称**中，单击**RAS 和 IAS 服务器**，，然后单击**删除**。

6.  单击**确定**以保存 NPS 服务器证书模板。

7.  关闭该证书模板控制台。

8.  在 Authoritysnap 在认证 thenavigation 窗格中，右键单击**证书模板**，单击**新建**，然后单击**颁发的证书模板**。

9.  **NPS 服务器身份验证**，然后依次单击**确定**。

10. 关闭 theCertification 颁发机构管理单元。

## 注册并验证用户证书

因为你将组策略自动注册用户的证书，你仅需要更新策略，并且 windows 10 将自动注册了正确的证书的用户帐户。 然后，你可以验证证书控制台中的证书。

**步骤：**

1.  **VPN 用户**组的成员身份登录到已加入域的客户端计算机。

2.  按 Windows 键 + R、 键入**gpupdate /force**，然后按 Enter。

3.  在开始菜单中，键入**certmgr.msc**，然后按 Enter。

4.  在证书管理单元中，在**个人**，单击**证书**。 在详细信息窗格中显示你的证书。

5.  右键单击具有当前域用户名的证书，然后单击**打开**。

6.  在**常规**选项卡上，确认列下**生效**日期是今天的日期。 如果没有，你可能会选择错误的证书。

7.  单击**确定**，并关闭证书管理单元中。

## 注册并验证服务器证书

与用户证书，你必须手动注册 VPN 服务器的证书。 你已注册它后，请对其进行相同的流程用于用户证书验证。 用户证书，如 NPS 服务器自动注册其身份验证证书，因此你只需对其进行验证。

>[!NOTE] 
>你可能需要重启允许它们在更新其组成员身份，你可以完成这些步骤之前的 VPN 和 NPS 服务器。

### 注册并验证 VPN 服务器证书

1.  在 VPN 服务器的开始菜单上，键入**certlm.msc**，然后按 Enter。

2.  右键单击**个人**单击**所有任务**，然后都单击开始菜单证书注册**申请新证书**。

3.  在开始之前页上，单击**下一步**。

4.  在选择证书注册策略页上，单击**下一步**。

5.  在请求证书页面上，单击 VPN 服务器来选择它旁边的复选框。

6.  VPN 服务器复选框中，单击**是必需的详细信息**打开证书属性对话框中，请完成以下步骤：

    1.  单击**使用者**选项卡，然后单击**使用者名称**，在**类型**下的**公用名**。

    2.  **使用者名称**，在**值**输入的用于连接到 VPN，例如，vpn.contoso.com，外部域客户端名称，然后单击**添加**。

    3.  **备用名称**，在**类型**下单击**DNS**。

    4.  在**备用名称**，在**值**输入所有名称客户端用于连接到 VPN，例如，vpn.contoso.com、 vpn、 132.64.86.2 服务器。

    5.  在输入每个名称后单击**添加**。

    6.  完成后，单击**确定**。

7.  单击**注册**。

8.  单击**完成**。

9.  在证书管理单元中，在**个人**，单击**证书**。<p>在详细信息窗格中显示你所列的证书。

10. 右键单击你的 VPN 服务器的名称，该证书，然后单击**打开**。

11. 在**常规**选项卡上，确认列下**生效**日期是今天的日期。 如果没有，你可能会选择正确的证书。

12. 在**详细信息**选项卡，**增强型密钥用法**，然后依次验证**IP 安全性 IKE 中间**和**服务器身份验证**显示在列表中。

13. 单击**确定**以关闭该证书。

14. 关闭证书管理单元中。

### 验证 NPS 服务器证书

1.  重启 NPS 服务器。

2.  在 NPS 服务器的开始菜单上，键入**certlm.msc**，然后按 Enter。

3.  在证书管理单元中，在**个人**，单击**证书**。<p>在详细信息窗格中显示你所列的证书。

4.  右键单击具有 NPS 服务器的名称的证书，然后单击**打开**。

5.  在**常规**选项卡上，确认列下**生效**日期是今天的日期。 如果没有，你可能会选择正确的证书。

6.  单击**确定**以关闭该证书。

7.  关闭证书管理单元中。

## 下一步
[第 3 步。为始终启用 VPN 配置远程访问服务器](vpn-deploy-ras.md)： 在此步骤中，你配置远程访问 VPN 允许 IKEv2 VPN 连接、 拒绝连接其他 VPN 协议，并将颁发的 IP 地址静态 IP 地址池分配给连接授权的 VPN 客户端。







---
