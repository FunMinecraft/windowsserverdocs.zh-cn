---
title: 设置 Hyper-V 副本
ms.technology: compute-hyper-v
description: 有关设置副本，测试故障转移，并且第一个复制提供的说明。
ms.prod: windows-server-threshold
ms.service: na
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: KBDAzure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: b8dcf23946d99509aafba0f8af58bf633bedd069
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/20/2019
ms.locfileid: "67280234"
---
# <a name="set-up-hyper-v-replica"></a>设置 Hyper-V 副本

>适用于：Windows Server 2016

Hyper-V 副本是 Hyper-V 角色不可或缺的组成部分。 它有助于您的灾难恢复策略，从一台 HYPER-V 主机服务器的虚拟机复制到另一个用来使可用工作负荷。  HYPER-V 副本创建到副本脱机虚拟机的实时虚拟机的副本。 请注意以下事项：  

-   **HYPER-V 主机**:主要和辅助主机服务器可以在物理上位于或位于不同的地理位置，使用通过 WAN 复制链接。 HYPER-V 主机可以是独立的群集化或两者的混合。 在服务器之间没有任何 Active Directory 依赖关系，它们无需成为域成员。  

-   **复制和更改跟踪**:当为特定的虚拟机启用 HYPER-V 副本时，初始复制的辅助主机服务器上创建完全相同副本虚拟机。 发生这种情况后，HYPER-V 副本的更改跟踪创建并维护虚拟机 VHD 上的更改捕获的日志文件。 日志文件会按相反的顺序播放到副本 VHD 根据复制频率设置。 这意味着存储和异步复制的最新更改。 复制可以通过 HTTP 或 HTTPS。  

-   **扩展 （链接） 复制**:这允许您从主主机到辅助数据库承载第三个托管的辅助主机，然后复制复制的虚拟机。 请注意不能复制从主主机直接到第二个和第三个。  

    此功能使 HYPER-V 副本更可靠的灾难恢复，因为发生中断时可以从此主要和扩展副本。  你可以故障转移到扩展副本如果主要和辅助位置停机。 请注意，扩展的副本不支持应用程序一致的复制，并且必须使用辅助副本正在使用的 Vhd。  

-   **故障转移**:如果在主节点中发生中断 （或辅助数据库的情况下扩展） 位置可以手动启动测试、 计划外故障转移。  

    ||测试|已计划|计划外|  
    |-|--------|-----------|-------------|  
    |我应何时运行？|验证虚拟机可以故障转移并启动辅助站点中<br /><br />可用于测试和培训|在计划的停机时间和服务中断期间|意外事件期间|  
    |创建重复的虚拟机？|是|否|否|  
    |启动其中？|副本虚拟机上|在主计算机上启动，在辅助计算机上完成|副本虚拟机上|  
    |我应运行频率如何？|我们建议每隔一个月进行测试|一次每六个月或根据法规遵从性要求|仅在发生灾难时主虚拟机将不可用|  
    |主虚拟机是否继续复制？|是|是。 中断问题后解决所做的更改回主站点，以便同步主要和次要的反向复制复制。|否|  
    |是否有任何数据丢失？|无|无。 故障转移后的 HYPER-V 副本将最后一组跟踪的更改复制回主以确保零数据丢失。|取决于事件和恢复点|  
    |有无任何故障时间？|无。 它不会影响生产环境。 在故障转移期间创建一个重复的测试虚拟机。 您选择的故障转移完成后**故障转移**在副本上的虚拟机和它已自动清理并删除。|计划内故障时间的持续时间|计划外中断的持续时间|  

-   **恢复点**:在配置的虚拟机的复制设置，指定您想要从其存储的恢复点。 恢复点表示的时间可以从中恢复的虚拟机的快照。 如果从最近的恢复点恢复，显然更少的数据将丢失。 你可以访问恢复点最多 24 小时前。  

## <a name="deployment-prerequisites"></a>部署先决条件  
下面是您应该验证在开始之前：  

-   **找出哪些 Vhd 需要复制**。 具体而言，Vhd 的包含很快更改且后应从以节省网络带宽的复制中排除故障转移，如页面文件磁盘，不使用副本服务器的数据。 记的下 Vhd 可以排除之外。  

-   **确定所需同步数据的频率**:副本服务器上的数据被同步更新根据复制频率配置 （30 秒、 5 分钟或 15 分钟）。 您选择的频率应考虑以下方面：虚拟机运行的关键数据具有较低 RPO？ 您带宽考虑事项是什么？  高度关键虚拟机将很明显需要更频繁地复制。  

-   **决定如何恢复数据**:默认情况下的 HYPER-V 副本仅存储最新的复制从主数据库发送到辅助数据库的单个恢复点。 但是如果你想要在时间中恢复到以前的点的数据的选项可以指定其他恢复点，应存储 （到 24 小时的点的最大）。 如果需要其他恢复点应注意，这需要更多的开销在处理和存储资源。  

-   **找出要复制哪些工作负荷**:标准 HYPER-V 副本复制维护虚拟机上运行的故障转移后，虚拟机操作系统的状态，但不是应用程序的状态保持一致。 如果您希望能够恢复工作负荷状态来创建应用程序一致恢复点。 请注意，应用程序一致的恢复无法使用扩展的副本站点上如果使用的扩展 （链接） 的复制。  

-   **决定如何执行初始复制的虚拟机数据**:通过将传输需要传输虚拟机的当前状态将开始复制。 这种初始状态可以通过现有网络直接传输，立即或你进行配置的稍晚时间均可。 您还可以作为初始副本使用预先存在的已还原的虚拟机 （例如，如果你已还原副本服务器上的虚拟机的以前的备份）。 或者，你可以将初始副本复制到外部媒体，然后以物理方式向副本站点传递媒体，这样能够节省网络带宽。  如果你想要使用预先存在的虚拟机中删除与之关联的所有以前的快照。  

## <a name="deployment-steps"></a>部署步骤  

### <a name="step-1-set-up-the-hyper-v-hosts"></a>第 1 步：设置 HYPER-V 主机  
你将需要至少两个与每个服务器上的一个或多个虚拟机的 HYPER-V 主机。 [开始使用 HYPER-V](../get-started/Get-started-with-Hyper-V-on-Windows.md)。 将复制到的虚拟机的主机服务器将需要将设置为副本服务器。  

1.  在服务器的 HYPER-V 设置中将虚拟机复制到，在**复制配置**，选择**启用这台计算机作为副本服务器**。  

2.  您可以通过 HTTP 或加密的 HTTPS 来复制。 选择**使用 Kerberos (HTTP)** 或**使用基于证书的身份验证 (HTTPS**)。 默认情况下 HTTP 80 和 HTTPS 443 启用为副本的 HYPER-V 服务器上的防火墙例外。 如果您更改默认端口设置需要还可以更改防火墙例外。 如果要通过 HTTPS 进行复制，将需要选择一个证书，并应具有证书身份验证设置。  

3.  对于授权，请选择**允许从任何经过身份验证服务器进行复制**以便副本服务器为接受来自任何成功进行身份验证的主服务器的虚拟机复制流量。 选择**允许从指定的服务器进行复制**接受仅来自专门选择的主服务器的流量。  

    对于这两个选项可以指定已复制的 Vhd 存储在副本 HYPER-V 服务器上的位置。  

4.  单击“确定”  或“应用”  。  

### <a name="step-2-set-up-the-firewall"></a>步骤 2：设置防火墙  
若要允许在主要和辅助服务器之间的复制，流量必须通过 Windows 防火墙 （或任何其他第三方防火墙） 获取。 当您在通过 HTTP (80) 的默认情况下将在服务器上安装 HYPER-V 角色并创建 HTTPS (443)。 如果您使用这些标准端口，您只需启用规则：  

-  若要启用独立的主机服务器上的规则：  

    1. 打开高级安全 Windows 防火墙，并单击**入站规则**。  

    2. 若要启用 HTTP (Kerberos) 身份验证，请右键单击**HYPER-V 副本 HTTP 侦听器 (Tcp-in)**  >**启用规则。** 若要启用 HTTPS 基于证书的身份验证，请右键单击**HYPER-V 副本 HTTPS 侦听器 (Tcp-in)** > E **$ 启用规则**。  

-  若要启用的 HYPER-V 群集上的规则，请打开 Windows PowerShell 会话中使用**以管理员身份运行**，然后运行以下命令之一：  

    -   为 HTTP:  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`  

    -   为 HTTPS: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`  

### <a name="enable-virtual-machine-replication"></a>启用虚拟机复制  
执行每个想要复制的虚拟机上的下列操作：  

1.  在中**详细信息**的 HYPER-V 管理器窗格中单击以选择虚拟机。  
    右键单击所选的虚拟机，然后单击**启用复制**以打开启用复制向导。  

2.  在 **“开始之前”** 页上，单击 **“下一步”** 。  

3.  上**指定副本服务器**页上，在副本服务器中，输入 NetBIOS 或副本服务器的 FQDN。 如果副本服务器是故障转移群集的一部分，输入 HYPER-V 副本代理的名称。 单击“下一步”  。  

4.  上**指定连接参数**页上，HYPER-V 副本会自动检索为副本服务器配置的身份验证和端口设置。 如果值不是检索的检查服务器配置为副本服务器，并且在 DNS 中注册。 如果所需的类型的设置中手动。  

5.  上**选择复制 Vhd**页上，请确保你想要复制的 Vhd 都已选中，清除你想要从复制中排除任何 Vhd 的复选框。 然后，单击“下一步”  。  

6.  上**配置复制频率**页上，指定何种频率应为次要副本从主同步更改。 然后，单击“下一步”  。  

7.  上**配置其他恢复点**页上，选择你想要保持仅最新恢复点，或创建其他点。    如果你想要一致地恢复应用程序，并且有其自己 VSS 编写器，我们建议你的工作负荷选择**卷影复制服务 (VSS) frequenc**y 并指定创建的应用一致性快照频率。 请注意，必须在这两个主要和辅助 HYPER-V 服务器上运行的 HYPER-V VMM 请求程序服务。 然后，单击“下一步”  。  

8.  上**选择初始复制**页上，选择要使用的初始复制方法。  通过网络连接选择默认设置，发送初始副本通过网络将复制主虚拟机配置文件 (VMCX) 和虚拟硬盘文件 （VHDX 和 VHD）。 如果您将使用此选项，请验证网络带宽可用性。 如果主虚拟机已配置为复制的虚拟机在辅助站点上它可用于选择**复制服务器上使用现有的虚拟机作为初始副本**。 可以使用 HYPER-V 导出导出主虚拟机并将其作为辅助服务器上的副本虚拟机导入。 可以为更大的虚拟机或有限的带宽选择进行初始复制通过网络在更高版本时，会出现，然后配置非高峰时间，或以脱机媒体的形式发送的初始复制信息。  

    如果执行脱机复制会传输初始副本的辅助服务器使用硬盘或 USB 驱动器等外部存储介质。 若要这样做将需要连接外部存储添加到主服务器 （或在群集中的所有者节点），然后选择发送初始副本使用外部媒体本地或外部媒体上，可以指定一个位置可以存储的初始副本。  在副本站点上创建占位符虚拟机。 初始复制完成后的外部存储可以运送到副本站点中。 存在将连接外部媒体到辅助服务器或辅助群集的所有者节点。 然后将导入到指定位置的初始副本，并将其合并到占位符虚拟机。  

9. 上**完成启用复制**页上，查看摘要中的信息，然后单击**完成。** 。 将根据你所选的设置传输虚拟机数据。 并会出现一个对话框，指示已成功启用复制。  

10. 如果你想要配置扩展 （链接） 的复制，打开副本服务器，并右键单击想要复制的虚拟机。 单击**复制** > **扩展复制**并指定复制设置。  

## <a name="run-a-failover"></a>运行故障转移  
完成这些部署步骤后，你已复制的环境已启动并运行。 现在可以根据需要运行故障转移。  

**测试故障转移**:如果你想要运行主虚拟机的测试故障转移右键单击并选择**复制** > **测试故障转移**。 如果配置，请选择最新或其他恢复点。 将创建并在辅助站点上启动新的测试虚拟机。 测试完成后，选择**停止测试故障转移**进行清理在副本虚拟机上。 请注意，您可以只运行一个虚拟机的测试故障转移一次。 [阅读更多](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx)。  

**计划的故障转移**:若要运行主虚拟机的计划的故障转移右键单击并选择**复制** > **计划的故障转移**。 计划的故障转移执行先决条件检查，以确保零数据丢失。 它会检查开始故障转移前关闭主虚拟机。 虚拟机故障转移后，它会开始将更改复制回主站点中可用时。 请注意，为实现此目的的主服务器应配置为接收复制中，从辅助服务器或 HYPER-V 副本代理在主群集的情况下。 计划内故障转移发送最后一个设置的跟踪的更改。 [阅读更多](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx)。  

**计划外故障转移**:若要运行非计划故障转移，副本虚拟机上右键单击并选择**复制** > **计划外故障转移**从 HYPER-V 管理器或故障转移群集管理器。 如果启用此选项，可以恢复从最新恢复点或从以前的恢复点。 故障转移后，检查一切是否正常工作按预期方式上已故障转移的虚拟机，然后单击**完成**副本虚拟机上。 [阅读更多](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx)。  
