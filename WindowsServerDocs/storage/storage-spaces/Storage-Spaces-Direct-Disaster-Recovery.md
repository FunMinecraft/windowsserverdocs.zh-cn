---
title: 超聚合基础结构的灾难恢复方案
ms.prod: windows-server-threshold
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: johnmarlin-msft
ms.date: 03/29/2018
description: 本文介绍了适用于今天的 Microsoft HCI （存储空间直通） 的灾难恢复方案
ms.localizationpriority: medium
ms.openlocfilehash: 32bbf02ca78d5c6a2147162768c984d0e0b27e36
ms.sourcegitcommit: dfd25348ea3587e09ea8c2224237a3e8078422ae
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/16/2018
ms.locfileid: "4678606"
---
# 使用存储空间直通的灾难恢复

> 适用于： Windows Server 2019、 Windows Server 2016

本主题提供如何超级集成基础架构 (HCI) 上的方案可以配置为灾难恢复。

多家公司正在运行的超聚合解决方案和规划灾难使能够保留在或到生产发生在发生灾难时快速获取。 有多种方法可用于进行灾难恢复配置 HCI 和本文档介绍了目前适用于你的选项。

当讨论的灾难发生时还原可用性围绕什么已知的恢复时间目标 (RTO)。 这是时间的面向必须还原服务以避免对业务的全方位后果的持续时间。 在某些情况下，此过程可以与生产几乎立即还原自动发生。 在其他情况下，必须进行手动管理员干预以还原服务。

目前使用超聚合的灾难恢复选项：

1. 多个群集使用存储副本
2. 群集之间的 HYPER-V 副本
3. 备份和还原

## 多个群集使用存储副本

[存储副本](../storage-replica/storage-replica-overview.md)允许卷的复制，并支持同步和异步复制。 当使用同步或异步复制之间进行选择，你应该考虑你的恢复点目标 (RPO)。 恢复点目标是可能会丢失数据愿意会产生才会被认为主要丢失的量。 如果使用同步复制，它将按顺序写入两端在同一时间。 如果使用异步，写入将非常快速复制，但仍可能丢失。 你应该考虑以查看其最适用于你的应用程序或文件的用法。

存储副本是块级别复制机制与文件级别;这意味着，它并不重要被复制的数据的类型。 这使超聚合基础结构的常用选项。 存储副本还可以利用不同类型的驱动器之间复制合作伙伴，因此让所有的一种类型存储在一个 HCI 和其他的另一个类型存储是完全合适。 

存储副本的一个重要功能是，它可以运行在 Azure 以及在本地。 你可以设置的本地本地的 Azure 到 Azure 或甚至在本地到 Azure （反之亦然）。

在此方案中，有两个独立的独立群集。 用于配置 HCI 之间的存储副本，你可以按照[群集到群集存储复制](../storage-replica/cluster-to-cluster-storage-replication.md)中的步骤。

![存储复制图示](media\storage-spaces-direct-disaster-recovery\Disaster-Recovery-Figure1.png)

部署存储副本时，应考虑以下注意事项。 

1.  配置复制完成之外故障转移群集。 
2.  选择复制的方法将取决于你的网络延迟和 RPO 要求。 同步复制与故障一致性，以不确保一次失败的任何数据丢失的低延迟网络上的数据。 异步复制，通过网络与较长的延迟，但每个站点的数据可能没有完全相同副本故障一次。 
3.  灾难，故障转移群集之间自动并不需要通过存储副本 PowerShell cmdlet 手动进行协调。 在上图中中, ClusterA 是主并且 ClusterB 辅助。 如果 ClusterA 出现故障，你需要手动设置为主要 ClusterB 之前可以弹出资源。 备份 ClusterA 后，你需要使其辅助。 后的所有数据已被都同步设置，请进行更改和交换返回到最初设置的方式的角色。
4.  存储副本仅复制数据，因为新的虚拟机或比例出文件服务器 (SOFS) 利用此数据将需要创建内故障转移群集管理器中的副本合作伙伴。

如果你有虚拟机或群集上运行 SOFS，可以使用存储副本。 引入副本 HCI 联机资源可以手动或自动使用 PowerShell 脚本。

## Hyper-V 副本

[HYPER-V 副本](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/set-up-hyper-v-replica)上的超聚合基础架构提供针对灾难恢复的虚拟机级别复制。 HYPER-V 副本可以执行的操作是以获取虚拟机，并将其复制到辅助站点或 Azure （副本）。 然后从辅助站点，HYPER-V 副本可以复制虚拟机到第三个 （扩展副本）。

![HYPER-V 复制关系图](media\storage-spaces-direct-disaster-recovery\Disaster-Recovery-Figure2.png)

使用 HYPER-V 副本，复制负责通过 HYPER-V。 当你首次启用复制在虚拟机时，有三个选择希望初始复制如何发送到相应的副本簇。

1.  通过网络发送初始复制
2.  将初始复制发送到外部的媒体，以便它可以手动复制到你的服务器
3.  使用现有虚拟机上的副本主机已创建

另一个选项是当你想此初始复制应发生的位置。

1.  立即开始复制
2.  安排初始复制发生的时间。 

你将需要其他注意事项包括：

- 哪些 VHD/VHDX 的想要复制。 你可以选择复制所有这些或仅两者之一。
- 你想要保存的恢复点的数量。 如果你想要有关于哪些你想要还原的时间点的多个选项，然后你想要指定你希望多少。 如果你仅希望一个还原点，你可以将，以及选择。
- 频率你想要有卷影复制服务 (VSS) 复制的增量卷影副本。
- 频率更改复制 （30 秒，5 分钟，15 分钟）。

当 HCI 参与 HYPER-V 副本时，必须在每个群集中创建[的 HYPER-V 副本代理](https://blogs.technet.microsoft.com/virtualization/2012/03/27/why-is-the-hyper-v-replica-broker-required/)资源。 此资源执行以下操作：

1.  为你提供单个命名空间为 HYPER-V 副本连接到每个群集。
2.  确定当它首次接收副本驻留的副本 （或扩展的副本） 将该群集中的节点。
3.  跟踪的哪个节点拥有的副本 （或扩展的副本），以防虚拟机将移动到另一个节点。 它需要，以便进行复制时，它可以将信息发送到正确的节点来跟踪到期。

## 备份和恢复

一个传统的灾难恢复选项，不讨论过太大，但同样重要是整个群集或群集中的节点的故障。 此方案中使用其中的任一选项将使用 Windows NT 备份。 

它始终是具有超级集成基础架构的定期备份的建议。 运行群集服务时，如果你花一系统状态备份，群集注册表数据库将该备份的一部分。 还原群集或数据库有两个不同的方法 （非授权和授权）。

### 非权威

非权威还原，可以使用 Windows NT 备份和等同于的只是在群集节点本身完全恢复。 如果你仅需要还原群集节点 （和群集注册表数据库），并且所有当前群集信息良好，你将还原使用非授权。 可以通过 Windows NT 备份界面或命令行 WBADMIN 完成非权威恢复。EXE。

一旦你还原节点，使其加入群集。 将发生什么情况是信息的，它将转到现有运行群集出，使用什么是信息的有当前更新其所有。

### 授权

群集配置，授权还原另一方面，采用群集配置重新登录时间。 当群集信息本身具有已丢失，并且需要还原，仅应实现此类型的还原。 例如，有人意外删除包含 1000年共享文件服务器和返回需要它们。 完成授权还原群集的要求，从命令行运行备份。

授权还原群集节点上启动后，在群集视图中的所有其他节点上停止的群集服务和冻结群集配置。 这是为何很重要以便使用新的群集配置副本形成群集，首次启动还原已在其执行的节点上的群集服务。

若要运行的授权还原，即可完成以下步骤。

1.  运行 WBADMIN。通过管理命令提示符的 EXE 以获取最新版本的备份你想要安装，并确保系统状态的组件之一，你可以还原。

    ```powershell
    Wbadmin get versions
    ```

2.  确定是否有版本备份作为组件中具有群集注册表信息。 有几项你将需要从版本和应用程序/组件在步骤 3 中使用此命令。 对于版本，例如，假设备份已在凌晨 2:04 执行 2018 年 1 月 3，并且这是的一个需要还原。

    ```powershell
    wbadmin get items -backuptarget:\\backupserver\location
    ```

3.  开始菜单授权恢复恢复只需要在群集注册表版本。 

    ```powershell
    wbadmin start recovery -version:01/03/2018-02:04 -itemtype:app -items:cluster
    ```

一旦还原已发生，此节点必须是首次启动群集服务和形成群集。 所有其他节点然后需要启动并加入群集。

## 摘要 

若要对所有最多，超聚合灾难恢复是应仔细查看计划的某些内容。 有几种方案最适合你的需求，应全面测试。 需要注意的一项是，如果你熟悉故障转移群集在过去，拉伸群集已经年时间里非常受欢迎的选择。 没有少量设计更改超聚合解决方案，并且它基于复原。 如果你丢失的超聚合群集中的两个节点，整个群集将奔溃。 与此正在的情况下，在超聚合环境中，不支持拉伸的方案。


