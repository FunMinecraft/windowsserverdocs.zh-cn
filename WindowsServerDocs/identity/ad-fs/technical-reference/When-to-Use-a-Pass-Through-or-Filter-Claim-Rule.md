---
ms.assetid: 606df285-259c-4c6b-8583-9aca1d614c43
title: 何时使用传递或筛选声明规则
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: aa205c46bf67dc25a55232b799bdd39fee4ac3c6
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59812208"
---
>适用于：Windows Server 2016 中，Windows Server 2012 R2、 Windows Server 2012

# <a name="when-to-use-a-pass-through-or-filter-claim-rule"></a>何时使用传递或筛选声明规则
可以在 Active Directory 联合身份验证服务中使用此规则\(AD FS\)需要采用特定的传入声明类型，然后应用一项操作，以确定应出现的输出基于传入声明中的值。 使用此规则时，将根据你在此规则中配置的任一选项传递或筛选与下表中的规则逻辑匹配的任何声明。  
  
|规则选项|规则逻辑|  
|---------------|--------------|  
|传递所有声明值|如果传入声明类型等于*指定的声明类型* 并且值等于*任意值*，则传递该声明|  
|仅传递特定的声明值|如果传入声明类型等于*指定的声明类型* 并且值等于*指定的声明值*，则传递该声明|  
|仅匹配特定电子的声明值直通\-邮件后缀值|如果传入声明类型等于*指定的声明类型* 并且值等于*指定的后缀值*，则传递该声明|  
|仅传递以特定值开头的声明值|如果传入声明类型等于*指定的声明类型* 并且值以*指定的声明值* 开头，则传递该声明|  
  
以下部分提供了声明规则的基本介绍，并提供了有关何时使用此规则的更多详细信息。  
  
## <a name="about-claim-rules"></a>关于声明规则  
声明规则表示业务逻辑，使用传入声明、 向它应用条件的实例\(if x，then y\)和生成传出声明基于条件参数。 下面的列表概述了在进一步阅读本主题中的内容之前应了解的有关声明规则的重要提示：  
  
-   在 AD FS 管理管理单元\-中，声明只可以使用声明规则模板创建规则  
  
-   声明规则过程传入声明既可以直接从声明提供程序\(Active Directory 或另一个联合身份验证服务等\)或输出中的接受转换规则声明提供方信任上的。  
  
-   声明规则由声明颁发引擎按给定规则集内的时间顺序处理。 通过为规则设置优先级，可以进一步优化或筛选由给定规则集内以前的规则生成的声明。  
  
-   声明规则模板始终要求你指定传入声明类型。 但是，你可以使用单个规则处理声明类型相同的多个声明值。  
  
有关详细信息有关声明规则和声明规则集的详细信息，请参阅[规则的角色声明](The-Role-of-Claim-Rules.md)。 有关如何处理规则的详细信息，请参阅[The Role of the Claims Engine](The-Role-of-the-Claims-Engine.md)。 有关如何处理声明规则集的详细信息，请参阅[声明管道的角色](The-Role-of-the-Claims-Pipeline.md)。  
  
## <a name="pass-through-all-claim-values"></a>传递所有声明值  
使用此操作时，将指定声明类型的所有传入声明值作为传出声明传递。 例如，当传入声明类型指定为“角色”声明类型时，将所有传入声明值逐个复制到传出声明类型为“角色”的新传出声明中。  
  
## <a name="filtering-a-claim"></a>筛选声明  
在 AD FS 中，术语*声明筛选*指筛选或限制传入声明值，以便仅将特定值是传递或作为传出声明发送。 “传递或筛选传入声明”规则模板使该功能变为可能。 在此规则的属性内，你可以设置传入值筛选条件，以便仅传递满足指定条件的值。  
  
例如，如果传入声明类型与“角色”声明类型匹配，或者你可能只想发出有关用户姓名的声明，而不发出包含用户身份证号的声明，则可以使用此规则仅传递与声明值“Purchaser”匹配的声明。  
  
如果将某个筛选条件与此规则结合使用，将检查所有传入声明，以确定与该规则所设条件匹配的声明。 忽略其他所有声明，以便仅传递与所选声明类型匹配的指定声明值。  
  
例如下, 图中所示，当为规则设置与条件来筛选传入声明进行键控的 upn 声明类型还开头和结尾@fabrikam.com，除非满足此条件，否则，将忽略其他所有传入声明。 这包括具有 E 的声明类型的传入声明\-即使其声明值中结束的邮件地址@fabrikam.com。 在此情况下，仅包含值的声明Nick@fabrikam.com发送到信赖方。  
  
![何时使用传递通过](media/adfs2_filter.gif)  
  
## <a name="configuring-this-rule-on-a-claims-provider-trust"></a>对声明提供程序信任配置此规则  
使用声明提供程序信任时，可以将此规则配置为仅传递来自与特定约束匹配的声明提供程序的传入声明。 例如，你可能想要仅接受电子\-邮件来自声明提供程序的声明; 因此，您将使用此规则模板接受电子\-邮件结束声明提供程序的域名系统中的声明类型\(DNS\)名称。  
  
## <a name="configuring-this-rule-on-a-relying-party-trust"></a>对信赖方信任配置此规则  
使用信赖方信任时，可以将此规则配置为传递或筛选将发送给信赖方的传出声明。 某些信赖方可能不了解某些声明类型，或者某些声明可能包含不应发送给某些信赖方的敏感信息。 此规则模板可帮助为特定的信赖方信任强制实施这些策略。  
  
## <a name="how-to-create-this-rule"></a>如何创建此规则  
要创建此规则使用声明规则语言或使用传递或筛选 AD FS 管理管理单元中的传入声明规则模板\-中。 此规则模板提供以下配置选项：  
  
-   指定声明规则名称  
  
-   指定传入声明类型  
  
-   传递所有声明值  
  
-   仅传递特定的声明值  
  
-   仅匹配特定电子的声明值直通\-邮件后缀值  
  
-   仅传递以特定值开头的声明值  
  
有关如何创建此模板的详细说明，请参阅[创建规则，以便传递或筛选传入声明](https://technet.microsoft.com/library/dd807060.aspx)AD FS 部署指南中。  
  
## <a name="using-the-claim-rule-language"></a>使用声明规则语言  
如果仅在声明值与自定义模式匹配时才发送声明，则必须使用自定义规则。 有关详细信息，请参阅“何时使用自定义规则”。  
  
### <a name="examples-of-how-to-construct-a-pass-through-or-filter-rule-syntax"></a>有关如何构造传递或筛选规则语法的示例  
简单的筛选规则就是基于上述属性之一筛选声明。 例如，以下规则将传递到所有 e\-邮件声明：  
  
```  
c:[type == “http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress”]  => issue(claim  = c);  
```  
  
筛选器可以从逻辑上与\-ed 组合在一起。 例如，以下规则将接受所有电子\-邮件声明值 johndoe@fabrikam.com:  
  
```  
c:[type == “http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress”, value == “johndoe@fabrikam.com “]  => issue(claim  = c);  
```  
  
在上述示例中，筛选器始终使用相等运算符。 声明规则语言支持下列运算符：  
  
-   \=\= \- 等于\(用例\-敏感\)  
  
-   \!\= \- 不等于\(用例\-敏感\)  
  
-   \=~\- 正则表达式匹配  
  
-   \!~ \- 正则表达式非\-匹配  
  
例如，以下规则将接受所有电子\-邮件并非由本地联合服务器颁发的声明具有后缀为 boeing.com 的：  
  
```  
c:[type == “http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress”, value =~ “^.*@boeing\.com$” , issuer != “LOCAL AUTHORITY”]  => issue(claim  = c);  
```  
  
### <a name="best-practices-for-creating-custom-rules"></a>创建自定义规则的最佳做法  
可以向每个声明的一个或多个属性应用筛选器，如下表所述。  
  
|声明属性|描述|  
|------------------|---------------|  
|在任务栏的搜索框中键入|声明类型\(通常表示为一个 Uri\)反映了有关在声明中传达的信息类型联合中的合作伙伴之间的隐式协议。 例如，声明的类型为 http:\/\/schemas.xmlsoap.org\/ws\/2005年\/05\/标识\/声明\/电子邮件地址将包含电子\-邮件地址的用户。|  
|ReplTest1|声明的值。 例如，一个声明的类型为 http:\/\/schemas.xmlsoap.org\/ws\/2005年\/05\/标识\/声明\/电子邮件地址可能具有的值 johndoe@fabrikam.com|  
|ValueType|ValueType 表示如何解释声明值中包含的信息。 通常，ValueType 将设置为 http:\/\/www.w3.org\/2001年\/XMLSchema\#字符串，但声明值可以包含 Base64Binary 编码数据\(例如，图像\)或日期、 布尔值，依次类推。|  
|颁发者|发出方表示上一次发出有关用户的声明的参与方。 如果声明是从声明提供程序联合服务器获取的，则所有声明的发出方都将设置为“本地机构”。 如果声明由联合提供程序联合服务器接收，则声明的发出方将设置为已对令牌签名的声明提供程序的声明提供程序标识符。 因此，当处理从声明提供程序收到的声明上的规则时，所有声明的发出方都将设置为相同的值。 为信赖方创作规则时，可使用 issuer 属性来区分来自不同声明提供程序的声明。|  
|OriginalIssuer|此声明属性旨在说明最初发出声明的联合服务器。 由于声明的 issuer 属性设置到最后一个已对令牌签名的联合身份验证服务器，是可在其中声明已流经多个联合身份验证服务器的方案中的原始颁发者\(例如，将收到一个令牌的信赖方从联合身份验证提供程序联合身份验证服务器可能会对感哪些特定声明提供程序联合身份验证服务器用户进行身份验证\)|  
|属性|除上述五种属性外，每个声明还有一个可以存储命名属性的属性包。 这些属性在令牌中不会序列化，只能用于在单台联合服务器范围内的声明发出管道的组件之间传递信息。 例如，在声明提供程序规则处理然后在信赖方规则中引用属性的过程中设置该属性。|  
  

