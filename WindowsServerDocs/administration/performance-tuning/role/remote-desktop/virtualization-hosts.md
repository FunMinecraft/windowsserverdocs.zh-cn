---
title: 性能优化远程桌面虚拟化主机
description: 远程桌面虚拟化主机的性能优化
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 0aa359644f5e9bf85f4e013e6571276716ed0218
ms.sourcegitcommit: d84dc3d037911ad698f5e3e84348b867c5f46ed8
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/28/2019
ms.locfileid: "66266617"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>性能优化远程桌面虚拟化主机


远程桌面虚拟化主机 （RD 虚拟化主机） 是一种角色服务，支持虚拟桌面基础结构 (VDI) 方案，允许运行的服务器上托管的虚拟机中运行基于 Windows 的应用程序的多个并发用户Windows Server 2016 和 HYPER-V。

Windows Server 2016 支持两种类型的虚拟机、 个人虚拟桌面和共用虚拟机。

**本主题内容：**

-   [一般注意事项](#general)

-   [性能优化](#perfopt)

## <a href="" id="general"></a>一般注意事项


### <a name="storage"></a>存储

存储是最有可能的性能瓶颈，并且必须调整你的存储能够正确处理生成的虚拟机状态更改的 I/O 负载的大小。 如果试点或模拟不可行，比较好的原则是预配一个驱动器主轴的四个活动的虚拟机。 使用具有良好的写入性能 （如 RAID 1 + 0） 的磁盘配置。

如果合适，使用磁盘重复数据删除和缓存以减少磁盘读取的负载并启用存储解决方案来提高性能速度通过缓存的图像的重要部分。

### <a name="data-deduplication-and-vdi"></a>重复数据删除和 VDI

在 Windows Server 2012 R2 中引入，重复数据删除支持打开文件的优化。 若要使用已删除重复卷上运行的虚拟机，需要存储在单独的主机中的 HYPER-V 主机上虚拟机文件。 如果在同一台计算机上运行的 HYPER-V 和重复数据删除，这两项功能将争用系统资源，并对整体性能产生负面影响。

卷还必须配置为使用"虚拟桌面基础结构 (VDI)"重复数据删除优化类型。 可以使用服务器管理器配置此 (**文件和存储服务** - &gt; **卷** - &gt; **重复数据删除设置**)或通过使用以下 Windows PowerShell 命令：

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!Note]
> 打开文件的数据重复数据删除优化仅支持 VDI 方案具有通过 SMB 3.0 使用远程存储的 HYPER-V。

### <a name="memory"></a>内存

服务器内存使用情况由三个主要因素驱动：

-   操作系统的开销

-   开销每个虚拟机的 HYPER-V 服务

-   分配给每个虚拟机的内存

对于典型的知识辅助工作负荷，来宾虚拟机正在运行 x86 Window 8 或 Windows 8.1 应授予 ~ 512 MB 的内存中作为基线虚拟机。 但是，动态内存可能会增加到大约 800 MB，取决于工作负荷的来宾虚拟机的内存。 对于 x64，我们请参阅有关 800 MB 启动增加为 1024 MB。

因此，务必提供服务器内存不足，无法满足预期的来宾虚拟机数所需的内存以及服务器允许足够的内存量。

### <a name="cpu"></a>CPU

当计划的 RD 虚拟化主机服务器的服务器容量时，每个物理核心的虚拟机数将依赖于工作负荷的性质。 作为起点，有理由计划每个物理核心，12 的虚拟机，然后运行相应的方案，以验证性能和密度。 可能根据工作负荷的具体情况可实现更高的密度。

我们建议启用超线程，但请确保计算基于物理内核数和未逻辑处理器数的过度订阅比率。 这可确保预期的每个 CPU 上的性能级别。

### <a name="virtual-gpu"></a>虚拟 GPU

RD 虚拟化主机的 Microsoft RemoteFX 提供了丰富图形体验，为虚拟桌面基础结构 (VDI) 通过主机端远程处理、 呈现捕获编码管道、 极为高效 gpu 编码、 限制基于客户端活动，并支持 DirectX 的虚拟 GPU。 RD 虚拟化主机的 RemoteFX 会从 DirectX9 虚拟 GPU 升级到 DirectX11 中。 它还可以通过支持多个监视器在较高的分辨率提高用户体验。

提供无需任何通过软件模拟驱动程序硬件 GPU，RemoteFX DirectX11 体验。 虽然此软件 GPU 提供了很好的体验，RemoteFX 虚拟图形处理单元 (VGPU) 将硬件加速体验添加到虚拟机。

若要利用下运行 Windows Server 2016 的服务器上的 RemoteFX VGPU 体验，您需要的 GPU 驱动程序 （如 DirectX11.1 或 WDDM 1.2） 的主机服务器上。 有关要与 RemoteFX 一起用于 RD 虚拟化主机的 GPU 产品/服务详细信息，请联系您 GPU 的提供程序。

如果在 VDI 部署中使用 RemoteFX 虚拟 GPU，部署容量将差异取决于使用方案和硬件配置。 当你计划你的部署时，考虑以下方面：

-   在系统上的 Gpu 数

-   在 Gpu 上的视频内存容量

-   在系统上的处理器和硬件资源

### <a name="remotefx-server-system-memory"></a>RemoteFX 服务器系统内存

为每个虚拟桌面，启用了虚拟 GPU，RemoteFX 使用系统内存，来宾操作系统中和已启用 RemoteFX 的服务器中。 虚拟机监控程序保证来宾操作系统的系统内存的可用性。 在服务器上，每个虚拟启用了 GPU 的虚拟桌面需要播发到虚拟机监控程序其系统内存要求。 当正在启动虚拟启用了 GPU 的虚拟机时，虚拟机监控程序保留 VGPU 启用虚拟桌面在已启用 RemoteFX 的服务器中的额外的系统内存。

已启用 RemoteFX 的服务器的内存要求是内存的动态的因为已启用 RemoteFX 的服务器上占用量是内存的依赖于与 VGPU 启用虚拟桌面和最大分辨率为相关联的监视器的数目这些监视器。

### <a name="remotefx-server-gpu-video-memory"></a>RemoteFX 服务器 GPU 视频内存

每个虚拟启用了 GPU 的虚拟桌面使用的视频内存的主机服务器上的 GPU 硬件呈现到桌面。 除了呈现视频内存用于的编解码器压缩呈现的屏幕。 所需内存量直接取决于预配到虚拟机的监视器的量。

监视器和系统屏幕分辨率的数量根据保留的视频内存而异。 某些用户可能需要较高的屏幕分辨率为特定任务。 如果所有其他设置保持不变，则使用较低的分辨率设置更高的可伸缩性。

### <a name="remotefx-processor"></a>RemoteFX 处理器

虚拟机监控程序计划已启用 RemoteFX 的服务器和在 CPU 上的虚拟已启用 GPU 的虚拟桌面。 与不同的系统内存中，没有与 RemoteFX 虚拟机监控程序与共享所需的其他资源相关的信息。 运行虚拟 GPU 驱动程序和用户模式下远程桌面协议堆栈与相关的额外 CPU 开销 RemoteFX 将纳入虚拟启用了 GPU 的虚拟桌面。

在已启用 RemoteFX 的服务器上，开销将增加，因为系统在运行附加的进程 (rdvgm.exe) 每个虚拟启用了 GPU 的虚拟桌面。 此过程使用图形设备驱动程序在 GPU 上运行命令。 编解码器还使用 Cpu 的压缩需要发送回客户端的屏幕数据。

更多虚拟处理器意味着更好的用户体验。 我们建议分配至少两个虚拟 Cpu，每个虚拟启用了 GPU 的虚拟桌面。 我们还建议使用 x64 体系结构为虚拟启用了 GPU 的虚拟机由于虚拟机进行更好地比较为 x86，x64 上的性能虚拟机。

### <a name="remotefx-gpu-processing-power"></a>RemoteFX 的 GPU 处理能力

对于每个虚拟启用了 GPU 的虚拟桌面，没有已启用 RemoteFX 的服务器上运行的相应 DirectX 进程。 此过程重播它接收从 RemoteFX 虚拟桌面到物理 GPU 上的所有图形命令。 有关物理 GPU，它相当于同时运行多个 DirectX 应用程序。

通常情况下，图形设备和驱动程序进行优化，以在桌面上运行少量的应用程序。 RemoteFX 拉伸的 Gpu 用于以唯一方式。 若要测量 GPU RemoteFX 服务器上的性能如何，性能计数器已添加来测量 GPU 响应 RemoteFX 请求。

通常在 GPU 资源不足的资源时，读取和写入操作 GPU 需要很长时间才能完成。 通过使用性能计数器，管理员可以采取预防措施，这样就为其最终用户消除任何停机的可能性。

以下性能计数器来测量虚拟 GPU 性能 RemoteFX 服务器上有：

**RemoteFX 图形**

-   **帧资源不足，客户端的已跳过/秒-** 每秒因没有足够的客户端资源而跳过的帧数

-   **图形压缩率**编码为输入字节数的字节数的比率

**RemoteFX 根 GPU 管理**

-   **资源：中服务器 Gpu TDRs** TDR 超时时的 GPU 的服务器上的时间的总数

-   **资源：运行 RemoteFX 的虚拟机**已安装的 RemoteFX 3D 视频适配器的虚拟机的总数

-   **VRAM 能够：可用 MB / GPU**的未使用的专用视频内存量

-   **VRAM 能够：每个 GPU 的保留的 %** remotefx 已保留的专用视频内存的百分比

**RemoteFX 软件**

-   **监视器的捕获率** \[1-4\]显示 RemoteFX 捕获速率的监视器 1-4

-   **压缩率**在 Windows 8 和替换已弃用**图形压缩率**

-   **延迟帧/秒**每秒图形数据不发送在某段时间内的帧数

-   **GPU 捕获响应时间**测量滞后时间内 RemoteFX 捕获 （以微秒为单位） 来完成的 GPU 操作

-   **GPU 呈现响应时间**测量滞后时间内 RemoteFX 呈现 （以微秒为单位） 来完成的 GPU 操作

-   **输出字节**总数 RemoteFX 输出字节数

-   **等待客户端计数/sec**在 Windows 8 和替换已弃用**帧已跳过/秒-客户端资源不足**

**RemoteFX vGPU 管理**

-   **资源：虚拟机的本地 TDRs** TDRs 已在此虚拟机 (TDRs 传播到虚拟机的服务器不包含) 的总数

-   **资源：由服务器传播 TDRs** TDRs 出现在服务器上的和，均已传播到虚拟机的总数

**RemoteFX vGPU 性能虚拟机**

-   **数据：调用显示每秒**（以秒为单位） 的存在操作要呈现到桌面的虚拟机每秒的总数量

-   **数据：显示每秒传出**存在由虚拟机发送到服务器 GPU 每秒的操作的总数

-   **数据：读取字节数/秒**的已启用 RemoteFX 的每秒从服务器读取的字节总数

-   **数据：发送字节数/秒**到已启用 RemoteFX 的服务器 GPU 每秒发送的字节总数

-   **DMA:通信缓冲区的平均延迟 （秒）** 平均花费的时间 （以秒为单位） 的通信缓冲区中

-   **DMA:DMA 缓冲区延迟 （秒）** 的时间 （以秒为单位） 从直到完成时提交 DMA

-   **DMA:队列长度**RemoteFX 3D 视频适配器的 DMA 队列长度

-   **资源：每个 GPU TDR 超时**TDR 计数超时发生每个 GPU 虚拟机上的

-   **资源：每个 GPU 引擎 TDR 超时**TDR 计数超时发生每个 GPU 的虚拟机上引擎

RemoteFX 虚拟 GPU 除了性能计数器外，还可以使用进程资源管理器，其中显示了视频内存使用情况和 GPU 利用率测量 GPU 利用率。

## <a href="" id="perfopt"></a>性能优化


### <a name="dynamic-memory"></a>动态内存

动态内存使更有效地平衡正在运行的虚拟机之间分发内存的方式运行 HYPER-V 的服务器的内存资源使用率。 可以动态分配内存，以响应其不断变化的工作负荷的虚拟机之间。

动态内存使你可以增加虚拟机密度而无需牺牲性能或可伸缩性已有的资源。 结果是更有效地使用昂贵的服务器硬件资源，可以转换为更轻松地管理和降低成本。

来宾操作系统上运行 Windows 8 和上面有跨多个逻辑处理器的虚拟处理器，请考虑使用动态内存，以帮助最大程度减少内存使用率运行，并且禁用动态内存来提高性能之间的权衡是注意计算机拓扑的应用程序。 此类应用程序可以利用拓扑信息来决定计划和内存分配。

### <a name="tiered-storage"></a>分层存储

RD 虚拟化主机支持的虚拟机池的分层的存储。 共享的所有池形虚拟桌面集合中的物理计算机可以使用一小尺寸、 高性能存储解决方案，如镜像固态硬盘 (SSD)。 共用虚拟桌面可以要放在成本较低，传统的存储，例如 RAID 1 + 0。

物理计算机应放置在 SSD 是因为大多数读取-我/Os 从共用虚拟机转到管理操作系统。 因此，物理计算机时使用的存储必须可承受更高每秒读取的 I/o。

此部署配置可确保成本效益需要性能时的性能。 固态硬盘较小的大小磁盘 (每个集合，具体取决于配置的约 20 GB) 上提供更高的性能。 用于共用虚拟桌面的传统存储 (RAID 1 + 0) 使用每个虚拟机约 3 GB。

### <a name="csv-cache"></a>CSV 缓存

故障转移群集在 Windows Server 2012 及更高版本提供了缓存在群集共享卷 (CSV)。 这是非常有用的共用虚拟桌面集合的只读大部分 I/o 来自管理操作系统。 CSV 缓存通过几个数量级提供更高的性能，因为其缓存超过一次读取的块，然后将其交付从系统内存，从而减少了 I/O。 CSV 缓存的详细信息，请参阅[如何启用 CSV 缓存](http://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx)。

### <a name="pooled-virtual-desktops"></a>共用虚拟机

默认情况下，共用虚拟机将回滚到原始状态后用户注销，因此任何由于最后一个用户登录并放弃对 Windows 操作系统所做的更改。

尽管可以禁用回滚，但仍然是一种临时情况因为共用虚拟桌面集合通常是由于各种更新虚拟桌面模板重新创建。

若要关闭 Windows 功能和服务取决于持久状态的意义。 此外，最好将关闭主要用于非企业方案的服务。

在任何广泛部署之前，应适当地评估每个特定服务。 以下是需要注意一些初始问题：

| 服务                                      | 为什么？                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 自动更新                                  | 通过重新创建虚拟桌面模板更新共用虚拟桌面。                                                                                                                          |
| 脱机文件                                | 虚拟机始终处于联机状态且连接从网络角度看。                                                                                                                         |
| 背景碎片整理                            | （由于回滚到原始状态或重新创建虚拟桌面模板，这会导致重新创建所有共用虚拟机） 的用户登录后，文件系统更改将被丢弃。 |
| 休眠或睡眠状态                           | 没有此类概念的 VDI                                                                                                                                                                                   |
| Bug 检查内存转储                        | 用于共用虚拟机没有此类概念。 Bug 检查共用虚拟机将开始从原始状态。                                                                                       |
| WLAN 自动配置                              | VDI 没有 WiFi 设备接口                                                                                                                                                                 |
| Windows Media Player 网络共享服务 | 使用者为中心的服务                                                                                                                                                                                  |
| 家庭组提供程序                          | 使用者为中心的服务                                                                                                                                                                                  |
| Internet 连接共享                  | 使用者为中心的服务                                                                                                                                                                                  |
| Media Center 扩展服务               | 使用者为中心的服务                                                                                                                                                                                  |

 

**请注意**  此列表并不是完整的列表，因为任何更改将影响预期的目标和方案。 有关详细信息，请参阅[热，按下按钮，关闭立即获取，Windows 8 VDI 优化脚本，免费的 PFE ！](http://blogs.technet.com/b/jeff_stokes/archive/2013/04/09/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe.aspx)。

 

**请注意**   SuperFetch 在 Windows 8 中的默认处于启用状态。 它是 VDI 感知，并且不能禁用。 SuperFetch 可进一步减少内存消耗通过共享内存页，非常有利于 VDI。 运行 Windows 7 的共用虚拟机，应禁用 SuperFetch，但针对运行 Windows 7 的个人虚拟桌面，它应保留为 on。

 
