---
title: 性能优化远程桌面会话主机
description: 性能优化指南远程桌面会话主机
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: e95671718616fc7c81977434e83a227c858fca17
ms.sourcegitcommit: 6ef4986391607bb28593852d06cc6645e548a4b3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/07/2019
ms.locfileid: "66811417"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>性能优化远程桌面会话主机


本主题讨论如何选择远程桌面会话主机 （RD 会话主机） 的硬件、 优化主机和优化应用程序。

**本主题内容：**

-   [选择适当的硬件的性能](#selecting-the-proper-hardware-for-performance)

-   [优化应用程序的远程桌面会话主机](#tuning-applications-for-remote-desktop-session-host)

-   [优化参数的远程桌面会话主机](#remote-desktop-session-host-tuning-parameters)

## <a name="selecting-the-proper-hardware-for-performance"></a>根据性能选择适当的硬件


有关 RD 会话主机服务器部署，硬件的选择依据应用程序集和用户如何使用它们。 会影响的用户和他们的体验的关键因素是 CPU、 内存、 磁盘和图形。 本部分包含特定于 RD 会话主机服务器的其他指导原则和主要与 RD 会话主机服务器的多用户环境。

### <a name="cpu-configuration"></a>CPU 配置

CPU 配置从概念上讲确定乘以所需的 CPU 来支持会话，方法是应该在系统支持，同时保持缓冲区区域处理临时峰值的会话数。 多个逻辑处理器可帮助减少异常 CPU 拥塞情况，通常由几个过度活跃的线程所包含的类似逻辑处理器数。

因此，多个逻辑处理器的系统上必须已内置于 CPU 使用情况估计值，这会导致较大比例的每个 CPU 的活动负载的越低缓冲边距。 要记住的双倍的 Cpu 数量的一个重要因素会不两倍的 CPU 容量。

### <a name="memory-configuration"></a>内存配置

内存配置为依赖于用户利用; 应用程序但是，可以通过使用以下公式估计所需的内存量：TotalMem = OSMem + SessionMem \* NS

OSMem 是多少 （如系统二进制图像、 数据结构等），运行 SessionMem 所需的操作系统的内存是多少内存在一个会话中运行的进程需要，和 NS 是目标活动会话数。 由设置为应用程序和系统进程的会话中运行的专用内存引用主要确定会话所需的内存量。 共享的代码或数据页产生什么影响，因为只有一个副本是系统上存在。

一个有趣的观察值 （假设备份页面文件的磁盘系统不会更改） 在于的数字越大系统计划支持，每个会话内存分配必须是更大的并发活动会话。 如果不增加每个会话分配的内存量的页面错误数的活动会话生成的会话数的上升而增加。 最终，这些错误会严重影响 I/O 子系统。 通过增加每个会话分配的内存量，不会产生页面错误的可能性会降低，这有助于减少页面错误的总速率。

### <a name="disk-configuration"></a>磁盘配置

配置 RD 会话主机服务器和它可以在现场部署的系统中是最常见的限制时，存储是一个经常被忽略。

典型的 RD 会话主机服务器生成的磁盘活动会影响以下几个方面：

-   系统文件和应用程序二进制文件

-   页面文件

-   用户配置文件和用户数据

理想情况下，这些方面应备份不同的存储设备。 使用条带化的 RAID 配置或其他类型的更多的高性能存储可提高性能。 我们强烈建议使用电池供电的写缓存，使用存储适配器。 磁盘写入缓存的域控制器提供完善的同步写入操作的支持。 所有用户都有单独的配置单元，因为同步写入操作是明显更常见的 RD 会话主机服务器上。 注册表配置单元将定期保存到磁盘使用同步写入操作。 若要启用这些优化，在磁盘管理控制台中，打开**属性**对话框中的目标磁盘，然后在**策略**选项卡上，选择**启用写入缓存磁盘**并**关闭 Windows 写式缓存缓冲区刷新**设备复选框。

### <a name="network-configuration"></a>网络配置

RD 会话主机服务器的网络使用情况包括两个主要类别：

-   RD 会话主机连接流量使用情况取决于以独占方式几乎会展现会话和重定向的设备的 I/O 流量内运行的应用程序的绘制模式。

    例如，处理文本处理和数据输入的应用程序占用带宽的大约 10 到 100 千位 / 秒，而丰富图形和视频播放带宽使用情况会导致大量增加。

-   例如，漫游配置文件，应用程序对文件共享、 数据库服务器、 电子邮件服务器和 HTTP 服务器访问后端连接。

    卷和配置文件的网络流量是特定于每个部署。

## <a name="tuning-applications-for-remote-desktop-session-host"></a>优化应用程序的远程桌面会话主机


RD 会话主机服务器上的 CPU 使用率的大部分取决于应用程序。 通常，桌面应用程序进行了优化向目标是最大程度减少需要多长时间的应用程序以响应用户请求的响应能力。 但是在服务器环境中，是最大程度减少完成某项操作以避免产生负面影响其他会话所需的 CPU 使用率总量同样非常重要。

配置用于 RD 会话主机服务器的应用程序时，请考虑以下建议：

-   最小化后台空闲循环处理

    典型的示例将禁用背景语法和拼写检查，为搜索，编制索引的数据并将保存背景。

-   最小化应用程序执行状态检查或更新的频率。

    禁用此类行为或增加的时间间隔轮询迭代和计时器触发显著权益 CPU 使用率，因为这些活动的效果会快速放大为多个活动会话。 典型示例是连接状态图标和状态栏信息更新。

-   通过减少它们的同步频率的应用程序之间的资源争用降至最低。

    此类资源的示例包括注册表项和配置文件。 应用程序组件和功能的示例包括 （如 shell 通知） 的状态指示器、 后台索引或更改监视和脱机同步。

-   禁用不必要的进程，即注册为用户登录或会话启动开头。

    这些进程可以大大增加成本的 CPU 使用率时创建一个新的用户会话，这通常是大量占用 CPU 的进程，并可能会在第二天早上方案中非常昂贵。 使用 MsConfig.exe 或 MsInfo32.exe 获取的用户登录时启动的进程的列表。 有关更多详细信息，可以使用[Autoruns 为 Windows](https://technet.microsoft.com/sysinternals/bb963902.aspx)。

内存消耗，您应考虑以下方面：

-   验证的应用程序加载 Dll 不会重定位。

    -   可以通过选择过程 DLL 的视图，验证重新定位的 Dll，如通过使用下图中所示[Process Explorer](https://technet.microsoft.com/sysinternals/bb896653.aspx)。

    -   这里我们可以看到该 y.dll 已重新定位，因为 x.dll 已被占用其默认基址和未启用 ASLR

        ![重新定位的 dll](../../media/perftune-guide-relocated-dlls.png)

        重新定位 Dll，如果它是不可能在会话之间共享其代码从而大大提高了会话的内存占用。 这是一个 RD 会话主机服务器上最常见的与内存相关的性能问题。

-   对于公共语言运行时 (CLR) 应用程序，使用本机映像生成器 (Ngen.exe) 若要增加页面共享，并减少 CPU 开销。

    如果可能，请将类似的技术应用于其他类似的执行引擎。

## <a name="remote-desktop-session-host-tuning-parameters"></a>优化参数的远程桌面会话主机


### <a name="page-file"></a>页面文件

没有足够的页面文件大小可能导致内存分配失败的应用或系统组件中。 可以使用的内存提交字节数性能计数器监视系统上的已提交的虚拟内存量。

### <a name="antivirus"></a>防病毒

极大地 RD 会话主机服务器上安装防病毒软件会影响总体系统性能，尤其是 CPU 使用情况。 我们强烈建议您从列表中排除 active 监视保存临时文件的所有文件夹，尤其是那些服务和其他系统组件生成。

### <a name="task-scheduler"></a>任务计划程序

任务计划程序允许您检查用于不同的事件安排的任务的列表。 RD 会话主机服务器，它可专注于特定于配置为在空闲状态上运行、 在用户登录，或在会话期间连接和断开连接的任务。 由于部署的详细信息，其中许多任务可能是不必要。

### <a name="desktop-notification-icons"></a>桌面的通知图标

在桌面上的通知图标可以具有非常耗费资源刷新机制。 通过删除从启动列表中注册它们的组件或更改应用程序和系统组件，若要禁用其上的配置，则应禁用任何通知。 可以使用**自定义通知图标**若要检查的服务器可用的通知的列表。

### <a name="remotefx-data-compression"></a>RemoteFX 数据压缩

可以使用下的组策略配置 Microsoft RemoteFX 压缩**计算机配置&gt;管理模板&gt;Windows 组件&gt;远程桌面服务&gt;远程桌面会话主机&gt;远程会话环境&gt;配置 RemoteFX 数据压缩**。 还可能有三个值：

-   **优化以使用更少的内存**使用每个会话的内存量最少，但具有最低的压缩率，因此最高的带宽消耗。

-   **平衡内存和网络带宽**减少带宽消耗时略微增加内存消耗 (每个会话大约 200 KB)。

-   **优化以使用较少网络带宽**进一步减少网络带宽使用大约 2 MB，每个会话的代价。 如果你想要使用此设置，应评估最大会话数并测试到此设置与该级别之前将服务器放在生产环境中。

您还可以选择不使用 RemoteFX 的压缩算法。 选择不使用 RemoteFX 的压缩算法将使用更多网络带宽，并且仅建议如果使用旨在优化网络流量的硬件设备。 即使您选择不使用 RemoteFX 的压缩算法，将压缩一些图形数据。

### <a name="device-redirection"></a>设备重定向

可以使用下的组策略配置设备重定向**计算机配置&gt;管理模板&gt;Windows 组件&gt;远程桌面服务&gt;远程桌面会话主机&gt;设备和资源重定向**或使用**会话集合**属性框在服务器管理器。

通常情况下，设备重定向会增加多少网络带宽 RD 会话主机服务器连接使用，因为客户端计算机上的设备和服务器会话中运行的进程之间交换数据。 增加的程度取决于针对重定向的设备在服务器运行应用程序所执行的操作的频率。

打印机重定向和插即用设备重定向也会增加 CPU 使用率在登录。 可以将以下两种方式的打印机重定向：

-   必须在服务器上安装匹配的打印机驱动程序基于重定向时用于打印机的驱动程序。 早期版本的 Windows Server 使用此方法。

-   在 Windows Server 2008 中引入，轻松打印的打印机驱动程序重定向使用常见的打印机驱动程序的所有打印机。

我们建议 Easy Print 方法，因为它会导致在连接时的打印机安装较少 CPU 使用率。 匹配的驱动程序方法会导致更高的 CPU 使用率，因为它需要后台处理程序服务，从而加载不同的驱动程序。 对于带宽使用，轻松打印会导致略有增加了的网络带宽使用情况，但不是明显，无法偏移量的其他性能、 可管理性和可靠性的好处。

音频重定向会导致稳定的网络流量流。 音频重定向也使用户能够运行多媒体应用程序通常具有高 CPU 占用率。

### <a name="client-experience-settings"></a>客户端体验设置

默认情况下，远程桌面连接 (RDC) 会自动选择右侧体验的服务器和客户端计算机之间的网络连接的适用性的设置。 我们建议 RDC 配置保留在**自动检测连接质量**。

对于高级用户，RDC 提供了一系列影响远程桌面服务连接的网络带宽性能的设置控制。 可以通过访问以下设置**体验**选项卡在远程桌面连接或为 RDP 文件中的设置。

连接到任何计算机时，将应用以下设置：

-   **禁用墙纸**(禁用墙纸： i:0) 不会显示在重定向的连接上的桌面墙纸。 如果桌面墙纸包括图像或绘图的巨额成本与其他内容，此设置可以显著减少带宽使用情况。

-   **位图缓存**(Bitmapcachepersistenable:i:1) 启用此设置时，它会创建客户端缓存的会话中呈现的位图。 它提供了显著改进了带宽使用情况，并应始终启用它 （除非有其他安全注意事项）。

-   **在拖动时显示窗口的内容**（禁用全窗口拖动： i:1） 时禁用此设置，它可减少带宽通过拖动窗口时显示在窗口框架将而不是所有内容。

-   **菜单和窗口动画**（禁用菜单 anims:i:1 和禁用游标设置： i:1）：禁用这些设置后，可通过禁用上 （如淡入淡出） 菜单和游标的动画来减少带宽。

-   **字体平滑显示**(允许字体平滑： i:0) 控件 ClearType 字体呈现支持。 当连接到运行 Windows 8 或 Windows Server 2012 的计算机及更高版本时，启用或禁用此设置没有显著的影响带宽使用情况。 但是，对于运行版本早于 Windows 7 和 Windows 2008 R2 的计算机，启用此设置会影响网络带宽消耗显著。

连接到运行 Windows 7 及更早的操作系统版本的计算机时，仅将应用以下设置：

-   **桌面组合**此设置仅支持与运行 Windows 7 或 Windows Server 2008 R2 的计算机的远程会话。

-   **视觉样式**（禁用主题： i:1） 时禁用此设置，它可减少带宽通过简化使用经典主题的主题绘图。

通过使用**体验**选项卡在远程桌面连接，可选择您的连接速度来影响网络带宽性能。 下面列出了可用于配置您的连接速度的选项：

-   **自动检测连接质量**(连接类型： i:7) 启用此设置后，远程桌面连接会自动选择将导致基于连接质量最佳用户体验的设置。 （此配置时，建议连接到运行 Windows 8 或 Windows Server 2012 的计算机及更高版本）。

-   **调制解调器 (56 Kbps)** (连接类型： i:1) 此设置启用永久性位图缓存。

-   **低速度宽带 (256 Kbps-2 Mbps)** (连接类型： i:2) 此设置启用永久性位图缓存和视觉样式。

-   **移动电话网络/附属 (2Mbps-16 Mbps，具有高延迟)** (连接类型： i:3) 此设置启用桌面组合、 永久位图缓存、 视觉样式和桌面背景。

-   **高速宽带 (2 Mbps – 10 Mbps)** (连接类型： i:4) 此设置启用桌面组合、 拖动、 菜单和窗口动画、 永久位图缓存、 视觉样式和桌面背景中显示窗口的内容。

-   **WAN (10 Mbps 或更高版本具有高延迟)** (连接类型： i:5) 此设置启用桌面组合、 拖动、 菜单和窗口动画、 永久位图缓存、 视觉样式和桌面背景中显示窗口的内容。

-   **LAN (10mbps 或更高版本)** (连接类型： i:6) 此设置启用桌面组合、 拖动、 菜单和窗口动画、 永久位图缓存、 主题和桌面背景中显示窗口的内容。

### <a name="desktop-size"></a>桌面大小

通过 RDP 配置文件 （desktopwidth:i:1152 和 desktopheight:i:864） 或通过使用远程桌面连接中的显示选项卡，可以控制远程会话的桌面大小。 桌面大小越大，更大的内存和带宽消耗与该会话相关联。 当前最大的桌面大小为 4096 x 2048。
