---
title: Server Performance Advisor 用户指南
description: Server Performance Advisor 用户指南
ms.assetid: be99a5a9-b9c0-436b-912c-e5c5839a533d
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/16/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: manage
ms.openlocfilehash: 97fab1a36db2e903b3a909bee9e2f1748f7841fd
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59834138"
---
# <a name="server-performance-advisor-users-guide"></a>Server Performance Advisor 用户指南

>适用于：Windows Server （半年频道）、 Windows Server 2016、 Windows Server 2012 R2、 Windows Server 2012、 Windows 10、 Windows 8

此用户指南的 Microsoft Server Performance Advisor (SPA) 提供了有关如何使用 SPA 来确定在各种服务器角色中部署的系统的性能瓶颈的准则。

SPA 可帮助您完成以下操作：

* 管理服务器性能和故障排除服务器性能问题。

* 提供数据报告以及常见的配置和性能问题的建议。

* 提供了最佳 pratice 建议基于收集的数据。

> [!NOTE]
> SPA 控制台不会向服务器进行任何更改。

有关开发 SPA Advisor 包的详细信息，请参阅[服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

## <a name="server-performance-advisor-overview"></a>服务器性能顾问概述


本部分介绍 SPA 的历史记录、 介绍其目标受众和方案，并显示该工具的体系结构概述。

### <a name="history-of-spa"></a>SPA 的历史记录

2005-2006 年发布的原始版本的 Microsoft Server Performance Advisor (SPA)。 它主要面向 Windows Server 2003，包括核心操作系统和服务器角色，如 Internet 信息服务 (IIS) 和 active directory。 该工具旨在帮助您评估您的服务器性能以及对服务器性能问题进行故障排除。

SPA 对有关常见的配置和性能问题的系统管理员提供数据报告和建议。 SPA 可与性能相关的数据从各种源收集的服务器上，例如，性能计数器、 注册表项、 WMI 查询、 配置文件和事件跟踪 Windows (ETW)。 基于服务器性能数据收集，SPA 可以提供当前服务器性能状况和有关什么可以改进的问题建议的深入探讨。

已超过一百万下载的原始 SPA 工具，并帮助许多系统管理员管理其服务器的性能。 已经过了一种非常成功的性能故障排除工具。

自原始 SPA 的版本中，有几个重大更改服务器性能世界中。 最值得注意的是，对发布的 Windows Server 2012 R2、 Windows Server 2012、 Windows Server 2008 R2 和 Windows Server 2008 中，与对应的服务器角色如 Internet 信息服务 (IIS) 8.5 的新版本。 较新版本的服务器性能审查程序扩展到最新的服务器操作系统和服务器角色的原始 SPA 的功能。

尽管 SPA 3.1 共享相同的设计目标和性能分析模式作为原始的工具，它具有已重新编写使用最新技术。 它还具有以下重大改进：

* 可以执行分析针对运行 Windows Server 2012 R2、 Windows Server 2012、 Windows Server 2008 R2 和 Windows Server 2008 的服务器。

* 支持远程分析功能，允许 SPA 3.1 来收集和分析数据从一个中央控制台，而无需在要对其进行分析的服务器上安装代码。

* 使用 Microsoft SQL Server 用于数据分析和存储，使处理和存储大量的数据。

* 将该工具从 Advisor 包分隔开来。 顾问包，可发布或从该工具将单独更新的窗体发布每个服务器角色的性能分析逻辑。

* 提供了在 SQL 脚本，通过打开的体系结构中开发的顾问包。 非 Microsoft 方可以开发顾问包或从 Microsoft 以涵盖了特殊需求扩展现有的 advisor 包。

* 支持的并列对比报告和趋势和历史图表，帮助您查找异常情况等新功能。

* 提供的功能如修改，导入和导出阈值来帮助您精细优化的报表和通知并与其他 SPA 用户共享这些 tunings。

* 支持多个项目，可用于目标的服务器组合。

* 提供从 SPA 控制台中的定期数据收集。

* （适用于高级用户） 使用 Microsoft SQL Server，可以实现自定义查询和报告生成。

* 自定义的 Windows PowerShell cmdlet 是可用于 SPA

* 用于导入和查看报表从 SPA 3.0 数据库向后兼容

### <a name="target-audience"></a>目标受众

SPA 工具主要面向系统管理员负责管理各种服务器角色中的少于 100 台服务器。 它还可由支持工程师来收集性能数据和解决客户的问题的性能问题。

SPA 提供建议来帮助你解决性能问题;但是，它基于可能适用于特定的服务器环境的假设。 Spa 提供的建议，应考虑的建议。 我们预计 SPA 用户非常了解他们的系统配置的、 用例，以及系统优化对整个系统行为的影响。 系统管理员应确定 SPA 建议是否应该应用于其环境。

### <a href="" id="what-s-new-in-spa-3-1-"></a>新增 SPA 3.1 中的新增功能？

在 SPA 3.1 中添加以下功能和增强功能：

* Active directory Advisor 包可帮助分析服务器 s active directory 域服务服务器角色的常规性能。

* 支持开发人员能够在将 advisor 包中添加丢失的 ETW 事件通知警报和使警报可见时生成报告和事件是由于高频率日志记录或很大程度上速度较慢而丢失争用磁盘

### <a name="target-scenarios"></a>目标方案

以下是用于 SPA 的目标方案：

* **服务器环境**

    SPA 旨在轻松设置和维护。 它适用于使用 1 到 100 个服务器的服务器环境。 如果想要管理的 100 多个服务器的性能，SPA 不能扩展。 对于较大或更复杂的环境，应考虑使用 System Center Operations Manager。

* **性能故障排除**

    作为一种性能故障排除工具，可以使用 SPA。 它提供的功能来收集高级性能数据、 执行处理的数据，以便你更好地了解其整个系统行为的全面帖子和标记任何异常。 如果客户怀疑的性能问题，可以使用 SPA 收集和分析来自服务器的性能数据。

    SPA 将生成的报表，您可以查看。 SPA 报表提供了一个通知列表，其中突出显示潜在的问题，并包含各种性能索引、 配置和设置服务器的数据部分。 此报表可用于标识特定的性能问题，并使用建议用于查找问题的解决方案。 报表可以与其他在不同时间或不同服务器生成的报表进行比较。 使用此-并排比较，可以确定基线正常与异常行为之间的差异。

    **请注意**SPA 不旨在作为调试或计数工具。 此外，从服务器的角度来看，它可被视为一个只读的工具，并且不会修改服务器配置。

     

* **性能索引监视**

    SPA 可用于监视服务器的性能索引。 您可以选择以收集性能数据，然后运行趋势图表或历史图表，以找出异常的服务器上定期运行 SPA。 您可以查看特定分析的报告、 找出有关性能问题的详细信息以及如何将建议或其他报表数据来解决此问题。

### <a name="spa-architecture"></a>SPA 体系结构

SPA 数据集合逻辑是基于名为性能日志和警报 (PLA) 的 Windows 中的协议。 PLA 使程序能够从本地或远程服务器，如性能计数器、 WMI 查询，ETW 跟踪、 注册表项和配置文件中收集性能数据。 SPA 运行时性能分析的目标服务器上，它创建基于所选特定 SPA Advisor 包的 PLA 数据收集器集。 顾问包包含将收集的数据源和日志的存储位置的文件共享。 SPA 数据收集只存储单一用户帐户;使用 PLA 的相同用户帐户还用于写入日志。

SPA 使用 SQL Server 数据库来存储从目标服务器收集的性能日志。 SPA 将所有性能日志文件共享中导都入到数据库，然后使用每个 advisor 包内的数据分析逻辑以处理数据并生成报表。 Advisor 包分析已从目标服务器收集，并生成 SPA 报表的性能数据。 有关构建 advisor 包的详细信息，请参阅[服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

SPAConsole.exe 的一部分生成的 SPA 控制台用户界面和交互。 可以使用控制台来创建到数据库、 添加或删除的 advisor 包、 管理目标服务器，运行性能分析和查看性能报告。

SPA 控制台可以运行以下操作系统上：

* Windows 8.1

* Windows 8

* Windows 7

* Windows Server 2012 R2

* Windows Server 2012

* Windows Server 2008 R2

* Windows Server 2008

在典型的业务应用程序中，有三个层： 表示层、 业务逻辑层和存储层。 SPA 是两个控制台和数据库层产品设计。 在控制台使用所包含，某些与进程相关的逻辑和数据库可作为存储层和业务逻辑层用作表示层。 在控制台中捕获用户输入，并控制数据收集、 数据处理和生成报告的步骤。 SPA 不依赖于 Windows 系统服务。

下图显示了 SPA 系统的高级体系结构。 过程如下：

1.  从 SPA 控制台中，您可以指定服务器上运行性能分析。

2.  时收集的性能数据，则在目标服务器上的 PLA 将日志写回指定的数据收集器集的文件共享。

3.  在目标计算机上完成数据收集后，SPA 控制台将 SQL Server 数据库导入日志。

4.  在控制台调用特定 advisor 包的数据处理的逻辑。

5.  Advisor 包处理数据，并调用 SPA Api 来将记录插入到 SPA framework 所定义的系统报告表。

6.  可以使用报表查看器控制台中的查看生成的报告。 为了帮助你解决性能问题，SPA，提供了三种类型的报表： 单个报表，通过并行报告和趋势或历史图表。 有关报表的详细信息，请参阅[查看报表](#bkmk-viewingreports)。

![spa 体系结构](../media/server-performance-advisor/spa-user-manual-architecture.png)

## <a name="getting-started-with-spa"></a>如何开始使用 SPA


### <a name="requirements"></a>要求

SPA 控制台可以安装在 Windows 8.1，Windows 8、 Windows 7、 Windows Server 2012 R2、 Windows Server 2012、 Windows Server 2008 R2 和 Windows Server 2008。 不支持早期版本的 Windows Server 操作系统上运行 SPA。 SPA 运行 x86 或 x64，但它不支持 IA64 或 ARM 体系结构。

SPA 是构建在 Windows Presentation Foundation (WPF) 2.0 中，它是 Microsoft.NET Framework 4 的一部分，因此需要.NET Framework 4。

此外需要 SPA 的安装位置在同一计算机上安装 SQL Server 2008 R2 Express。 SQL Server 2008 R2 Express 是免费的数据库引擎，Microsoft 将发布。 您可以从 Microsoft 下载中心中下载 Microsoft SQL Server 2008 R2 Express。 虽然我们建议 SQL Server 2008 R2 Express，也可能与 SPA 兼容较新版本的 SQL Server。

**请注意**SPA 不包括 SQL Server 或.NET Framework 作为 SPA 安装包的一部分。 在安装 Microsoft SQL Server 2008 R2 和.NET Framework 4.0，我们建议安装 SPA 之前运行 Windows 更新。

 

因为用户可以创建和管理与 SPA 的数据库，用于运行 SPA 的用户帐户应具有相同 SQL Server 的管理员权限。

### <a href="" id="bkmk-setupspa"></a>设置 SPA

SPA 打包为 cab 文件包含 SPA 框架，在高级方案中使用的 Windows PowerShell cmdlet 的所有二进制文件和以下顾问包：核心操作系统、 HYPER-V、 active directory 和 IIS。 提取到文件夹的.cab 文件后，没有其他安装是必需的。 但是，若要运行 SPA，需要启用从目标服务器收集数据，如下所示：

* 若要运行 PLA 数据集合，用于运行 SPA 控制台的用户帐户必须是目标服务器上的管理员安全组的一部分。 如果目标服务器和控制台位于同一个域，域用户帐户必须是目标服务器上的管理员安全组的一部分。 如果目标服务器和控制台不在同一个域中，可管理用户帐户创建使用相同的用户名和密码在目标服务器上，为用于运行 SPA 控制台的用户帐户。

* 在服务器上创建一个共享的文件夹用于结果。

* 请确保用于运行 SPA 控制台的用户帐户具有读取和写入到共享文件夹的权限。 PLA 使用此帐户将日志写入该文件夹。
SPA 控制台使用相同的帐户读取日志并将它们导入数据库。

    **请注意**ETW 实现循环缓冲区来存储跟踪，并将其移动到共享文件夹在可能的情况。 如果服务器正忙或写入操作速度较慢，当缓冲区已满时，ETW 删除跟踪。 这十分重要的共享的文件夹位于具有快速 I/O 访问的服务器上。 我们建议每台目标服务器具有一个共享的文件夹，缓慢的文件 I/O 所引起的数据丢失降到最低。

     

* 对于 PLA 访问目标服务器，设置 Windows 防火墙以允许远程性能日志和警报访问目标服务器上。 PLA 使用 TCP 端口 139。

* 请确保**性能日志和警报**服务是否正在运行。

* 如果控制台和目标服务器位于不同子网中，您还需要设置远程 IP 地址字段中的入站的防火墙规则中**作用域**上的设置**性能日志和警报**页上，如下所示。

    ![pla 属性](../media/server-performance-advisor/spa-user-manual-pla-firewall.png)

* 在控制台上和在每台目标服务器上启用网络发现。

* 如果目标服务器未加入到域中，启用以下注册表设置：**HKLM\\软件\\Microsoft\\Windows\\Currentversion\\策略\\系统\\LocalAccountTokenFilterPolicy**。

**请注意**默认情况下，SPA 将诊断日志写入到 SpaConsole.exe 所在的文件夹。 如果 SPA 安装在 Program Files 文件夹下，SPA 是仅能写入日志时 SpaConsole.exe 是以管理员身份运行。

如果你想要对控制台计算机运行数据分析，您需要以管理员身份运行 SPA。 PLA 经历不同的代码路径，针对需要管理员特权的本地计算机运行时。

如果你想要对你的服务器运行 IIS SPA Advisor 包，您需要启用 WMI 查询和针对 IIS 服务器的 ETW 跟踪。 您可以执行此操作，从而**跟踪**下**运行状况和诊断**角色服务和**IIS 管理脚本和工具**下**管理工具**的**Web 服务器 (IIS)** 服务器角色。

 

### <a name="creating-your-first-project"></a>创建第一个项目

所有设置后，可以创建第一个 SPA 项目。 如前一部分中所述，SPA 存储与数据库中的性能数据分析相关的所有内容。 每个 SPA 项目对应于单个数据库。 **首次使用向导**指导您完成以下步骤。

**若要创建 SPA 项目**

1.  启动 SpaConsole.exe。 在控制台进入断开连接模式下，其中 SPA 未连接到任何数据库，并在主窗口为空白。

2.  若要创建新项目，请单击**文件**，然后单击**新项目**。 这将启动首次使用向导。 第一页显示了在使用向导时遵循的步骤：

    * 创建数据库

    * 预配的 advisor 包

    * 将服务器添加到目标服务器列表

3.  单击“下一步” 。 **创建项目数据库**页要求您提供想要创建你的数据库的 Microsoft SQL Server 实例的名称。 例如，如果它是在控制台的同一计算机上，您可以使用**localhost\\&lt;SQL 服务器名称&gt;**。

    **请注意**SQL Server 2008 R2 Express 安装的默认实例名称为 SQLExpress。 对于 SQL Server 2008 R2 Express 在本地计算机上安装的实例，数据库将通常默认为**localhost\\SQLExpress**。 但是，它可能已更改 SQL Server 安装期间，因此您需要确保使用正确的 SQL Server 实例名称。

     

4.  提供数据库名称。 字母、 数字和下划线 (\_) 可作为有效的字符的数据库名称。 是合理的 SPA 数据库名称的建议**SPA**。 如果输入无效的名称，将显示红色错误图标。 相关的工具提示提供验证失败的原因。

    **请注意**是特别要记住的数据库名称和服务器实例名称，因为这些是你的项目的唯一标识符。 需要提供此信息，如果你想要切换到此数据库。

     

5.  提供的服务器实例名称和数据库名称后，第一次使用向导生成的数据库文件的位置。

6.  上**创建项目数据库**页上，单击**下一步**。 第一次使用向导创建数据库，并在数据库中生成所有与 SPA 相关的数据库架构、 函数和存储的过程。 此步骤可能需要几秒钟，具体取决于硬件和网络速度。

    **请注意**如果此步骤将失败，出现错误消息。 下面是一些常见的问题：控制台无法连接到 SQL Server 实例，权限不足，无法创建数据库，或数据库名称已存在。

     

7.  当在上一步骤成功时，您看到**预配 advisor 包**页。 它列出了您的计算机上可用的所有顾问包。 SPA 会自动扫描名为的文件夹**APs** SPA 根目录下。 它列出了完整的名称、 版本和每个 advisor 包的作者。

    **请注意**有关如何在 SPA 中使用的完整名称和版本的详细信息，请参阅[管理 advisor 包](#bkmk-manageadvisorpacks)

     

8.  选择你想要在项目数据库中，预配，然后单击哪些顾问包**下一步**。 也可以单击**跳过**以无需预配任何 advisor 包移动到下一步。

    **请注意**可以的随时使用该工具设置 advisor 包。 有关详细信息，请参阅[管理顾问包](#bkmk-manageadvisorpacks)。

     

9.  上**将服务器添加**页上，对于要添加到目标服务器列表中，有两个必填字段以填充每个服务器：**服务器的名称**并**文件共享位置**。

    **请注意**此外，还有**备注**字段，它主要用于分类或找到的服务器。 在其中有多台服务器的实例，您可以导入包含服务器名称、 结果文件夹和可选备注字段的逗号分隔值 (.csv) 文件。 **备注**字段用于描述在服务器和一词可用于筛选数据收集的服务器。 如果正在初始化服务器通过.csv 文件，文件中的出现分析错误不会加载服务器。

     

10. 多个配置需要设置以启用 PLA 数据收集，如中所述[设置 SPA](#bkmk-setupspa)。 **将服务器添加**页提供了测试配置功能，以帮助你解决配置问题。 选择与计算机关联的复选框，然后单击**测试连接**。 SPA 尝试生成目标服务器上设置的数据收集器，它会尝试导入回数据库的结果。 如果所有内容都是正确的**状态**演示**传递**。 如果失败，工具提示，将显示描述失败的原因。

11. 每台服务器是自动添加到数据库，即使它未通过配置测试。 若要从列表中删除服务器，选择服务器名称，然后单击**删除**。

12. 一切完成后，单击**完成**关闭首次使用向导。 如果关闭首次使用向导完成它之前，所有前面的步骤保存并且其中任何一个回滚自动。 您需要手动进行将来的更改。

## <a name="running-analysis"></a>运行分析


设置数据库之后, 可以在服务器上运行性能分析。

每次 SPA 控制台将启动，当前用户使用过的最后一个项目将自动打开。 主窗口包含服务器的列表。 每个服务器有四个属性：服务器名称、 分析结果、 当前状态和备注。

* **服务器名称**服务器，这是服务器的标识符的名称。 允许没有重复的名称。

* **分析结果**默认情况下，它显示的最新的性能分析结果运行的服务器。 如果不具有已对服务器运行任何性能分析，它将显示**无报告**。 如果没有引发报表的一条警告，则会显示**警告**和最新的报表生成时的时间戳。 如果在服务器上最新的分析过程中不出现了任何问题，它将显示**确定**和时间戳。

    **请注意**如果最近更改系统设置，我们建议运行分析后，再次以评估更改的整体影响和获取系统状态的更新后的报表。 SPA 不跟踪到待测试系统的配置更改。

     

* **当前状态**显示当前在服务器上运行的分析任务的性能的状态。 您可以通过单击取消正在运行的任务**取消**图标，由一个红色的 X。

* **备注**介绍当前的目标服务器。 例如，可以通过使用服务器角色 (例如，SQL Server) 或位置 (例如，Kent) 来描述您的服务器。 使用 SPA**服务器名称**并**备注**帮助搜索和查找正确的服务器。 您可以在搜索文本框中键入。 如果**服务器名称**或**备注**列包含的确切字符串，在搜索框中，输入该服务器显示在服务器列表中。

以下控件也是可在控制台上：

* **重复**一个复选框，描述的能力定期重复集合中，基于时间间隔。 对于大多数服务器安装，你想要有一个每小时重复此步骤具有足够的历史记录，以进行分析的 SPA 集合。 如果你想要运行一次的集合，则应选中**重复**复选框。

* **删除重复**按钮，可使您可以取消正在进行重复集合作业。 它会取消重复的集合，但不是当前集合 （如果有） 正在进行。 此选项允许你重置新的重复的收集间隔或手动运行集合。

启动性能分析之前，请选择数据收集持续时间。 尽管收集更多的数据有助于提供服务器的性能情况的更准确映像，还会生成更多的日志，并且它无法在服务器上具有更多的潜在影响。 选择适当的数据收集持续时间根据具体的需求。 每个顾问包定义最小的有效持续时间。 你选择的数据收集持续时间必须长于所选的 advisor 包的最小持续时间。

若要在目标服务器上运行性能分析，请选择你想要运行性能分析，并单击服务器 * * 运行分析 * * 对话框中，并询问您选择要在服务器上运行的顾问包。 所选的 advisor 包同时运行。 生成的报表基于相同时间段内收集的性能数据。

**请注意**如果选择了运行，请重复执行性能分析的服务器**删除重复**按钮允许您取消重复的数据收集。 SPA 不在同一计算机上允许同时在多个数据收集会话。

 

## <a href="" id="bkmk-viewingreports"></a>查看报表


在 SPA 中，有三种类型的性能分析报告：单个报表、-同时报告和趋势和历史记录关系图。

正在运行性能分析后，为每个目标计算机上运行的顾问包生成报告。 您可以从主窗口中的服务器列表中，展开**分析结果**若要查看已运行特定服务器的所有 advisor 包。 可以单击报表名称以查看单个报表。

有顾问包名称旁边显示的最新的服务器上运行的分析状态的三个图标：

* **最新**图标显示由 advisor 包此服务器上的最新性能分析生成的报表。

* **查找**图标列出可用的性能分析报表，这样就可以选取正确的报表。 **Advisor 包**并**目标服务器**字段已预先填充使用当前的顾问包和目标的服务器信息。 默认时间范围设置为一周和结束日期设置为今天。 如果单击**搜索**按钮在右上角中，可以获取的时间范围内所选的服务器和顾问包的所有性能分析报表的列表。

* **查看图表**图标打开的趋势和历史图表视图。

下图显示**最新**，**查找**，并**视图图表**后每个 advisor 包的图标：

![报表图标](../media/server-performance-advisor/spa-user-manual-report-icons.png)

### <a name="searching-for-and-within-reports"></a>搜索并在报表内

搜索报表可通过使用**报表资源管理器**。 这使您按日期范围、 服务器名称和 advisor 包搜索报表。 这是查找感兴趣以外上次运行报表的报表的建议的方法。 上次运行的报表是可通过**查看报表**为该服务器。

查看特定报表，可以轻松地导航到下一页和上一页报表按时间或查看相关的报表，例如运行在同一时间在不同 AP。 这些选项都位于**操作**。

在报表中进行搜索，也可以。 多个报表具有**查找**字符串搜索框中可用于在报表中的快速文本字符串搜索。 若要删除文本框中，可以将其关闭。 若要激活 （在 windows 中具有搜索的文本) 的搜索框，可以使用控件 + F 快捷方式。 **查找**框允许用户根据需要指定搜索区分大小写**区分大小写**选项。

下图显示**查找**搜索框中的使用字符串**Power**上**报表**选项卡。

![查找搜索框](../media/server-performance-advisor/spa-user-manual-find-search-box.png)

### <a name="single-report"></a>单个报表

单个报表显示了在单台计算机上的 advisor 包一次运行的性能分析结果。 报表将显示顾问包的名称、 目标服务器、 生成报告，时间和数据收集的持续时间的名称。

单个报表包含通知部分和数据部分。

### <a name="notification-section"></a>通知部分

通知部分包含的一套性能分析规则。 每个通知包含某些数据源、 一些阈值的值和一些业务逻辑。 当您运行性能分析时，业务逻辑的计算结果根据阈值来确定该规则将或未传递的数据源。 否则，会出现一个警告来通知你有关潜在性能问题。 它还提供建议来帮助你解决此问题。 通知部分始终是单个报表视图中的第一个选项卡。

通知部分分为两个部分：**警告**并**其他通知**。

如果数据源的规则符合特定条件的逻辑和阈值设置，警告将出现在**警告**区域。 警告包括以下部分：

* 警告图标指示存在潜在问题。

* 规则的名称。 例如，**网络接收数据包放弃**是指向规则的详细信息页的链接，如中所述[管理顾问包](#bkmk-manageadvisorpacks)。

* 有关潜在问题的简单说明。

* 有关用于潜在性能问题的可能解决方案建议。

不同的服务器可以显著不同的配置和使用模式，并且无法设置阈值和适用于在所有情况下的所有服务器的规则。 SPA 提供的功能，若要修改的阈值。 您还可以选择禁用规则，如果此规则不适用于你的方案。 默认情况下已启用所有规则。 已禁用的规则未出现在通知区域中。 有关详细信息，请参阅[管理顾问包](#bkmk-manageadvisorpacks)。

**其他通知**区域包含所有其他规则，则将出现任何警告或规则不适用的位置。 它包含在中找到类似的部件**警告**区域。 最大的区别是，如果不引发任何警告或规则不适用，通常不建议提供。

### <a name="data-sections"></a>数据部分

数据部分包含顾问包生成基于原始数据从目标服务器收集的性能数据。 数据部分包含一系列顶级部分以及多个级别的子节。 顶级部分显示为选项卡。 可展开区域中会显示在顶级部分下的所有子节。 可以折叠或展开每个部分来帮助专注于感兴趣，区域，如下图中所示。

![数据部分](../media/server-performance-advisor/spa-user-manual-data-sections.png)

核心操作系统 SPA 顾问包和 IIS SPA Advisor 包包含**系统概述**部分。 本部分包括有关的资源使用情况和配置的顶级信息。 其他顶级部分表示性能数据的区域。 SPA 中通过以下方式显示报表数据：

* **单个值**键/值对。 该密钥是一个字符串，表示值的含义。 值可以是字符串、 数字值或布尔值。 这通常用于显示静态信息，例如配置例如，CPU 体系结构、 总内存大小和 BIOS 版本中，这不随时间变化。

* **列出值**有时这是一个键/值对，但可以包含多个字段的列表值。 例如，可以拥有多个列和多个行的表中所示的 cpu 属性。 每一行表示一个 CPU，每个列表示的 CPU 属性。

* **统计信息**可被视为一种特殊类型的单个值。 它只能包含数字数据。 数据收集期间，很多数值数据点会波动，而不是保持常量。 例如，CPU 使用情况更改的每当 PLA 收集性能计数器。 显示单个值不能准确地反映性能情况。 而不是显示只有一个值，平均值、 最大值、 最小值、 和 90%的值用于此类动态数值数据点。 90%值表示该给定的集合间隔内跨所有事件，该计数器的活动处于或高于第 90 百分位。

* **顶部列表**通常包含最耗的特定资源或前遇到某些事件的实体。 例如，**根据平均 CPU 使用率列出前 10 个处理**数据收集期间包括平均 CPU 利用率最高的前十个进程。 由于 CPU 使用率也动态数值数据点、 最大值、 最小值、 和 90%值等其他统计信息也包括在列表中为用户提供更全面的 CPU 占用率。

如前面的部分中所述，SPA 依赖于 PLA 收集 ETW 跟踪、 WMI 查询、 性能计数器、 注册表项和配置文件，以生成报表。 这十分重要，若要了解报表中每个数据点之后的数据源。 SPA 提供工具提示通过此类信息。 你可以悬停在键列或行以查看数据源的工具提示。 例如， **WMI:Win32\_DisDrive： 标题**意味着，数据源是从 WMI 查询，WMI 类名是 Win32\_磁盘驱动器，并且属性是**标题**。

### <a href="" id="side-by-side-report-"></a>通过并行报表

单个报表提供通知和数据部分来帮助用户查找潜在的性能问题，但通常很难通过直接查看单个报表识别潜在的性能问题。 单个报表可能包含过多的数据点，这使得难以找出潜在问题。

若要解决此问题，SPA 提供比较两个报告的功能。 您可以比较基准报告，帮助查明差异的潜在问题的报表。

通过并行报表可以是单个报表查看器中的启动。 用户可以单击**操作**，然后单击**比较报告**可以选择报表。 才有意义比较同一 advisor 包中的报表。 您可以选择将具有先前报表的报表中时下, 一个报表中时或通过搜索功能选择的任意报表进行比较。 例如，若要隔离异常行为，可以将基线服务器报告在不同时间在同一计算机上生成的报表，或在具有一个类似的服务器角色的其他计算机上生成的报表进行比较并加载。

通过并行报表的外观非常类似于单个报表。 它包含通知部分和数据部分。 它包含与单个报表查看器的通知和数据分区的数量。 唯一的区别是，报表将显示通过并行的方式。 每个部分包含来自源报表 （报表 1） 的数据和目标报表 （报表 2）。通过并行报告显示的包名称的顾问，目标服务器 （报表在左侧的 1） 和报表 2 在右侧的名称，在生成报表时，时间和每个报表的数据收集的持续时间。

如果您消除**查找**对话框中，您可以将其重新激活通过键入 Control + f。此对话框中查找并突出显示当前节内的文本字符串。

在通知部分中，如果任何进行比较的两个报表的结果是一个警告，它会列入**警告**区域。 否则，结果所示**其他通知**区域。 由于并行的报表的关键是确定报表之间的差异，将不显示有关规则的任何详细的信息。 用户可以单击规则名称，以显示有关规则的详细信息规则详细信息窗体。

在数据部分中，数据与报表左侧 1 中的数据和数据从右侧 2 报表使用的并行方式显示。 SPA 显示单个值，在同一个表，但而不是标签列**值**，它们被命名为**报告 1**并**报表 2**分别。 通过并行报表通过并行表中显示所有其他形式的数据。

通过并行报表查看器还提供了有关数据源的工具提示。

### <a name="historical-and-trend-charts"></a>历史和趋势图表

它仅有意义，显示趋势和特定的服务器和特定 advisor 包的历史图表。 您需要选择时间范围 （这默认会切换到在上一周），然后单击**确定**以显示趋势和历史图表查看器。

趋势和历史图表查看器有三个选项卡： 历史图表、 24 时制趋势图表和 7 天的使用趋势图表。

### <a name="historical-chart"></a>历史图表

历史图表显示了一系列通过给定的时间范围的数值数据点的值。 例如，**请求的平均延迟时间**为过去的 15 天内的单个服务器上的 IIS。 历史图表中的每个数据点表示一个性能分析会话中执行的特定数据源的值。

有两种方法使用历史图表：

1.  若要帮助在特定时间的数据点的示例中，查找异常情况，在每一天的凌晨 2:00**请求的平均延迟时间**IIS 的跳转从大约 200 毫秒到 500 毫秒。

2.  若要帮助将多个数据点相关联。 例如，显示**平均请求延迟**并**平均请求计数**一起为过去的 15 天。 该报告可能显示的请求的延迟时间和请求计数增加在同一时间点，这可能表示请求的延迟增加引起的请求计数的增加。

在历史图表，用户可以执行以下操作：

* 在图表区中显示多个数据序列。 每个数据序列显示为报表查看器中的折线图。 每个折线图自动调整为适合在报表查看器中。

* 添加或从数据系列列表底部的历史图表查看器中删除某一数据序列。

* 显示或隐藏数据系列存储在数据系列列表。 用户可以单击以突出显示图表区中的相应行图表的列表中的特定数据序列。

* 选择在图表区内的时间段放大到特定时间段。 若要缩小，请单击位于图表的左下角的按钮。

* 通过双击特定的数据点来调查单个报表。

* 复制数据，使其可供其他程序，如 Microsoft Excel。 这允许您使用 Microsoft Excel 绘制图表时相应的功能。

### <a name="trend-charts"></a>趋势图

许多重复的性能问题所引起的或对目标服务器上运行的定期任务。 例如，一个面向娱乐的网站可能这个周末，获取更多的命中数或计划磁盘备份任务可能会关闭在每天凌晨 2:00 点服务器的性能。

趋势图旨在帮助您找到此类性能问题。 性能问题可能在各种模式中的重复损坏。 最常用的模式是每日模式和每周模式，其中的一天或每周的同一天同一小时内会出现性能问题。 因此，SPA 提供 24 小时趋势图表和 7 天的使用趋势图表。

趋势分析关系图上的一组数据，提供更高级别的调查并寻找基于一天的时间的趋势。 X 轴设置为 24 小时内，从 0 开始： 00 （午夜） 和 23:59 的结尾。 SPA 不同时显示多个数据序列的趋势。 可以单击**选取数据序列**以选择要查看某一数据序列。

若要处理的数据，SPA 查找生成 0 之间的所有快照： 00，0:59 的每小时。 SPA 确定最小值、 最大值、 平均值和该小时内拍摄的快照集的 sigma 值和图形它们显示为 k 线图。 SPA 的 1:00 至 1:59，则为 2 2:00:59，依次类推之间生成的快照，重复该过程。 如果给定小时不存在任何快照，SPA 在关系图上将该小时内保留为空白，并且继续到下一个小时。

7 天的使用趋势图表是非常类似于 24 小时趋势图表。 唯一的区别是，将为一组基于天而不是一天的小时每周的某一数据序列。

选择趋势和历史图表中的数据序列存储为用户首选项。 下一次的趋势和历史图表查看器打开相同的顾问包，一组相同的数据序列被列为默认值。

## <a name="managing-reports"></a>管理报表


### <a name="deleting-reports"></a>正在删除报告

若要最大程度减少需要管理的 SPA 的报表数，可以删除报表。 具体取决于报表和服务器数量的频率，我们建议删除不必要的报表。 虽然 SPA 可以管理的报表没有限制，基础数据库可能有大小限制。

**请注意**无法取消删除已删除的报表。

 

### <a name="exporting-and-importing-reports"></a>导出和导入报表

可以将报表导出到 XML 文件，将传输到另一个 SPA 控制台或电子邮件发送到另一个用户。 导出报表不会删除报表。 若要从导出当前查看的报表**报表查看器**，单击**操作**，然后单击**导出**。 若要从导出多个报表**报表资源管理器**，单击**启用多个所选内容**，从选择框中，选择多个报表，然后单击**导出**。 此操作将以 XML 格式的报表导出到所选的目标目录中。

可以在 SPA 中查看导出的报表。 导入的报表不会添加到 SPA 数据库。 它们主要是为了作为导出的报表的 XML 查看器应用程序。 导入的报表服务器不需要具有相同的 advisor 包作为原始的导出的报表 SPA 控制台安装。

## <a href="" id="bkmk-manageadvisorpacks"></a>管理 advisor 包


SPA 中包括核心操作系统、 HYPER-V、 active directory 和 IIS 的顾问的包。 SPA 提供用于通过使用 SQL，因此它也非 Microsoft 开发人员可以构建版本的 advisor 包开发的 advisor 包打开体系结构。 有四个选项用于管理 advisor 包： 预配、 自定义、 重置，或删除。

### <a name="provision-new-advisor-packs"></a>预配新的 advisor 包

由 Microsoft 或非 Microsoft 开发人员可以发布新的 advisor 包。 Advisor 包包括 provisionMetaData.xml 和一组描述逻辑的 SQL 脚本。

**若要预配新的 advisor 包**

1.  顾问包下的所有内容都复制 *%sparoot%*\\APs 目录。

2.  在主窗口中，单击**配置**，然后单击**配置 Advisor 包**。 **配置 Advisor 包**对话框随即打开。

    **请注意**从此对话框中，类似于**预配 advisor 包**中首次使用向导页。 它显示了可用于管理的顾问包的列表。 在列表中的每个顾问包都具有属性名称，如安装版本、 版本和作者。 名称是完整的包名称的顾问，并且已安装的版本已在项目中预配此顾问包的版本。 Advisor 包未预配当前数据库中，如果已安装的版本文本框将显示**未安装**。 版本字段指示此顾问包，归档顾问包文件夹下的版本。

     

3.  从列表中选择 advisor 包。 如果尚未设置 advisor 包或在数据库中，一个比顾问包文件夹中的较新版本，则**预配**按钮处于启用状态。 单击**预配**按钮。

4.  预配完成后，**已安装版本**字段所选的 advisor 包包含新的版本信息。

### <a name="customize-advisor-packs"></a>自定义的 advisor 包

SPA 定义允许用户修改 advisor 包打开体系结构。 用户可以通过更改阈值，共享的阈值，以及启用或禁用规则修改顾问包文件。

有关如何更改和生成的 advisor 包的详细信息，请参阅[服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

### <a name="changing-thresholds"></a>更改的阈值

在 SPA 中使用阈值来确定是否满足规则的触发器条件。 实际的阈值为实际客户方案可以显著改变由于工作负荷，硬件环境和业务需要。 默认阈值不可能是正确为当前用户用例，因此 SPA 提供的功能来修改现有的阈值。

通过单击单个或并行的报表中的规则名称，可以修改阈值的值。 或者若要管理的特定 advisor 包的所有规则，它们可以修改从阈值**配置**菜单。

**若要更改的阈值**

1.  在中**配置**菜单上，单击**配置 Advisor 包**，单击名称 advisor 包以进行修改，然后单击**配置**。

    **请注意**顾问包中包含的所有规则的列表随即出现。 顾问包名称的左侧上的复选框指示是否启用规则。 如果规则为禁用状态，它是隐藏的所有报表。

     

2.  单击你想要修改的特定规则。 **规则详细信息**窗体将打开所选的规则。

规则详细信息窗体包含有关特定规则的详细的信息。 它包括名称、 描述、 状态、 可能的结果和阈值。 SPA 支持两种类型的规则结果**警告**并**确定**。 对于每个类型，则建议文本和建议。

某些规则未定义的阈值。 例如， **HTTP Keep Alive**规则检查将布尔值设置为 IIS。 因此阈值列表可能为空。 否则，将列出所有当前规则使用的阈值。 说明的一部分包含有关如何在规则中使用阈值的详细的说明。

如果**规则详细信息**从启动窗体**配置**菜单中，阈值列表具有三列： 名称、 原始设置和更改设置。 如果它已启动从单个或并行的报表，报表使用的阈值是也会包含。 用户可以通过更改中的值修改的当前阈值**更改设置**列中，，然后单击**保存**将更改保存到数据库。

所有对阈值所做的更改才会应用于后所做的更改生成的报表。 现有报表不受这些更改。

### <a name="sharing-thresholds"></a>共享的阈值

如果您管理您的服务器类似的情况下，您可以选择使用一组相同的阈值。 你可以导出并使用导入特定 advisor 包的阈值**配置**菜单。 您可以选择特定的顾问包，然后单击**配置**。 导出的阈值文件是以 XML 格式。

在导入一个阈值，SPA 验证 XML 文件格式，并验证该文件与所选的 advisor 包相匹配。 如果此操作成功，SPA 的所有值从阈值文件都导入当前项目数据库。 与上一个不断变化的阈值方案类似，所有阈值的值更改才都会生效，在将来生成的报告。 不会影响现有报表。

### <a name="enable-or-disable-rules"></a>启用或禁用规则

可以启用或禁用从规则**规则详细信息**窗体。 您需要单击**保存**保存所做的更改。 如果规则为禁用状态，它并不是显示在任何类型的报告。 但基础业务逻辑触发时生成报告，因此当您选择重新启用的规则，它会显示在报表再次。

### <a name="reset-advisor-packs-to-original-state"></a>为原始状态重置的 advisor 包

您可能会决定修改数据库中的预配的顾问包。 不更改阈值，也可能会更改 SQL 脚本。 SPA 不支持更改报表元数据，或添加或删除预配的顾问包的规则。 手动修改的那些区域可能导致意外的行为。

有关更改预配的 advisor 包的详细信息，请参阅[服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

如果你想要预配的 advisor 包上回滚所做的更改，您可以选择重置 advisor 包。 这将覆盖所有与 advisor 包和默认阈值的所有值重都置的 SQL 脚本。 这会使所有的现有报表。

可以通过使用完成重置 advisor 包**配置 Advisor 包**窗体。 您需要选择 advisor 包以重置，然后单击**重置**。

### <a name="remove-advisor-packs"></a>删除 advisor 包

当不再需要 advisor 包时，用户可以从数据库中删除它。 删除 advisor 包 advisor 包有关的所有内容从数据库中删除，包括规则和阈值，所有 SQL 脚本，以及所有报表。 没有任何操作可回滚。

可以通过使用可删除 advisor 包**配置 Advisor 包**窗体。 您需要选择 advisor 包被移除，然后单击**取消预配**。

### <a name="update-existing-advisor-packs"></a>更新现有的 advisor 包

更新现有的 advisor 包是非常类似于正在 advisor 包重置为其原始状态。 若要更新到较新版本的 advisor 包，请将新的 advisor 包复制到顾问包文件夹。 仅当没有任何报表元数据更改时，advisor 包被视为对现有的顾问包的更新。 报表和规则 Id 必须是相同的。 否则，它们应视为两个不同的顾问包。

如果仅业务逻辑发生变化，advisor 包没有报告元数据更改，它应提供新的版本编号，例如从 1.0 到 2.0。 如果报表的元数据更改，advisor 包应提供不同的完整名称。 例如，Microsoft.ServerPerformanceAdvisor.IIS.V1 可能更改为 Microsoft.ServerPerformanceAdvisor.IIS.V2。

如果存在较新版本的 advisor 包中的列表**配置 Advisor 包**窗体将自动填充**版本**advisor 包的最新版本的列。 您可以选择顾问包，然后单击**重置**。 使用新的业务逻辑和阈值顾问包更新。 此顾问包的所有报表会都保留。

## <a name="managing-servers"></a>管理服务器


SPA 提供了管理目标服务器的基本功能。 您可以选择将新服务器添加到目标服务器列表中，从列表中，删除服务器或修改服务器的备注。

**若要添加或删除服务器或修改服务器信息**

1.  单击**配置**菜单上，单击**配置服务器**。

2.  在项目数据库中当前存在的服务器列表中，最后一行是空的。 单击对应的行，并填写字段。 **服务器名称**并**文件共享位置**文件夹字段是必需的并且服务器名称必须是唯一的。

3.  输入中的其他服务器信息**备注**列的每个服务器。

    **请注意**此字段使用的自定义文本格式，以便可以使用它作为说明字段。 或使用此字段标记服务器，以便它们可以轻松地在主窗口中，或找到到组服务器，例如，按位置或服务器角色。

     

4.  如果你想要使用大量的服务器使用 SPA，SPA 支持导入逗号分隔值 (.csv) 格式。 该文件必须包含至少两个字段：**服务器**并**的文件共享位置**。 第三个字段**备注**是可选的但建议来组织您的服务器。 此外可以将服务器列表导出到.csv 文件，以确定相应格式或备份您的服务器配置。

### <a name="searching-and-filtering"></a>搜索和筛选

如果您管理多个服务器，SPA 提供基本支持，能够快速在主窗口中找到的服务器。 可以单击列标题以进行排序基于服务器名称、 分析结果、 当前任务状态或备注。 您还可以选择使用搜索功能。 在主窗口的右上角，可以键入要搜索的字符串。 **目标服务器**主窗口列表中的筛选服务器并仅显示包含搜索字符串的名称或备注字段的服务器使用的字符串。

下图显示了如何将字符串**delL**匹配的字符串的服务器**delL**或与服务器**备注**包含字段**delL**.

![搜索和筛选示例](../media/server-performance-advisor/spa-user-manual-find-search-example.png)

## <a name="advanced-functionality"></a>高级的功能


### <a name="working-with-spa-windows-powershell-cmdlets"></a>使用 SPA Windows PowerShell cmdlet

SPA 控制台具有通过定期数据收集的 UI 支持。 如果该功能是不够的您的环境，有一些高级的管理员可以使用自定义数据收集的 Windows PowerShell cmdlet。 这些 Windows PowerShell cmdlet，系统管理员可以自动在目标服务器上运行性能分析和 SPA 用于远程客户支持。 例如，系统管理员可以编写脚本来在特定时间间隔来定期示例的目标服务器的性能条件内调用 SPA cmdlet。

我们建议关闭 SPAConsole.exe 应用程序，然后使用这些 cmdlet。

在运行任何 Windows PowerShell cmdlet 之前，你需要注册控制台计算机上的 cmdlet。

**若要注册的 Windows PowerShell cmdlet**

1.  在提升的 Windows PowerShell 命令提示符下键入**registerSpaCmdlets.cmd**。 **已成功注册 SPA cmdlet**将显示消息。

2.  运行**SPA PowerShell.cmd**。 如果将传递给 Windows PowerShell 脚本文件的路径，它会自动执行脚本。 否则，会打开 Windows PowerShell 命令提示符下，这是准备好运行 SPA Windows PowerShell cmdlet。

下表介绍 SPA Windows PowerShell cmdlet:

| Cmdlet 名称 | Parameters | 描述 |
| ------ | ------- | ------ |
| Start-SpaAnalysis | **-ServerName**目标服务器的名称。<br>**-AdvisorPackName** advisor 包在服务器上排队的完整名称。 如果计划同时运行多个包，参数的值的格式应为 AP1name，AP2name。<br>**的持续时间**数据收集持续时间。<br>**-Credential**目标服务器运行数据收集的帐户的用户凭据。<br>**-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。 | 指定的服务器上启动 SPA 数据收集会话。 |
| Stop-SpaAnalysis | **-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。<br>**-ServerName**目标服务器的名称。 | 尝试停止正在运行的 SPA 会话。 如果会话已完成，则返回不执行任何操作。 |
| Get-SpaServer | **-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。 | 获取数据库中的服务器列表。 它将返回的对象，包括这些属性的列表：名称、 状态、 文件共享，以及注释。 |
| Get-SpaAdvisorPacks | **-SqlInstanceName** SQL Server 实例的名称<br>**-SqlDatabaseName** SPA 项目数据库的名称 | 在数据库中获取顾问包列表。 它将返回的对象，包括这些属性的列表：名称、 DisplayName、 Author 和版本。 |

Windows PowerShell 提供凭据通过加密文件，以使自动化方案的功能。 有关使用加密的文件将凭据传递给某个 cmdlet 的详细信息，请参阅[创建该接受凭据的 Windows PowerShell 脚本](https://technet.microsoft.com/magazine/ff714574.aspx)。

### <a name="automating-spa-report-collection-by-using-windows-powershell"></a>使用 Windows PowerShell 实现自动化 SPA 报告集合

以下过程代表示例演示如何使用 SPA Windows PowerShell cmdlet 自动执行 SPA 报表集合。

可以加密并通过 Windows PowerShell 缓存用户凭据。 这些凭据用于登录到远程服务器上。 尽管不专门针对 SPA，下面的示例演示了这种方法：

``` syntax
$fileName = 'D:\temp\operator.txt'
$userName = 'domainname\operator'
 
# save credential to file
$(Get-Credential).Password | convertFrom-SecureString | Set-Content $fileName
 
# load credential from file
$credential = New-Object System.Management.Automation.PsCredential $userName, $(Get-Content $fileName | convertTo-SecureString)
 
# run command
.\start-SpaAnalysis  ServerName: Server1  Credential: $credential  AdvisorPackName:Microsoft.ServerPerformanceAdvisor.CoreOS.V1 10  Duration:10  SqlInstanceName: .\SQLExpress  SqlDatabaseName:SPA8294
```

您可以运行此文件之前，必须运行**的 set-executionpolicy remoteSigned**

您可以运行它从批处理文件使用以下命令：

``` syntax
PowerShell -command "& '.\RunSpa.ps1' "
```

### <a name="use-t-sql-to-generate-reports"></a>使用 T-SQL 来生成报告

可以通过使用 SQL 生成的自定义报表不提供 SPAConsole.exe 中提取 SPA 报表数据。

例如，下面的 T-SQL 命令提供服务器的 CPU 时间范围涵盖过去三天前 10 的列表：

``` syntax
select TOP 10
   MachineName,
   AverageCpu
FROM (
   select
      __MachineName MachineName,
      AVG(AverageValue) AverageCpu
   FROM [SPA].[Microsoft.ServerPerformanceAdvisor.CoreOS.V1].vwCpuPerformance
   WHERE __Creationtime > dateadd(DAY, -3, GETUTcdate())
      AND Name = N'% Processor time' AND CpuId = N'_Total'
   GROUP BY __MachineName
) t
OrdER BY t.AverageCpu DESC 
```

### <a name="working-with-multiple-projects"></a>使用多个项目

在某些情况下，你可能想要使用 SPA 的 SQL Server 数据库进行分区。 这可以帮助减少 SQL Server 数据库的数据大小或帮助您进行逻辑分区服务器。 在这些情况下，SPA 控制台支持多个项目。 可以通过单击创建新的项目数据库**文件**，然后单击**新项目**。 第一次显示了使用向导来帮助创建新项目数据库。

创建项目后，可以单击**文件**，然后单击**打开项目**项目之间进行切换。 SPA 控制台不允许未完成的性能分析运行中当前打开的项目时切换数据库。 这是为了保护的性能数据的完整性。

当您选择创建新的数据库项目或打开不同的项目数据库时，关闭当前项目。 当关闭当前项目时，将关闭所有打开的报表。

**请注意**SQL Server 2008 R2 Express 具有 10 GB 数据库限制。 通过使用多个项目，可以使用一个或多个 SQL Server 数据库，并使其保持在 10 GB 的 SQL Server 2008 R2 Express 限制。

 

### <a name="logging-and-debugging"></a>日志记录和调试

SPA 提供基本的日志记录功能。 它只允许日志写入到日志文件位于 SPAConsole.exe 所在的文件夹中。 运行 SPA 控制台的用户帐户需要 SPA 的安装位置，以确保日志可以写入日志文件的文件夹具有写入权限。

SPA 包含以下的有效的日志级别：

* **信息性**转储 SPA 控制台采用，并主要用于调试目的的每个操作的日志。

* **警告**记录所有失败和在 SPA 控制台内部发生的异常。 一些故障是只需 SPA 控制台可以处理的验证失败。

* **关键**只记录失败和 SPA 控制台不能处理的异常。 这些故障会导致崩溃的 SPA 控制台。 日志提供此类故障的上下文信息。

默认情况下，日志级别为警告，这意味着 SPA 仅记录失败和在 SPA 中发生的异常。 可以通过编辑更改日志级别**SpaConsole.exe.config** SpaConsole.exe 所在的同一文件夹中文件。 所有日志都写入相同的文件夹中的 log.txt 文件。

SPA 还提供了用于调试的一些基本功能。 若要打开调试为 SPA，用户需要手动修改 SPA 项目数据库。 设置存储在配置表中。 用户需要运行以下 SQL 脚本来更改 SPA 项目以调试模式：

``` syntax
UPdate [Configurations] SET Value = N'true' WHERE Name = N'Debugmode'.
```

在调试模式下，SPA 框架保留以便可以对 advisor 包中的问题进行故障排除性能分析过程中生成的所有临时数据。 此脚本主要用于由 advisor 包开发人员使用。

SPA 中的调试功能的详细信息，请参阅[服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

### <a name="managing-the-database"></a>管理数据库

### <a name="backup-and-restore-the-database"></a>备份和还原数据库

SPA 控制台不提供备份和还原 SPA 数据库的功能。 应使用标准的 Microsoft SQL Server 工具和脚本来备份和还原数据库。

### <a name="clean-up-the-database"></a>清理数据库

在运行更多性能分析，SPA 项目数据库可以增长的大小。 默认情况下，SPA 保留所有报表。 您可能想要删除旧的报告以帮助提高性能。 您可以删除通过报表**报表资源管理器**接口。

## <a name="privacy-and-security"></a>隐私和安全


SPA 仅支持从目标服务器的数据收集到 SPA 控制台。 它不是将任何信息发送给 Microsoft 或非 Microsoft 开发人员。 SPA 隐私的详细信息，请参阅有关服务器性能顾问的 Microsoft 软件许可条款。

收集的 SPA 的所有数据都存储在项目数据库。 由于 ETW 跟踪的一些特性，SPA 可能会收集可能具有高业务重要性的敏感信息。 您应注意的与共享到 SPA 项目数据库的访问权限相关的潜在风险。 临时日志文件保存在每台目标计算机指定的共享文件夹。 虽然 SPA 尝试删除这些临时日志文件数据导入完成后，就不能保证始终会删除这些日志文件。 应确保共享的文件夹位于安全位置。

SPA advisor 包包含 SQL 脚本来分析和分析性能日志，以生成性能报告。 SPA 尝试限制特权下运行这些脚本。 但是，就仍有可能这些脚本可以从目标服务器收集通过 SPA 的敏感信息或获取或修改存储在同一个 SPA 项目数据库中的敏感信息。 您需要请确保预配到 SPA 项目数据库的所有 advisor 包来自受信任源。

## <a name="errors-and-troubleshooting"></a>错误和疑难解答


### <a name="spaconsoleexe-does-not-start-or-write-log-file"></a>SPAConsole.exe 不启动或写入日志文件

当你尝试运行 SPAConsole.exe 第一次，如果未安装.NET Framework 时，该应用程序不要启动或写入日志文件。 确保安装 Framework compatible.NET 和工作正常之前启动 SPA。

### <a name="locating-log-information"></a>查找日志信息

SPA 存储 SPA 文件夹下的 log.txt 文件中的失败信息。 详细的错误消息和调用堆栈信息将写入到此文件夹中。 如果遇到需要解释的详细信息的故障，可以打开 log.txt 文件以查看错误详细信息。

### <a name="database-size-limitations-for-sql-server-express"></a>对于 SQL Server Express 数据库大小限制

SQL Server Express 有用户数据库的大小限制为 10 GB。 此大小的数据库具有容量来存储 20,000 30,000 报表。 若要减少此数据库限制的可能性，我们建议定期删除报表和/或使用另一个版本的 SQL Server 不具有 10 GB 用户数据库的限制。

### <a name="sql-server-express-log-size-and-disk-capacity"></a>SQL Server Express 日志大小和磁盘容量

如果使用 SQL Server Express 时，用户数据库被限制为 10 GB，但相应的日志文件可以超过 70 GB。 出于这些原因，我们建议 100 GB 或更多可用磁盘空间用于 SQL Server Express。 此磁盘空间应该足以存储大约 20,000 到 30,000 报表。 此日志文件命名为 SPADB\_log.ldf，并且它位于 **%Program Files %\\Microsoft SQL Server\\MSSQL10。SQLEXPRESS\\MSSQL\\数据**。

### <a name="failure-to-connect-to-target-server"></a>无法连接到目标服务器

在目标服务器上运行性能分析时，运行 SPA 控制台的用户帐户需要拥有对队列设置为 PLA 目标服务器上的数据收集器的某些权限。 此外需要更改，以允许 PLA 通信通过 Windows 防火墙设置。 有关详细的配置说明，请参阅[设置 SPA](#bkmk-setupspa)。

### <a name="failure-to-create-pla-data-collection-set-on-the-target-server"></a>在目标服务器上创建 PLA 数据收集组失败

如果您不能对目标服务器的消息创建 PLA 数据收集组，请务必执行以下操作：

* 请确保**性能日志和警报**服务是否正在运行

* 安全设置**网络访问：不允许存储的密码和凭据用于网络身份验证**被禁用。 必须禁用安全设置，因为 SPA 需要使用用户凭据在目标服务器上创建数据收集组。

### <a href="" id="running-spa-against-the-console-"></a>对控制台运行 SPA

如果目标服务器是 SPA 控制台相同 PLA 经历不同的通道。 即使用户帐户具有管理员权限运行 SPA 控制台，PLA 无法正常工作。 如果目标服务器上安装 SPA 控制台，用户将需要以管理员身份以确保可以在控制台上运行性能分析任务启动 SPA。

### <a name="running-multiple-consoles-at-the-same-time"></a>在同时运行多个控制台

SPA 不支持在同一时间运行在同一个 SPA 项目数据库的多个控制台。 SPA 还不提供锁定和同步机制，以避免这种情况发生。 如果在同一时间运行的两个 SPA 控制台，控制台将根据这些 SPA 控制台正在运行的时间序列的不一致行为。 若要防止此情况，所有排队的性能分析会话应从列表中删除之前由启动分析控制台进行处理。

SPA 可保护已成功生成 SPA 的每个报表的完整性。 同时，SPA 不保证的所有排队的分析任务都已完成。 如果你看到的不一致的状态更改为性能分析会话或声明系统的错误找不到生成的数据收集器集的性能日志，则可能由多个针对同一个运行 SPA 控制台实例SPA 项目数据库。

在同一个 SPA 数据库运行 SPA 控制台可能还影响运行 SPA Windows PowerShell cmdlet。 我们建议你关闭 SPA 控制台，然后再运行 SPA Windows PowerShell cmdlet。

### <a name="spaconsoleexe-recurring-collection-is-disrupted"></a>中断 SPAConsole.exe 重复集合

当运行 SPAConsole.exe 并使用重复的数据集合 （例如，每小时集合） 时，运行 SPAConsole.exe 的服务器不应在节能模式下，以便它可以挂起。 SPA 不会检查策略省电。 此挂起的活动可能会中断常规的定期数据收集。

### <a name="lost-etw-events"></a>丢失的 ETW 事件

若要在目标服务器上创建最小性能影响，PLA 旨在以低优先级运行，而它收集性能信息。 如果目标服务器正忙，PLA 可以删除某些数据收集任务要执行高优先级任务的目标服务器上运行。 应考虑设置其中的事件获取写入磁盘与工作负荷的 I/O 或速度更快的驱动器，例如 SSD 冲突的不是 t 的共享文件夹。 当事件被删除时，它们在报表视图中由于报告丢失的事件可能会影响生成的性能指标的可靠性。

注册表或 WMI 查询要跳过，也可能会导致某些权限问题。 但是，这是不大可能发生这种情况比 ETW 事件丢失。 因此，数据收集器集结果有时不包含请求的所有值。 您需要确保这种情况由顾问的所有包的 T-SQL 脚本。 如果数据不存在数据收集结果中，将被标记为报表中的任何数据。

因为 ETW 事件丢失是很常见的 PLA，生成的数据点基于 ETW 跟踪可能会不一致数据点生成的基于，例如，性能计数器。 例如，它可能会看到 IIS 的总 CPU 使用率的 80%（它是从性能计数器），并且，顶部 Url 只能使用 10%的所有 CPU 时间 （这是来自 ETW 跟踪的数据点）。 通常情况下，可以通过数据点的工具提示查看一个数据点的数据源。 您应注意的此类数据丢失的影响。

若要避免此类事件丢失，应该到目标服务器关闭结果文件夹。

如果数据收集器结果包含以外 ETW 跟踪丢失的数据不完整，并且 advisor 包开发人员已经可以支持 ETW 事件丢失通知，显示信息栏在单个报表之上以通知用户有关的信息可能不一致引起的数据丢失的报表。 可以在 log.txt 文件中找到详细的数据丢失信息。

## <a name="glossary"></a>术语表


下面是一些与 SPA 一起使用的术语：

* **Advisor 包**元数据和处理从目标服务器收集的性能日志的 T-SQL 脚本的集合。 Advisor 包然后从性能日志数据生成报表。 Advisor 包中的元数据定义要收集的目标服务器的性能度量值的数据。 元数据还定义规则、 阈值和报表格式的组。 大多数情况下，advisor 包写入专用于单个服务器角色，例如，Internet 信息服务 (IIS)。

* **SPA 控制台**SpaConsole.exe，这是 SPA 的核心部分。 SPA 不需要在要测试的目标服务器上运行。 SPA 控制台为 SPA，包含所有用户界面从运行分析和查看报表的项目进行设置。 根据设计，SPA 是一个两层应用程序。 SPA 控制台包含 UI 层和业务逻辑层的一部分。 SPA 控制台计划和处理性能分析请求。

* **SPA 框架**提供所有的用户界面、 性能日志处理、 配置、 错误处理和数据库 Api，并管理过程。

* **SPA 项目**advisor 包在目标服务器上生成的数据库，包含有关目标服务器、 advisor 包和性能分析的所有信息报告。 你可以比较，并查看同一 SPA 项目中的历史记录和趋势图表。 可以创建多个项目。 SPA 项目是独立的并且不没有在项目之间共享任何数据。

* **目标服务器**的物理计算机或运行 Windows Server，某些服务器角色，如 IIS 的虚拟机。

* **数据分析会话**特定目标服务器上的性能分析。 数据分析会话可以包含多个 advisor 包。 这些顾问包中的数据收集器集将合并到单个数据收集器集。 在同一时间段期间收集的单个数据分析会话的所有性能日志。 分析生成的 advisor 包相同的数据分析会话中运行的报表可以帮助用户了解总体性能状况并确定性能问题的根本原因。

* **有关 Windows 事件跟踪**在 Windows 中提供的高性能、 低开销、 可缩放跟踪系统。 它提供了分析和调试功能，可用于解决各种方案。 SPA 使用 ETW 事件作为数据源生成性能报表。 有关 ETW 的常规信息，请参阅[改善调试和性能优化使用 ETW](https://msdn.microsoft.com/magazine/cc163437.aspx)。

* **Windows Management Instrumentation (WMI)** 基础结构来管理数据和 Windows 中的操作。 您可以编写 WMI 脚本或应用程序自动执行管理任务在远程计算机上。 WMI 还提供了其他部分的操作系统和产品管理数据。 SPA 使用 WMI 类信息和数据点作为源生成的性能报表。

* **性能计数器**用于提供有关如何执行操作系统或应用程序、 服务或驱动程序的信息。 性能计数器数据可以帮助确定系统瓶颈以及微调系统和应用程序性能。 操作系统、 网络和设备提供应用程序可以使用为用户提供的系统的执行图形视图的计数器数据。 SPA 使用性能计数器信息和数据点作为源来生成性能报告。

* **性能日志和警报 (PLA)** 收集性能日志和跟踪并满足某些触发器时，会发出性能警报。 PLA 可以用于收集性能计数器、 事件跟踪 Windows (ETW)、 WMI 查询、 注册表项和配置文件。 PLA 还支持通过远程过程调用 (RPC) 的远程数据收集。 用户定义数据收集器集，其中包括有关要收集数据、 数据收集、 数据收集持续时间、 筛选器和保存结果文件的位置的频率的信息。 SPA 使用 PLA 从目标服务器中收集所有性能数据。

* **单一报表**生成的 SPA 报表基于单个目标服务器上的一个 advisor 包的一种数据分析会话。 它可以包含通知和各种数据部分。

* **通过并行报表**SPA 报告，用于比较两个相同 advisor 包的单个报表。 从不同的目标服务器或不同的性能分析运行相同的目标服务器上，可以生成两个报表。 通过并行报表创建比较两个报告，以帮助用户识别异常行为，或者在一个报表设置的功能。 通过并行报表包含通知和各种数据部分。 在每个部分中，这两个报告中的数据是列出的并排方案。

* **趋势图**SPA 用于调查性能问题的重复模式的报表。 从服务器或客户端计算机，可能每天或每周，许多重复的性能问题被由于计划的服务器负载发生变化的。 SPA 提供 24 小时趋势图表和 7 天的使用趋势图表，以识别这些问题。

    用户可以在某个时间，如是数字值在单个报告中，选择一个或多个数据序列**平均总 CPU 使用率**。 更具体地说，数字值是从生成在给定的时间实例上单个 AP 的一台服务器一个标量值。 SPA 这些值进行分组为 24 的组，一个用于在一天 （7 天报表中，一个用于每个日期是星期几的 7 个） 的每个小时。 SPA 计算平均值、 最小值、 最大值和标准偏差为每个组。

* **历史图表**SPA 报表用于显示数字以特定的更改的值在给定的服务器和顾问的单个报表包对随着时间的推移。 用户可以选择多个数据序列和历史图表以了解不同的数据序列之间的相关性一起显示。

* **数据序列**一段时间内从同一数据源中收集的数值数据。 相同的源代码就意味着这些数据必须来自同一个目标服务器，例如一台服务器上的 IIS 请求的平均队列长度。

* **规则**逻辑、 阈值和说明的组合。 它们表示潜在的性能问题。 每个顾问包包含多个规则。 每个规则由报表生成过程触发。 某个规则应用于单个报表中的数据的逻辑和阈值。 如果满足条件，将引发警告通知。 如果不是，通知设置为**确定**状态。 如果规则不适用，通知将设置为不适用 (**NA**) 状态。

* **通知**向用户显示一条规则的信息。 它包括规则的状态 (**确定**， **NA**，或**警告**)，则名称的规则，并建议解决性能问题。
