---
title: 部署双节点群集的文件服务器
ms.prod: windows-server-threshold
ms.manager: eldenc
ms.technology: failover-clustering
ms.topic: article
author: johnmarlin-msft
ms.date: 02/01/2019
description: 本文介绍如何创建双节点文件服务器群集
ms.openlocfilehash: fbfde60f60df64514a6a0f514cbabd005544af84
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59846408"
---
# <a name="deploying-a-two-node-clustered-file-server"></a>部署双节点群集的文件服务器

> 适用于：Windows Server 2019、Windows Server 2016

故障转移群集是一组独立的计算机，这些计算机相互协作以提高应用程序和服务的可用性。 多台群集服务器（称为节点）通过物理电缆和软件连接。 如果其中一个群集节点出现故障，另一个节点便会开始提供服务（此过程称为故障转移）。 用户体验服务中断最小的值。

本指南介绍了安装和配置有两个节点的常规用途文件服务器故障转移群集的步骤。 在本指南中创建配置，可以了解故障转移群集并熟悉界面在 Windows Server 2019 或 Windows Server 2016 故障转移群集管理管理单元中。

## <a name="overview-for-a-two-node-file-server-cluster"></a>双节点文件服务器群集概述

故障转移群集中的服务器可以函数中的各种角色，包括文件服务器、 HYPER-V 服务器或数据库服务器的角色，并可提供高可用性的其他服务和应用程序有多种。 本指南介绍如何配置双节点文件服务器群集。

故障转移群集通常包含的存储单元的物理连接到群集中的所有服务器，但在存储中的任何给定的卷只能访问由一台服务器一次。 下图显示了已连接到存储单元的双节点故障转移群集。

![双节点群集](media\Cluster-File-Server\Cluster-FS-Overview.png)

不向其他服务器，包括另一个群集中的服务器必须公开存储卷或逻辑单元号 (Lun) 公开给群集中的节点。 下图阐释了这一点。

![在存储 Lun](media\Cluster-File-Server\Cluster-FS-LUNs.png)

请注意，对于任何服务器的最大可用性，它必须遵循服务器管理的最佳实践 — 例如，认真管理服务器，并完全实现它们之前, 测试软件更改的物理环境，并仔细跟踪的软件更新和所有群集服务器上的配置更改。

以下方案描述了如何配置文件服务器故障转移群集。 正在共享的文件位于群集存储中，而群集的服务器可以充当文件服务器共享它们。

## <a name="shared-folders-in-a-failover-cluster"></a>故障转移群集中的共享文件夹

以下列表介绍了集成到故障转移群集的共享的文件夹配置功能：

- 显示仅限于群集共享文件夹仅 （任何混合与非群集共享文件夹）：当用户视图共享文件夹中通过指定群集的文件服务器的路径时，显示将包括只是特定的文件服务器角色的一部分的共享的文件夹。 它将排除非群集共享的文件夹和共享碰巧位于群集的节点上的单独的文件服务器角色的一部分。

- 基于访问的枚举：基于访问的枚举可用于隐藏用户视图中指定的文件夹。 而不是让用户看到文件夹但不是访问它的任何内容，您可以选择阻止它们根本看到文件夹。 用于非群集共享文件夹相同的方式，可以配置基于访问权限的枚举为群集的共享文件夹。

- 脱机访问：可以配置脱机访问 （缓存） 的群集共享文件夹用于非聚集的共享文件夹相同的方式。

- 群集的磁盘始终被认为是群集的一部分：无论您是使用故障转移群集界面、 Windows 资源管理器，或共享和存储管理管理单元中，Windows 将识别磁盘是否已指定为在群集存储中。 如果这种磁盘已在故障转移群集管理配置为群集的文件服务器的一部分，你可以然后使用前面提到的任何的接口在磁盘上创建共享。 如果这种磁盘尚未配置为群集的文件服务器的一部分，则会错误地不能对其创建一个共享。 相反，一个错误，指示，可以共享它之前，磁盘首先必须配置为群集的文件服务器的一部分。

- 网络文件系统服务的集成：Windows Server 中的文件服务器角色包括调用网络文件系统 (NFS) 服务的可选角色服务。 通过安装角色服务和共享的文件夹配置 nfs 服务，可以创建支持基于 UNIX 的客户端的群集的文件服务器。

## <a name="requirements-for-a-two-node-failover-cluster"></a>双节点故障转移群集要求

在 Windows Server 2016 或 Windows Server 2019 视为正式受支持的解决方案由 Microsoft 中的故障转移群集，该解决方案必须满足以下条件。

- 所有硬件和软件组件必须符合相应徽标的资格要求。 对于 Windows Server 2016 中，这是"适用于 Windows Server 2016 认证"徽标。 对于 Windows Server 2019，这是"适用于 Windows Server 2019 认证"徽标。 有关哪些硬件和软件系统都已获得认证的详细信息，请访问 Microsoft [Windows Server 目录](https://www.windowsservercatalog.com/default.aspx)站点。

- 在验证向导中，它是故障转移群集管理单元中的一部分，完全配置的解决方案 （服务器、 网络和存储） 必须通过所有测试。

以下将需要两个节点故障转移群集。

- **服务器：** 我们建议使用具有相同或相似组件的匹配计算机。  双节点故障转移群集的服务器必须运行相同版本的 Windows Server。 它们还应具有相同的软件更新 （修补程序）。

- **网络适配器和电缆：** 在故障转移群集解决方案中，其他组件一样网络硬件必须与 Windows Server 2016 或 Windows Server 2019 兼容。 如果使用 iSCSI，必须将网络适配器专用于网络通信或 iSCSI，而不是两者。 在连接群集节点的网络基础结构中，应避免出现单点故障。 有多种方式实现这一点。 可以通过多个连接群集节点不同的网络。 或者，还可以使用一个由以下项组成的网络来连接群集节点：成组网络适配器、冗余交换机、冗余路由器或消除了单一故障点的类似硬件。

   > [!NOTE]
   > 如果群集节点使用一个网络连接，网络将在验证配置向导中传递的冗余要求。  但是，报表将包含在网络不应具有单点故障的警告。

- **设备控制器或相应适配器进行存储：**
    - **串行连接 SCSI 或光纤通道：** 如果在所有群集服务器中使用串行连接 SCSI 或光纤通道，则存储堆栈的所有组件都应相同。 这是必需的多路径 I/O (MPIO) 软件和设备特定模块 (DSM) 软件组件是相同的。  建议连接到群集存储的大容量存储设备控制器—即主机总线适配器 (HBA)、HBA 驱动程序以及 HBA 固件都相同。 如果使用不同的 HBA，则应向存储供应商验证你是否采用了其支持或推荐的配置。
    - **iSCSI:** 如果使用的 iSCSI，每个群集的服务器必须具有一个或多个网络适配器或专用于 ISCSI 存储的主机总线适配器。 用于 iSCSI 的网络不能用于网络通信。 在所有群集服务器中，用于连接 iSCSI 存储目标的网络适配器都应相同，建议使用千兆或更高速度的以太网。  

- **存储：** 必须使用 Windows Server 2016 或 Windows Server 2019 认证的共享的存储。
  
    对于双节点故障转移群集，存储应包含至少两个单独的卷 (Lun)，如果使用的仲裁见证磁盘。 见证磁盘是用于指定用于保存群集配置数据库的副本的群集存储中的磁盘。 对于此双节点群集示例中，仲裁配置将节点和磁盘多数。 节点和磁盘多数意味着节点和见证磁盘，每个包含副本的群集配置，并且该群集具有仲裁，只要这些副本的多数 （三个两个） 可用。 另一个卷 (LUN) 将包含用户正在共享的文件。

    存储要求如下：

    - 若要使用故障转移群集中包含的本机磁盘支持，请使用基本磁盘（而非动态磁盘）。
    - 我们建议您设置使用 NTFS 分区的格式 （为见证磁盘分区必须采用 ntfs 格式）。
    - 对于磁盘分区形式，可使用主启动记录 (MBR) 或 GUID 分区表 (GPT)。
    - 存储必须正确响应特定 SCSI 命令，存储必须遵循标准调用 SCSI Primary commands-3 (spc-3)。 具体而言，存储必须支持永久保留 spc-3 标准中指定。 
    -  用于存储微型端口驱动程序必须使用 Microsoft Storport 存储驱动程序。

## <a name="deploying-storage-area-networks-with-failover-clusters"></a>使用故障转移群集部署存储区域网络

在部署时故障转移群集与存储区域网络 (SAN)，应遵循以下指导原则。

- **确认存储的证书：** 使用[Windows Server 目录](https://www.windowsservercatalog.com/default.aspx)站点，确认已针对 Windows Server 2016 或 Windows Server 2019 认证供应商的存储，包括驱动程序、 固件和软件。

- **隔离存储设备，使每个设备一个群集：** 来自不同群集的服务器不能访问同一存储设备。 在大多数情况下，用于一组群集服务器的 LUN 应与通过 LUN 屏蔽或分区的所有其他服务器隔离。

- **请考虑使用多路径 I/O 软件：** 在一个高度可用的存储结构中，您可以在通过使用多路径 I/O 软件带有多个主机总线适配器中部署故障转移群集。 这可以提供最高级别的冗余和可用性。 多路径解决方案必须基于 Microsoft 多路径 I/O (MPIO)。 存储硬件供应商可能提供您的硬件，MPIO 设备特定模块 (DSM)，尽管 Windows Server 2016 和 Windows Server 2019 包括一个或多个操作系统的一部分。

## <a name="network-infrastructure-and-domain-account-requirements"></a>网络基础结构和域帐户要求

双节点故障转移群集和拥有以下域权限的管理帐户将需要以下网络基础结构：

- **网络设置和 IP 地址：** 当针对某个网络使用相同的网络适配器时，还使用相同的通信设置 （例如，速度、 双工模式、 流控制和媒体类型） 的这些适配器上。 此外，还要比较网络适配器和它连接到的交换机之间的设置，并确保设置不冲突。

    如果你有还未路由到网络基础结构其余部分的专用网络，请确保每个专用网络都使用唯一的子网。 即使你为每个网络适配器提供了唯一的 IP 地址，此操作也是必需的。 例如，如果你在使用一个物理网络的中央办公室中有群集节点并在使用单独物理网络的分支机构中有另一个节点，不要为这两个网络指定 10.0.0.0/24，即使你为每个适配器提供了唯一的 IP 地址。

    有关网络适配器的详细信息，请参阅双节点故障转移群集，本指南前面部分中的硬件要求。

- **DNS:** 群集中的服务器必须使用域名系统 (DNS) 名称解析。 可以使用 DNS 动态更新协议。

- **域角色：** 在群集中的所有服务器必须都位于同一 Active Directory 域。 作为最佳做法，所有群集服务器都应具有相同的域角色（成员服务器或域控制器）。 推荐的角色为成员服务器。

- **域控制器：** 我们建议您的群集的服务器为成员服务器。 如果它们是的则需要其他服务器来充当包含故障转移群集的域中的域控制器。

- **客户端：** 根据测试需要可以连接到你所创建的故障转移群集的一个或多个联网的客户端和移动或故障转移到另一个群集节点从群集的文件服务器时观察客户端上的效果。

- **用于管理群集的帐户：** 当首次创建群集或者向其添加服务器时，您必须登录到具有该分类中的所有服务器具有管理员权利和权限的帐户的域。 该帐户不需要是域管理员帐户，但可以是域用户帐户，该帐户位于每个群集服务器的 Administrators 组中。 此外，如果帐户不是 Domain Admins 帐户，该帐户 （或该帐户的成员的组） 必须授予**创建计算机对象**并**读取所有属性**中的权限域组织单位 (OU)，将位于中。

## <a name="steps-for-installing-a-two-node-file-server-cluster"></a>安装双节点文件服务器群集的步骤

必须完成以下步骤来安装双节点文件服务器故障转移群集。

第 1 步：群集服务器连接到网络和存储

步骤 2：安装故障转移群集功能

步骤 3:验证群集配置

步骤 4：创建群集

如果已安装在群集节点，并想要配置的文件服务器故障转移群集，请参阅配置双节点文件服务器群集中，在本指南后面的步骤。

### <a name="step-1-connect-the-cluster-servers-to-the-networks-and-storage"></a>第 1 步：群集服务器连接到网络和存储

对于故障转移群集网络，避免出现单一故障点。 有多种方式实现这一点。 可以通过多个连接群集节点不同的网络。 或者，你可以连接群集节点和 1 个网络构造使用成组的网络适配器、 冗余交换机、 冗余路由器或类似硬件的单一故障点中删除 （如果使用 iSCSI 网络，则必须创建除了其他网络的此网络）。

对于双节点文件服务器群集，将服务器连接到群集存储时必须公开至少两个卷 (Lun)。 根据需要进行配置的全面测试，您可以公开其他卷。 不会公开到不在群集中的服务器群集的卷。

#### <a name="to-connect-the-cluster-servers-to-the-networks-and-storage"></a>若要将群集服务器连接到网络和存储

1. 查看有关的双节点故障转移群集硬件要求和双节点故障转移群集，本指南前面部分中的网络基础结构和域帐户要求中的网络的详细信息。

2. 连接和配置群集中的服务器将使用的网络。

3. 如果您的测试配置包括客户端或非群集域控制器，请确保这些计算机可以连接到群集服务器通过至少一个网络。

4. 按照制造商的有关将服务器物理连接到存储的说明进行操作。

5. 确保向你将群集的服务器公开（仅公开这些服务器）你要在群集中使用的磁盘 (LUN)。 可以使用任何以下接口来公开磁盘或 Lun:

    - 该接口由存储的制造商提供。

    - 如果使用的 iSCSI，相应的 iSCSI 接口。

6. 如果已购买控制格式或功能的磁盘的软件，按照供应商提供的有关如何使用 Windows Server 使用该软件。

7. 一个服务器上，你想要群集，请单击开始，单击管理工具，单击计算机管理，然后单击磁盘管理。 （如果出现用户帐户控制对话框中，确认它显示的操作是你想，然后单击继续。）在磁盘管理，确认群集磁盘可见。

8. 如果你想要有大于 2 TB 的存储卷，并且使用 Windows 接口来控制磁盘的格式，则将该磁盘转换为称为 GUID 分区表 (GPT) 的分区形式。 为此，请备份该磁盘上的任何数据，删除磁盘上的所有卷，然后，在磁盘管理中，右键单击磁盘 （而非分区），并单击转换为 GPT 磁盘。  对于小于 2 TB 的卷，你可以使用称为主启动记录 (MBR) 的分区形式，而不是使用 GPT。

9. 检查公开的任何卷或 LUN 的格式。 建议格式 NTFS （对于见证磁盘，你必须使用 NTFS）。

### <a name="step-2-install-the-file-server-role-and-failover-cluster-feature"></a>步骤 2：安装文件服务器角色和故障转移群集功能

在此步骤中，将安装文件服务器角色和故障转移群集功能。 这两个服务器必须运行 Windows Server 2016 或 Windows Server 2019。

#### <a name="using-server-manager"></a>使用服务器管理器

1. 打开**服务器管理器**并在**管理**下拉列表中，选择**添加角色和功能**。

   ![添加功能](media\Cluster-File-Server\Cluster-FS-Add-Feature.png)

2. 如果**在开始之前**窗口随即打开，选择**下一步**。

3. 有关**安装类型**，选择**基于角色或基于功能的安装**并**下一步**。

4. 请确保**从服务器池中选择服务器**是所选，突出显示的计算机的名称，并**下一步**。

5. 对于服务器角色，从列表中的角色，打开**文件服务**，选择**文件服务器**，并**下一步**。

   ![添加角色](media\Cluster-File-Server\Cluster-FS-Add-FS-Role-1.png)

6. 对于的功能，从列表中的功能，请选择**故障转移群集**。  系统弹出一个对话框将显示列出还安装了管理工具。  将所有所选选择**添加功能**并**下一步**。

   ![添加功能](media\Cluster-File-Server\Cluster-FS-Add-WSFC-1.png)

7. 在确认页中，选择安装。

8. 安装完成后，重新启动计算机。

9. 重复第二台计算机上的步骤。

#### <a name="using-powershell"></a>使用 PowerShell

1. 打开管理 PowerShell 会话，请右键单击开始按钮，然后选择**Windows PowerShell （管理员）**。
2. 若要安装文件服务器角色，运行命令：

    ```PowerShell
    Install-WindowsFeature -Name FS-FileServer
    ```

3. 若要安装故障转移群集功能和其管理工具，运行命令：

    ```PowerShell
    Install-WindowsFeature -Name Failover-Clustering -IncludeManagementTools
    ```

4. 一旦他们已完成，可以验证它们安装使用命令：

    ```PowerShell
    Get-WindowsFeature -Name FS-FileServer
    Get-WindowsFeature -Name Failover-Clustering
    ```

5. 验证在安装后，请重启计算机后的使用命令：

    ```PowerShell
    Restart-Computer
    ```

6. 重复第二个服务器上的步骤。

### <a name="step-3-validate-the-cluster-configuration"></a>步骤 3:验证群集配置

之前创建的群集，我们强烈建议您验证您的配置。 验证可帮助你确认的服务器、 网络和存储的配置均满足一组故障转移群集的特定要求。

#### <a name="using-failover-cluster-manager"></a>使用故障转移群集管理器

1. 从**服务器管理器**，选择**工具**下拉列表中，选择**故障转移群集管理器**。

2. 在中**故障转移群集管理器**，请转到下的中间列**管理**，然后选择**验证配置**。

3. 如果**在开始之前**窗口随即打开，选择**下一步**。

4. 在中**选择服务器或群集**窗口中，添加将在群集的节点在两台计算机的名称中。  例如，如果名称为 NODE1 和 NODE2，输入名称并选择**添加**。  你还可以选择**浏览**按钮以搜索 Active Directory 中的名称。  后两者列入**所选服务器**，选择**下一步**。

5. 在中**测试选项**窗口中，选择**运行所有测试 （推荐）**，并**下一步**。

6. 上**确认**页上，它将为您提供的列表中将检查的所有测试。  选择**下一步**，测试将开始。

7. 完成后，**摘要**运行测试后，会显示页。 若要查看可帮助你解释结果的帮助主题，请单击**更多关于群集验证测试**。

8. 虽然仍在摘要页，单击查看报表并阅读测试结果。 在配置中进行任何必要的更改并重新运行测试。 <br>若要关闭向导之后查看测试结果，请参阅*SystemRoot\Cluster\Reports\Validation Report date and time.html*。

9. 要后关闭该向导，在故障转移群集管理中，查看关于群集验证的帮助主题单击帮助，单击帮助主题、 单击内容选项卡，展开故障转移群集的帮助的内容并单击验证故障转移群集配置.

#### <a name="using-powershell"></a>使用 PowerShell

1. 打开管理 PowerShell 会话，请右键单击开始按钮，然后选择**Windows PowerShell （管理员）**。

2. 若要验证故障转移群集的计算机 （例如，正在 NODE1 和 NODE2 计算机名称），运行命令：

    ```PowerShell
    Test-Cluster -Node "NODE1","NODE2"
    ```
4. 若要关闭向导之后查看测试结果，请参阅指定的文件 (在 SystemRoot\Cluster\Reports\)，然后在配置中进行任何必要的更改并重新运行测试。

有关详细信息，请参阅[验证故障转移群集配置](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134244(v=ws.11))。

### <a name="step-4-create-the-cluster"></a>步骤 4：创建群集

以下代码会创建带机和配置中，必须群集。

#### <a name="using-failover-cluster-manager"></a>使用故障转移群集管理器

1. 从**服务器管理器**，选择**工具**下拉列表中，选择**故障转移群集管理器**。

2. 在中**故障转移群集管理器**，请转到下的中间列**管理**，然后选择**创建群集**。

3. 如果**在开始之前**窗口随即打开，选择**下一步**。

4. 在中**选择服务器**窗口中，添加将在群集的节点在两台计算机的名称中。  例如，如果名称为 NODE1 和 NODE2，输入名称并选择**添加**。  你还可以选择**浏览**按钮以搜索 Active Directory 中的名称。  后两者列入**所选服务器**，选择**下一步**。

5. 在中**用于管理群集的访问点**窗口中，输入要使用的群集的名称。  请注意，这不是你将用于连接到你的文件共享的名称。  这是用于只需管理群集。

   > [!NOTE]
   > 如果使用静态 IP 地址，你需要选择要使用并输入将用于群集名称的 IP 地址的网络。  如果要为你的 IP 地址使用 DHCP，IP 地址将为您自动配置。

6. 选择**下一步**。

7. 上**确认**页上，验证您已配置并选择**下一步**来创建群集。

8. 上**摘要**页上，它将为您提供已创建的配置。  您可以选择查看报表以查看创建的报表。

#### <a name="using-powershell"></a>使用 PowerShell

1. 打开管理 PowerShell 会话，请右键单击开始按钮，然后选择**Windows PowerShell （管理员）**。

2. 运行以下命令以创建群集，如果正在使用静态 IP 地址。  例如，，计算机名称为 NODE1 和 NODE2，群集的名称将为群集，并且 IP 地址将是 1.1.1.1。

   ```PowerShell
    New-Cluster -Name CLUSTER -Node "NODE1","NODE2" -StaticAddress 1.1.1.1
   ```

3. 运行以下命令以创建群集，如果你将 DHCP IP 地址。  例如，计算机名称为 NODE1 和 NODE2，并在群集的名称将是群集。

   ```PowerShell    
   New-Cluster -Name CLUSTER -Node "NODE1","NODE2"
   ```

### <a name="steps-for-configuring-a-file-server-failover-cluster"></a>配置文件服务器故障转移群集的步骤

若要配置的文件服务器故障转移群集，请执行以下步骤。

1. 从**服务器管理器**，选择**工具**下拉列表中，选择**故障转移群集管理器**。

2. 故障转移群集管理器打开后，它会自动显示你创建的群集的名称。  如果未显示，请转到下的中间列**管理**，然后选择**连接到群集**。  输入您创建的群集的名称和**确定**。

3. 在控制台树中，单击">"旁边创建以展开其下的项目的群集。

4. 右键单击**角色**，然后选择**配置角色**。

5. 如果**在开始之前**窗口随即打开，选择**下一步**。

6. 在角色的列表中，选择**文件服务器**并**下一步**。

7. 对于文件服务器类型，选择**常规用途文件服务器**并**下一步**。<br>有关横向扩展文件服务器的信息，请参阅[横向扩展文件服务器概述](sofs-overview.md)。

   ![文件服务器类型](media\Cluster-File-Server\Cluster-FS-File-Server-Type.png)

8. 在中**客户端访问点**窗口中，输入要使用的文件服务器的名称。  请注意，这不是群集的名称。  这是用于文件共享连接。  例如，如果我想要连接到\\服务器，则输入的名称将为服务器。

   > [!NOTE]
   > 如果使用静态 IP 地址，你需要选择要使用并输入将用于群集名称的 IP 地址的网络。  如果要为你的 IP 地址使用 DHCP，IP 地址将为您自动配置。

6. 选择**下一步**。

7. 在中**选择存储**窗口中，选择将保存您的共享资源的其他驱动器 （不见证服务器） 和**下一步**。

8. 上**确认**页上，验证你的配置，选择**下一步**。

9. 上**摘要**页上，它将为您提供已创建的配置。  您可以选择查看报表，若要查看的文件服务器角色创建报表。

10. 下**角色**在控制台树中，你将看到新创建列出为你创建的名称的 role。  它突出显示，在**操作**在右侧窗格中选择**添加共享**。

11. 通过输入以下共享向导运行：

    - 它将是的共享的类型
    - 位置/路径将为共享的文件夹
    - 共享用户的名称将连接到
    - 其他设置，例如基于访问的枚举缓存、 加密等
    - 如果将非默认，文件级别权限

12. 上**确认**页上，验证您已配置并选择**创建**创建文件服务器共享。

13. 上**结果**页上，选择关闭如果创建共享。  如果无法创建该共享，则它将为您所产生的错误。

14. 选择**关闭**。

15. 为任何其他共享重复此过程。